<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyHealth Portal - Zain Khan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-nav h1 {
            font-size: 1.6em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .datetime {
            font-size: 0.9em;
            opacity: 0.95;
        }

        /* Patient Banner */
        .patient-banner {
            background: white;
            border-bottom: 4px solid #1e3c72;
            padding: 25px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .patient-name {
            font-size: 2em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.5em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-btn:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .info-item {
            display: flex;
            gap: 8px;
            font-size: 0.95em;
            color: #555;
        }

        .info-item strong {
            color: #1e3c72;
            font-weight: 600;
        }

        .alert-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin-top: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .alert-banner h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .alert-badge {
            background: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #856404;
            border: 1px solid #ffc107;
            font-weight: 500;
        }

        /* Layout */
        .main-container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e0e0e0;
            min-height: calc(100vh - 200px);
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 8px 25px;
            font-size: 0.75em;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            color: #444;
            font-size: 0.95em;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #1e3c72;
        }

        .nav-item.active {
            background: #e8f2f8;
            color: #1e3c72;
            border-left-color: #1e3c72;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            font-size: 2em;
            color: #1a1a1a;
            font-weight: 700;
        }

        .action-bar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #152949;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-outline {
            background: white;
            color: #1e3c72;
            border: 2px solid #1e3c72;
        }

        .btn-outline:hover {
            background: #1e3c72;
            color: white;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        #alertCardsGrid {
            grid-template-columns: repeat(3, 1fr);
            max-width: 1200px;
            margin: 0 auto 30px;
        }

        @media (max-width: 900px) {
            #alertCardsGrid {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid #1e3c72;
            transition: all 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .summary-card.alert {
            border-left-color: #dc3545;
        }

        .summary-card.warning {
            border-left-color: #ffc107;
        }

        .summary-card.success {
            border-left-color: #28a745;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .summary-card.alert .summary-value {
            color: #dc3545;
        }

        .summary-card.warning .summary-value {
            color: #ffc107;
        }

        .summary-card.success .summary-value {
            color: #28a745;
        }

        .summary-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px 25px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 1.25em;
            font-weight: 700;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 25px;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            flex: 1;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #1e3c72;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        th {
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        th:last-child {
            border-right: none;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 14px 12px;
            vertical-align: middle;
        }

        td:first-child {
            font-weight: 600;
            color: #1a1a1a;
        }

        /* Result Badges */
        .result-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .badge-high {
            background: #fee;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .badge-low {
            background: #e3f2fd;
            color: #0066cc;
            border: 1px solid #0066cc;
        }

        .badge-abnormal {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .badge-normal {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .value-high {
            color: #dc3545;
            font-weight: 700;
        }

        .value-low {
            color: #0066cc;
            font-weight: 700;
        }

        /* Status Dropdown */
        .status-dropdown {
            padding: 6px 12px;
            border-radius: 6px;
            border: 2px solid #ddd;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            min-width: 130px;
        }

        .status-dropdown:hover {
            border-color: #1e3c72;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-dropdown:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .status-low {
            background: #ffebee;
            border-color: #dc3545;
            color: #dc3545;
        }

        .status-slightly-low {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .status-middle {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .status-slightly-high {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }

        .status-high {
            background: #fce4ec;
            border-color: #e91e63;
            color: #c2185b;
        }

        /* Chart Container */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-card h4 {
            font-size: 1.15em;
            margin-bottom: 20px;
            color: #1a1a1a;
            font-weight: 700;
        }

        /* View Management */
        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.1em;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        /* Result Groups */
        .result-section {
            margin-bottom: 30px;
        }

        .section-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 1.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                min-height: auto;
            }

            .nav-section {
                display: inline-block;
                margin-bottom: 0;
                margin-right: 15px;
            }

            .nav-item {
                display: inline-block;
                border-left: none;
                border-bottom: 4px solid transparent;
            }

            .nav-item.active {
                border-left: none;
                border-bottom-color: #1e3c72;
            }

            .content-area {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .top-nav h1 {
                font-size: 1.2em;
            }

            .patient-name {
                font-size: 1.5em;
            }

            .page-header h2 {
                font-size: 1.5em;
            }
        }

        /* Column Visibility Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e3c72;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            font-size: 0.95rem;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .hidden-column {
            display: none !important;
        }

        /* Icon Selector */
        .icon-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
        }

        .icon-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .icon-option.selected {
            border-color: #1e3c72;
            background: #1e3c72;
            color: white;
        }

        /* Test Selection List */
        .test-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .test-item:hover {
            background: #f8f9fa;
        }

        .test-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .test-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        /* Custom View Card */
        .custom-view-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .custom-view-card:hover {
            border-color: #1e3c72;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .custom-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .custom-view-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3c72;
        }

        .custom-view-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .custom-view-meta {
            color: #666;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        /* Mini Inline Charts */
        .mini-chart-cell {
            position: relative;
            min-width: 180px;
            padding: 8px !important;
        }

        .mini-chart-container {
            width: 100%;
            height: 60px;
            position: relative;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mini-chart-container:hover {
            background: #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mini-chart-svg {
            width: 100%;
            height: 50px;
        }

        .mini-chart-point {
            cursor: pointer;
            transition: r 0.2s;
        }

        .mini-chart-point:hover {
            r: 6 !important;
        }

        .mini-chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .mini-chart-label {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .chart-trend-up {
            color: #28a745;
        }

        .chart-trend-down {
            color: #dc3545;
        }

        .chart-trend-stable {
            color: #6c757d;
        }

        /* Slide-in Panel Styles */
        .test-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            backdrop-filter: blur(3px);
        }

        .test-detail-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .test-detail-panel {
            position: fixed;
            top: 0;
            right: -95%;
            width: 95%;
            height: 100%;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
        }

        .test-detail-panel.active {
            right: 0;
        }

        .test-detail-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
        }

        .test-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: white;
        }

        .panel-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1;
        }

        .panel-close-btn:hover {
            background: #e0e0e0;
            color: #333;
            transform: scale(1.1);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-category {
            margin-bottom: 10px;
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
            margin-bottom: 5px;
        }

        .category-header:hover {
            background: #e8f0fe;
            border-color: #1e3c72;
        }

        .category-header.active {
            background: #e8f0fe;
            border-color: #1e3c72;
            font-weight: 600;
        }

        .category-icon {
            font-size: 1rem;
            margin-right: 8px;
            color: #1e3c72;
            transition: transform 0.2s;
        }

        .category-icon.expanded {
            transform: rotate(90deg);
        }

        .category-name {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .test-count {
            font-size: 0.75rem;
            background: #1e3c72;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .test-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-left: 20px;
        }

        .test-list.expanded {
            max-height: 1000px;
        }

        .test-item-link {
            display: block;
            padding: 8px 12px;
            color: #555;
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin-bottom: 3px;
        }

        .test-item-link:hover {
            background: #e8f0fe;
            color: #1e3c72;
            padding-left: 16px;
        }

        .test-item-link.active {
            background: #1e3c72;
            color: white;
            font-weight: 500;
        }

        .chart-container-detail {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .chart-header-detail {
            margin-bottom: 20px;
        }

        .chart-title-detail {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .chart-subtitle-detail {
            font-size: 1.1rem;
            color: #666;
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .data-table-toggle {
            text-align: center;
            margin-top: 30px;
        }

        .data-table-btn {
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .data-table-btn:hover {
            background: #fff3f0;
        }

        .data-table-btn i {
            transition: transform 0.2s;
        }

        .data-table-btn i.rotated {
            transform: rotate(180deg);
        }

        .detail-data-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            display: none;
        }

        .detail-data-table.visible {
            display: table;
        }

        .detail-data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-data-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-data-table tr:hover {
            background: #f8f9fa;
        }

        #tableToggleIcon {
            transition: transform 0.3s ease;
        }

        #tableToggleIcon.rotated {
            transform: rotate(180deg);
        }

        /* Highlighted row when clicking a chart point */
        .highlight-row {
            background: rgba(255, 235, 59, 0.2); /* soft yellow */
            transition: background 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Body Explorer Styles */
        .body-explorer-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            margin-top: 20px;
        }

        @media (max-width: 1024px) {
            .body-explorer-container {
                grid-template-columns: 1fr;
            }
        }

        .body-svg-wrapper {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #body-svg {
            width: 100%;
            max-width: 300px;
            height: auto;
        }

        .body-part {
            fill: #a8d5ba;
            stroke: #2d5a3d;
            stroke-width: 1.5;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .body-part:hover {
            fill: #7bc89a;
            stroke: #1e3c72;
            stroke-width: 2.5;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .body-part.active {
            fill: #4a9d6b;
            stroke: #1e3c72;
            stroke-width: 3;
        }

        .organ-part {
            fill: #f4a4a4;
            stroke: #b85454;
            stroke-width: 1;
            opacity: 0.85;
        }

        .organ-part:hover {
            fill: #e87878;
            stroke: #8b3a3a;
            opacity: 1;
        }

        .organ-part.active {
            fill: #d45c5c;
            stroke: #8b3a3a;
            stroke-width: 2;
            opacity: 1;
        }

        .body-part-tooltip {
            position: absolute;
            background: rgba(30, 60, 114, 0.95);
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            white-space: nowrap;
        }

        .body-part-tooltip.visible {
            opacity: 1;
        }

        .body-info-panel {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .body-part-info {
            height: 100%;
        }

        .info-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 100%;
            min-height: 400px;
            color: #666;
        }

        .info-placeholder h3 {
            font-size: 1.5rem;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .info-placeholder p {
            font-size: 1rem;
            max-width: 300px;
        }

        .body-part-detail {
            animation: fadeIn 0.3s ease;
        }

        .body-part-detail h3 {
            font-size: 1.8rem;
            color: #1e3c72;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .body-part-detail h3 i {
            font-size: 1.4rem;
        }

        .body-part-detail .part-category {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .body-part-detail .part-description {
            font-size: 1.05rem;
            line-height: 1.7;
            color: #444;
            margin-bottom: 25px;
        }

        .body-part-detail .part-section {
            margin-bottom: 20px;
        }

        .body-part-detail .part-section h4 {
            font-size: 1.1rem;
            color: #1e3c72;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .body-part-detail .part-section ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .body-part-detail .part-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            color: #555;
            border-bottom: 1px solid #f0f0f0;
        }

        .body-part-detail .part-section li:last-child {
            border-bottom: none;
        }

        .body-part-detail .part-section li::before {
            content: "â€¢";
            position: absolute;
            left: 8px;
            color: #1e3c72;
            font-weight: bold;
        }

        .body-part-detail .related-tests {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 20px;
        }

        .body-part-detail .related-tests h4 {
            margin-bottom: 12px;
        }

        .body-part-detail .test-tag {
            display: inline-block;
            background: #1e3c72;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin: 4px;
            transition: background 0.2s;
        }

        .body-part-detail .test-tag:hover {
            background: #2a5298;
        }

        .body-legend {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .body-legend h4 {
            font-size: 1rem;
            color: #1e3c72;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-items {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Calendar View Styles */
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .calendar-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-nav button {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .calendar-month-year {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e3c72;
            min-width: 200px;
            text-align: center;
        }

        .view-mode-toggle {
            display: flex;
            gap: 5px;
            background: #f0f0f0;
            padding: 3px;
            border-radius: 6px;
        }

        .view-mode-toggle button {
            background: transparent;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .view-mode-toggle button.active {
            background: #1e3c72;
            color: white;
        }

        .calendar-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calendar-filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .calendar-filter-group label {
            font-size: 0.85em;
            color: #666;
            font-weight: 500;
        }

        .calendar-filter-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            background: white;
            cursor: pointer;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            color: #1e3c72;
            padding: 10px;
            font-size: 0.9em;
        }

        .calendar-day {
            aspect-ratio: 1;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .calendar-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #1e3c72;
        }

        .calendar-day.empty {
            background: #f8f9fa;
            border-color: transparent;
            cursor: default;
        }

        .calendar-day.empty:hover {
            transform: none;
            box-shadow: none;
            border-color: transparent;
        }

        .calendar-day.today {
            border-color: #1e3c72;
            border-width: 3px;
        }

        .calendar-day.selected {
            background: #e3f2fd;
            border-color: #2196f3;
            border-width: 3px;
        }

        .calendar-day-number {
            font-weight: 600;
            font-size: 0.95em;
            color: #333;
        }

        .calendar-day-status {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 5px;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.normal {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.high {
            background: #f8d7da;
            color: #721c24;
        }

        .status-badge.low {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.mixed {
            background: linear-gradient(135deg, #fff3cd 50%, #f8d7da 50%);
            color: #721c24;
        }

        .status-badge.not-run {
            background: #f0f0f0;
            color: #999;
        }

        .lab-count {
            font-size: 0.7em;
            color: #666;
            margin-top: 3px;
        }

        /* Weekly View */
        .calendar-weekly {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .week-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .week-day {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            min-height: 120px;
        }

        .week-day:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #1e3c72;
        }

        /* Side Panel */
        .lab-detail-panel {
            position: fixed;
            right: -500px;
            top: 0;
            width: 500px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .lab-detail-panel.open {
            right: 0;
        }

        .lab-panel-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .lab-panel-header h3 {
            margin: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lab-panel-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .lab-panel-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .lab-panel-content {
            padding: 20px;
        }

        .lab-panel-group {
            margin-bottom: 25px;
        }

        .lab-panel-group-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lab-marker {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 4px solid #1e3c72;
            cursor: pointer;
            transition: all 0.2s;
        }

        .lab-marker:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }

        .lab-marker-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .lab-marker-value {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .lab-marker-result {
            font-size: 1.1em;
            font-weight: 600;
            color: #1e3c72;
        }

        .lab-marker-flag {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .lab-marker-flag.high {
            background: #f8d7da;
            color: #721c24;
        }

        .lab-marker-flag.low {
            background: #fff3cd;
            color: #856404;
        }

        .lab-marker-flag.normal {
            background: #d4edda;
            color: #155724;
        }

        .lab-marker-range {
            font-size: 0.85em;
            color: #666;
        }

        .comparison-mode {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #856404;
        }

        .comparison-mode p {
            margin: 0;
            color: #856404;
            font-weight: 500;
        }

        .comparison-dates {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .comparison-date-tag {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comparison-date-tag button {
            background: none;
            border: none;
            color: #721c24;
            cursor: pointer;
            padding: 0;
            font-size: 1.1em;
        }

        .calendar-legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
        }

        .calendar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .calendar-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <h1><i class="fas fa-hospital"></i> MyHealth Portal</h1>
        <div class="datetime" id="currentDateTime"></div>
    </div>

    <!-- Patient Banner -->
    <div class="patient-banner">
        <div class="patient-name">
            <span id="patientName">Loading...</span>
            <button class="toggle-btn" onclick="togglePatientInfo()">
                <i class="fas fa-chevron-down" id="toggleIcon"></i>
                <span id="toggleText">Details</span>
            </button>
        </div>
        
        <div class="collapsible-content collapsed" id="patientInfo">
            <div class="patient-info-grid">
                <div class="info-item"><strong>DOB:</strong> <span id="patientDOB">Loading...</span></div>
                <div class="info-item"><strong>Age:</strong> <span id="patientAge">Loading...</span></div>
                <div class="info-item"><strong>Gender:</strong> <span id="patientGender">Loading...</span></div>
                <div class="info-item"><strong>MRN:</strong> <span>ZK-031994</span></div>
                <div class="info-item"><strong>Ethnicity:</strong> <span id="patientEthnicity">Loading...</span></div>
                <div class="info-item"><strong>Total Lab Tests:</strong> <span id="totalTests">Loading...</span></div>
            </div>
        </div>

        <div class="alert-banner" id="alertBanner" style="display:none;">
            <h4 style="cursor: pointer;" onclick="toggleAlerts()">
                <i class="fas fa-exclamation-triangle"></i> 
                Active Health Alerts 
                <i class="fas fa-chevron-down" id="alertToggleIcon" style="font-size: 0.8em; margin-left: 8px;"></i>
            </h4>
            <div class="alert-list" id="alertList"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="nav-section">
                <div class="nav-section-title">Health Records</div>
                <div class="nav-item active" onclick="showView('overview')">
                    <i class="fas fa-home"></i> Overview
                </div>
                <div class="nav-item" onclick="showView('trends-analysis')">
                    <i class="fas fa-chart-area"></i> Trends Analysis
                </div>
                <div class="nav-item" onclick="showView('calendar-labs')">
                    <i class="fas fa-calendar-alt"></i> Calendar View
                </div>
                <div class="nav-item" onclick="showView('all-results')">
                    <i class="fas fa-flask"></i> All Lab Results
                </div>
                <div class="nav-item" onclick="showView('trends')">
                    <i class="fas fa-chart-line"></i> Trends & Charts
                </div>
                <div class="nav-item" onclick="showView('flagged')">
                    <i class="fas fa-flag"></i> Flagged Tests
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">My Interpretations</div>
                <div class="nav-item" onclick="showView('my-high')">
                    <i class="fas fa-arrow-up"></i> My High Tests
                </div>
                <div class="nav-item" onclick="showView('my-low')">
                    <i class="fas fa-arrow-down"></i> My Low Tests
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Test Categories</div>
                <div class="nav-item" onclick="showView('metabolic')">
                    <i class="fas fa-heartbeat"></i> Metabolic Panel
                </div>
                <div class="nav-item" onclick="showView('lipid')">
                    <i class="fas fa-droplet"></i> Lipid Panel
                </div>
                <div class="nav-item" onclick="showView('thyroid')">
                    <i class="fas fa-user-md"></i> Thyroid Function
                </div>
                <div class="nav-item" onclick="showView('cbc')">
                    <i class="fas fa-syringe"></i> Complete Blood Count
                </div>
                <div class="nav-item" onclick="showView('kidney')">
                    <i class="fas fa-kidneys"></i> Kidney Function
                </div>
                <div class="nav-item" onclick="showView('liver')">
                    <i class="fas fa-liver"></i> Liver Function
                </div>
                <div class="nav-item" onclick="showView('vitamins')">
                    <i class="fas fa-pills"></i> Vitamins & Nutrients
                </div>
                <div class="nav-item" onclick="showView('inflammation')">
                    <i class="fas fa-fire"></i> Inflammation
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Zain's Research</div>
                <div class="nav-item" onclick="showView('research-fatigue')">
                    <i class="fas fa-battery-quarter"></i> Fatigue/Energy
                </div>
                <div class="nav-item" onclick="showView('research-mood')">
                    <i class="fas fa-cloud-sun"></i> Depression/Mood
                </div>
                <div class="nav-item" onclick="showView('research-anxiety')">
                    <i class="fas fa-heart-pulse"></i> Anxiety/Stress
                </div>
                <div class="nav-item" onclick="showView('research-muscle')">
                    <i class="fas fa-dumbbell"></i> Muscle Weakness
                </div>
                <div class="nav-item" onclick="showView('research-hairloss')">
                    <i class="fas fa-head-side-medical"></i> Hair Loss
                </div>
                <div class="nav-item" onclick="showView('research-heart')">
                    <i class="fas fa-heart"></i> Heart Health
                </div>
                <div class="nav-item" onclick="showView('research-cognitive')">
                    <i class="fas fa-brain"></i> Cognitive Function
                </div>
                <div class="nav-item" onclick="showView('research-bone')">
                    <i class="fas fa-bone"></i> Bone Health
                </div>
                <div class="nav-item" onclick="showView('research-inflammation')">
                    <i class="fas fa-fire-flame-curved"></i> Inflammation
                </div>
                <div class="nav-item" onclick="showView('research-sleep')">
                    <i class="fas fa-bed"></i> Sleep Issues
                </div>
                <div class="nav-item" onclick="showView('custom-views')" style="border-top: 2px solid #e0e0e0; margin-top: 10px; padding-top: 10px;">
                    <i class="fas fa-plus-circle"></i> My Custom Views
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Organ Systems</div>
                <div class="nav-item" onclick="showView('system-circulatory')">
                    <i class="fas fa-heart-pulse"></i> Circulatory
                </div>
                <div class="nav-item" onclick="showView('system-endocrine')">
                    <i class="fas fa-gland"></i> Endocrine
                </div>
                <div class="nav-item" onclick="showView('system-digestive')">
                    <i class="fas fa-stomach"></i> Digestive/Liver
                </div>
                <div class="nav-item" onclick="showView('system-urinary')">
                    <i class="fas fa-kidneys"></i> Urinary/Kidney
                </div>
                <div class="nav-item" onclick="showView('system-immune')">
                    <i class="fas fa-shield-virus"></i> Immune/Lymphatic
                </div>
                <div class="nav-item" onclick="showView('system-skeletal')">
                    <i class="fas fa-bone"></i> Skeletal
                </div>
                <div class="nav-item" onclick="showView('system-nervous')">
                    <i class="fas fa-brain"></i> Nervous
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Education</div>
                <div class="nav-item" onclick="showView('body-explorer')">
                    <i class="fas fa-person"></i> Body Explorer
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Additional</div>
                <div class="nav-item" onclick="showView('medications')">
                    <i class="fas fa-prescription-bottle"></i> Medications
                </div>
                <div class="nav-item" onclick="showView('diagnoses')">
                    <i class="fas fa-notes-medical"></i> Diagnoses
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Overview View -->
            <div id="view-overview" class="view-content active">
                <div class="page-header">
                    <h2><i class="fas fa-home"></i> Health Overview</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="fas fa-download"></i> Export All
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>

                <!-- Alert Cards (Always Visible) -->
                <div class="summary-grid" id="alertCardsGrid"></div>

                <!-- Stats Section (Collapsible) -->
                <div style="margin: 25px 0;">
                    <button class="toggle-btn" onclick="toggleStats()" style="width: 100%; justify-content: center; font-size: 1em;">
                        <i class="fas fa-chart-bar"></i>
                        <span id="statsToggleText">Show Statistics</span>
                        <i class="fas fa-chevron-down" id="statsToggleIcon"></i>
                    </button>
                </div>
                <div class="collapsible-content collapsed" id="statsSection">
                    <div class="summary-grid" id="statsGrid"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Recent Lab Results (Last 6 Months)</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="recentResultsTable">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Date</th>
                                        <th>Result</th>
                                        <th>Reference Range</th>
                                        <th>Status</th>
                                        <th>Lab</th>
                                    </tr>
                                </thead>
                                <tbody id="recentResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-circle"></i> Abnormal Results</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="abnormalResultsTable">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Date</th>
                                        <th>Result</th>
                                        <th>Reference Range</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="abnormalResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Analysis View -->
            <div id="view-trends-analysis" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-chart-area"></i> Trends Analysis</h2>
                    <p style="color: #666; margin-top: 8px;">Select a test from the sidebar to view detailed trends and historical data</p>
                </div>

                <div style="display: flex; gap: 0; height: calc(100vh - 200px); margin: 0 -30px;">
                    <!-- Left Sidebar - Test Categories -->
                    <div style="width: 300px; background: #f8f9fa; border-right: 2px solid #e0e0e0; overflow-y: auto; padding: 20px;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-flask"></i> Lab Tests
                        </div>
                        <div id="trendsAnalysisCategoriesList"></div>
                    </div>
                    
                    <!-- Right Content - Chart Display -->
                    <div style="flex: 1; overflow-y: auto; padding: 30px; background: white;">
                        <div id="trendsAnalysisChartContainer">
                            <div style="text-align: center; padding: 100px 20px; color: #999;">
                                <i class="fas fa-chart-line" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                                <h3 style="color: #666; font-weight: 400;">Select a test from the sidebar to view trends</h3>
                                <p style="margin-top: 10px;">Click on any test category to expand and choose a specific lab test</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="view-calendar-labs" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-calendar-alt"></i> Calendar View - Lab Results</h2>
                    <p style="color: #666; margin-top: 8px;">Track your lab results by date - see trends, correlate with symptoms, and compare results over time</p>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button onclick="calendarPreviousMonth()">
                                <i class="fas fa-chevron-left"></i> Prev
                            </button>
                            <div class="calendar-month-year" id="calendarMonthYear">
                                January 2024
                            </div>
                            <button onclick="calendarNextMonth()">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                            <button onclick="calendarToday()">
                                <i class="fas fa-calendar-day"></i> Today
                            </button>
                        </div>
                        <div class="calendar-controls">
                            <div class="view-mode-toggle">
                                <button id="monthViewBtn" class="active" onclick="switchCalendarView('month')">
                                    <i class="fas fa-calendar"></i> Month
                                </button>
                                <button id="weekViewBtn" onclick="switchCalendarView('week')">
                                    <i class="fas fa-calendar-week"></i> Week
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="calendar-filters">
                        <div class="calendar-filter-group">
                            <label>Filter by Panel</label>
                            <select id="calendarPanelFilter" onchange="refreshCalendar()">
                                <option value="">All Panels</option>
                                <option value="Comprehensive Metabolic Panel">CMP</option>
                                <option value="Complete Blood Count">CBC</option>
                                <option value="Lipid Panel">Lipid</option>
                                <option value="Thyroid Panel">Thyroid</option>
                            </select>
                        </div>
                        <div class="calendar-filter-group">
                            <label>Filter by Marker</label>
                            <select id="calendarMarkerFilter" onchange="refreshCalendar()">
                                <option value="">All Markers</option>
                            </select>
                        </div>
                        <div class="calendar-filter-group">
                            <label>Comparison Mode</label>
                            <select id="calendarCompareMode" onchange="toggleComparisonMode()">
                                <option value="">Off</option>
                                <option value="compare">Compare Dates</option>
                            </select>
                        </div>
                    </div>

                    <div id="comparisonModeInfo" class="comparison-mode" style="display: none;">
                        <p><i class="fas fa-info-circle"></i> Click two dates to compare lab results</p>
                        <div class="comparison-dates" id="comparisonDatesDisplay"></div>
                    </div>

                    <div id="calendarViewContainer">
                        <!-- Calendar grid will be rendered here -->
                    </div>

                    <div class="calendar-legend">
                        <div class="calendar-legend-item">
                            <span class="status-badge normal">Normal</span>
                            <span>All tests within range</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="status-badge high">High</span>
                            <span>One or more tests above range</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="status-badge low">Low</span>
                            <span>One or more tests below range</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="status-badge mixed">Mixed</span>
                            <span>Both high and low results</span>
                        </div>
                        <div class="calendar-legend-item">
                            <span class="status-badge not-run">Not Run</span>
                            <span>No tests on this date</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Lab Results View -->
            <div id="view-all-results" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-flask"></i> Complete Lab Results</h2>
                    <div class="action-bar">
                        <button class="btn btn-outline" onclick="openColumnVisibilityModal()" style="margin-right: 10px;">
                            <i class="fas fa-columns"></i> Columns
                        </button>
                        <button class="btn btn-primary" onclick="saveInterpretations()" style="margin-right: 10px;">
                            <i class="fas fa-save"></i> Save Interpretations
                        </button>
                        <button class="btn btn-success" onclick="exportFilteredData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Search Test Name</label>
                        <input type="text" id="searchInput" placeholder="Type to search..." onkeyup="filterAllResults()">
                    </div>
                    <div class="filter-group">
                        <label>Laboratory</label>
                        <select id="labFilter" onchange="filterAllResults()">
                            <option value="">All Labs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Result Status</label>
                        <select id="flagFilter" onchange="filterAllResults()">
                            <option value="">All Results</option>
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                            <option value="Abnormal">Abnormal</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date Range</label>
                        <select id="dateFilter" onchange="filterAllResults()">
                            <option value="">All Time</option>
                            <option value="90">Last 3 Months</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table id="allResultsTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> â‡…</th>
                                        <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name â‡…</th>
                                        <th onclick="sortTable('collected')" style="cursor: pointer;">Collected â‡…</th>
                                        <th onclick="sortTable('result')" style="cursor: pointer;">Result â‡…</th>
                                        <th><i class="fas fa-chart-line"></i> Trend</th>
                                        <th>Units</th>
                                        <th>Reference Range</th>
                                        <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint â‡…</th>
                                        <th>Flag</th>
                                        <th onclick="sortTable('status')" style="cursor: pointer;">Status â‡…</th>
                                        <th onclick="sortTable('lab')" style="cursor: pointer;">Lab â‡…</th>
                                        <th onclick="sortTable('panel')" style="cursor: pointer;">Panel â‡…</th>
                                        <th onclick="sortTable('category')" style="cursor: pointer;">Category â‡…</th>
                                        <th onclick="sortTable('physician')" style="cursor: pointer;">Physician â‡…</th>
                                        <th onclick="sortTable('reported')" style="cursor: pointer;">Reported â‡…</th>
                                        <th>Source</th>
                                        <th>Specimen ID</th>
                                        <th>Fasting</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="allResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends View -->
            <div id="view-trends" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-chart-line"></i> Health Trends & Analysis</h2>
                </div>
                <div class="chart-grid" id="chartsContainer"></div>
            </div>

            <!-- Flagged Tests View -->
            <div id="view-flagged" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-flag"></i> Flagged Tests</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportFlaggedTests()">
                            <i class="fas fa-download"></i> Export Flagged
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="flaggedTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- My High Tests View -->
            <div id="view-my-high" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-arrow-up"></i> My High Test Interpretations</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportMyInterpretations('high')">
                            <i class="fas fa-download"></i> Export High Tests
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="myHighTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- My Low Tests View -->
            <div id="view-my-low" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-arrow-down"></i> My Low Test Interpretations</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportMyInterpretations('low')">
                            <i class="fas fa-download"></i> Export Low Tests
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="myLowTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Category Views (will be populated dynamically) -->
            <div id="view-metabolic" class="view-content"></div>
            <div id="view-lipid" class="view-content"></div>
            <div id="view-thyroid" class="view-content"></div>
            <div id="view-cbc" class="view-content"></div>
            <div id="view-kidney" class="view-content"></div>
            <div id="view-liver" class="view-content"></div>
            <div id="view-vitamins" class="view-content"></div>
            <div id="view-inflammation" class="view-content"></div>

            <!-- Organ System Views (will be populated dynamically) -->
            <div id="view-system-circulatory" class="view-content"></div>
            <div id="view-system-endocrine" class="view-content"></div>
            <div id="view-system-digestive" class="view-content"></div>
            <div id="view-system-urinary" class="view-content"></div>
            <div id="view-system-immune" class="view-content"></div>
            <div id="view-system-skeletal" class="view-content"></div>
            <div id="view-system-nervous" class="view-content"></div>

            <!-- Research Template Views (will be populated dynamically) -->
            <div id="view-research-fatigue" class="view-content"></div>
            <div id="view-research-mood" class="view-content"></div>
            <div id="view-research-anxiety" class="view-content"></div>
            <div id="view-research-muscle" class="view-content"></div>
            <div id="view-research-hairloss" class="view-content"></div>
            <div id="view-research-heart" class="view-content"></div>
            <div id="view-research-cognitive" class="view-content"></div>
            <div id="view-research-bone" class="view-content"></div>
            <div id="view-research-inflammation" class="view-content"></div>
            <div id="view-research-sleep" class="view-content"></div>

            <!-- Custom Views Manager -->
            <div id="view-custom-views" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-plus-circle"></i> My Custom Research Views</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="createCustomView()">
                            <i class="fas fa-plus"></i> Create New View
                        </button>
                    </div>
                </div>
                <div id="customViewsList"></div>
            </div>

            <!-- Medications View -->
            <div id="view-medications" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-prescription-bottle"></i> Current Medications</h2>
                </div>
                <div id="medicationsContent"></div>
            </div>

            <!-- Diagnoses View -->
            <div id="view-diagnoses" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-notes-medical"></i> Active Diagnoses</h2>
                </div>
                <div id="diagnosesContent"></div>
            </div>

            <!-- Body Explorer View -->
            <div id="view-body-explorer" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-person"></i> Interactive Body Explorer</h2>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 1.1em;">Click on any body part to learn more about it. Explore the human body interactively!</p>
                
                <div class="body-explorer-container">
                    <div class="body-svg-wrapper">
                        <svg id="body-svg" viewBox="0 0 200 450" xmlns="http://www.w3.org/2000/svg">
                            <!-- Head -->
                            <ellipse id="body-head" class="body-part" cx="100" cy="35" rx="30" ry="35" data-part="head"/>
                            
                            <!-- Neck -->
                            <rect id="body-neck" class="body-part" x="90" y="68" width="20" height="20" rx="3" data-part="neck"/>
                            
                            <!-- Torso -->
                            <path id="body-chest" class="body-part" d="M60 88 L140 88 L145 180 L55 180 Z" data-part="chest"/>
                            
                            <!-- Abdomen -->
                            <path id="body-abdomen" class="body-part" d="M55 180 L145 180 L140 250 L60 250 Z" data-part="abdomen"/>
                            
                            <!-- Left Arm -->
                            <path id="body-left-arm" class="body-part" d="M55 88 L35 88 L20 180 L30 185 L45 110 L55 110 Z" data-part="left-arm"/>
                            <ellipse id="body-left-hand" class="body-part" cx="22" cy="195" rx="12" ry="18" data-part="left-hand"/>
                            
                            <!-- Right Arm -->
                            <path id="body-right-arm" class="body-part" d="M145 88 L165 88 L180 180 L170 185 L155 110 L145 110 Z" data-part="right-arm"/>
                            <ellipse id="body-right-hand" class="body-part" cx="178" cy="195" rx="12" ry="18" data-part="right-hand"/>
                            
                            <!-- Pelvis/Hips -->
                            <path id="body-pelvis" class="body-part" d="M60 250 L140 250 L145 280 L55 280 Z" data-part="pelvis"/>
                            
                            <!-- Left Leg -->
                            <path id="body-left-leg" class="body-part" d="M55 280 L95 280 L90 380 L55 380 Z" data-part="left-leg"/>
                            <path id="body-left-foot" class="body-part" d="M50 380 L90 380 L92 410 L45 410 L40 395 Z" data-part="left-foot"/>
                            
                            <!-- Right Leg -->
                            <path id="body-right-leg" class="body-part" d="M105 280 L145 280 L145 380 L110 380 Z" data-part="right-leg"/>
                            <path id="body-right-foot" class="body-part" d="M110 380 L150 380 L155 395 L158 410 L108 410 Z" data-part="right-foot"/>
                            
                            <!-- Internal Organs (shown as overlays) -->
                            <ellipse id="body-brain" class="body-part organ-part" cx="100" cy="30" rx="18" ry="15" data-part="brain"/>
                            <path id="body-heart" class="body-part organ-part" d="M90 120 C80 110 70 120 70 130 C70 145 90 155 100 165 C110 155 130 145 130 130 C130 120 120 110 110 120 C105 115 95 115 90 120 Z" data-part="heart"/>
                            <ellipse id="body-lungs-left" class="body-part organ-part" cx="75" cy="130" rx="15" ry="30" data-part="lungs"/>
                            <ellipse id="body-lungs-right" class="body-part organ-part" cx="125" cy="130" rx="15" ry="30" data-part="lungs"/>
                            <ellipse id="body-stomach" class="body-part organ-part" cx="90" cy="195" rx="20" ry="15" data-part="stomach"/>
                            <ellipse id="body-liver" class="body-part organ-part" cx="120" cy="190" rx="22" ry="18" data-part="liver"/>
                            <ellipse id="body-kidneys-left" class="body-part organ-part" cx="75" cy="215" rx="10" ry="15" data-part="kidneys"/>
                            <ellipse id="body-kidneys-right" class="body-part organ-part" cx="125" cy="215" rx="10" ry="15" data-part="kidneys"/>
                            <path id="body-intestines" class="body-part organ-part" d="M70 230 Q80 235 90 230 Q100 225 110 230 Q120 235 130 230 M70 240 Q80 245 90 240 Q100 235 110 240 Q120 245 130 240" data-part="intestines" fill="none" stroke-width="4"/>
                        </svg>
                        
                        <div class="body-part-tooltip" id="bodyPartTooltip"></div>
                    </div>
                    
                    <div class="body-info-panel">
                        <div id="bodyPartInfo" class="body-part-info">
                            <div class="info-placeholder">
                                <i class="fas fa-hand-pointer" style="font-size: 3rem; color: #1e3c72; margin-bottom: 15px;"></i>
                                <h3>Select a Body Part</h3>
                                <p>Click on any part of the body to learn about its function, associated organs, and related health information.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="body-legend">
                    <h4><i class="fas fa-info-circle"></i> Legend</h4>
                    <div class="legend-items">
                        <div class="legend-item">
                            <span class="legend-color" style="background: #a8d5ba;"></span>
                            <span>External Body Parts</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-color" style="background: #f4a4a4;"></span>
                            <span>Internal Organs</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="scripts/column_visibility.js"></script>
    <script>
        let healthData = null;
        let allLabResults = [];
        let filteredResults = [];

        // Update current date/time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Column visibility is provided by shared script `scripts/column_visibility.js`
        // Create aliases for variables used throughout the code
        let visibleColumns = window.columnVisibility ? window.columnVisibility.visibleColumns : {};
        const allColumns = window.columnVisibility ? window.columnVisibility.allColumns : [];

        function loadColumnVisibility() { if (window.columnVisibility && window.columnVisibility.loadColumnVisibility) window.columnVisibility.loadColumnVisibility(); }
        function saveColumnVisibility() { if (window.columnVisibility && window.columnVisibility.saveColumnVisibility) window.columnVisibility.saveColumnVisibility(); }
        function openColumnVisibilityModal() { if (window.columnVisibility && window.columnVisibility.openColumnVisibilityModal) window.columnVisibility.openColumnVisibilityModal(); }
        function closeColumnVisibilityModal() { if (window.columnVisibility && window.columnVisibility.closeColumnVisibilityModal) window.columnVisibility.closeColumnVisibilityModal(); }
        function closeColumnModalOnClickOutside(e) { if (e.target && e.target.id === 'columnModal') closeColumnVisibilityModal(); }
        function selectAllColumns() { if (window.columnVisibility && window.columnVisibility.selectAllColumns) window.columnVisibility.selectAllColumns(); }
        function deselectAllColumns() { if (window.columnVisibility && window.columnVisibility.deselectAllColumns) window.columnVisibility.deselectAllColumns(); }
        function applyColumnVisibility() { 
            if (window.columnVisibility && window.columnVisibility.applyColumnVisibility) {
                window.columnVisibility.applyColumnVisibility(function() {
                    const currentView = document.querySelector('.view-content.active');
                    if (currentView) {
                        const viewId = currentView.id.replace('view-', '');
                        if (viewId === 'all-results' && typeof populateAllResults === 'function') {
                            populateAllResults();
                        }
                    }
                });
            }
        }

        function applyColumnClasses() { if (window.columnVisibility && window.columnVisibility.applyColumnClasses) window.columnVisibility.applyColumnClasses(); }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('health_data_database.json');
                healthData = await response.json();
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading health data. Please make sure the server is running.');
            }
        }

        function initializeDashboard() {
            // Load saved custom statuses from localStorage
            const savedStatuses = localStorage.getItem('healthDashboardStatuses');
            if (savedStatuses) {
                try {
                    customStatuses = JSON.parse(savedStatuses);
                } catch (e) {
                    console.error('Error loading saved statuses:', e);
                    customStatuses = {};
                }
            }

            // Load saved bookmarks from localStorage
            loadBookmarks();

            // Load column visibility settings
            loadColumnVisibility();

            // Load custom views from localStorage
            loadCustomViews();

            // Update patient info
            document.getElementById('patientName').textContent = healthData.patient.name;
            document.getElementById('patientDOB').textContent = formatDate(healthData.patient.dob);
            document.getElementById('patientAge').textContent = `${healthData.patient.age} years`;
            document.getElementById('patientGender').textContent = healthData.patient.gender;
            document.getElementById('patientEthnicity').textContent = healthData.patient.ethnicity;

            // Compile all lab results
            compileAllResults();
            document.getElementById('totalTests').textContent = allLabResults.length;

            // Populate lab filter dropdown
            const labs = [...new Set(allLabResults.map(r => r.lab))];
            const labFilter = document.getElementById('labFilter');
            labs.forEach(lab => {
                const option = document.createElement('option');
                option.value = lab;
                option.textContent = lab;
                labFilter.appendChild(option);
            });

            // Show alerts
            showHealthAlerts();

            // Populate views
            populateSummaryCards();
            populateRecentResults();
            populateAbnormalResults();
            populateAllResults();
            populateCategoryViews();
            populateOrganSystemViews();
            populateResearchViews();
            populateCustomViewsList();
            populateMedications();
            populateDiagnoses();
            createCharts();
            
            // Apply column visibility after all tables are populated
            applyColumnClasses();
        }

        // Toggle functions
        function togglePatientInfo() {
            const content = document.getElementById('patientInfo');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            content.classList.toggle('collapsed');
            if (content.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'Details';
            } else {
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'Hide';
            }
        }

        function toggleAlerts() {
            const alertList = document.getElementById('alertList');
            const icon = document.getElementById('alertToggleIcon');
            
            if (alertList.style.display === 'none') {
                alertList.style.display = 'flex';
                icon.className = 'fas fa-chevron-down';
            } else {
                alertList.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }

        // Storage for custom statuses and bookmarks
        let customStatuses = {};
        let bookmarkedTests = {};
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Load bookmarked tests from localStorage
        function loadBookmarks() {
            const saved = localStorage.getItem('healthDashboardBookmarks');
            if (saved) {
                try {
                    bookmarkedTests = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading bookmarks:', e);
                    bookmarkedTests = {};
                }
            }
        }

        // Toggle bookmark for a test
        function toggleBookmark(resultId) {
            bookmarkedTests[resultId] = !bookmarkedTests[resultId];
            localStorage.setItem('healthDashboardBookmarks', JSON.stringify(bookmarkedTests));
            
            // Update display
            const result = allLabResults.find(r => r.id === resultId);
            if (result) {
                result.bookmarked = bookmarkedTests[resultId];
            }
            
            // Re-render current view
            const currentView = document.querySelector('.view-content:not([style*="display: none"])');
            if (currentView) {
                const viewId = currentView.id.replace('view-', '');
                if (viewId === 'all-results') {
                    populateAllResults();
                } else if (viewId === 'flagged') {
                    populateFlaggedTests();
                } else if (viewId === 'my-high') {
                    populateMyHighTests();
                } else if (viewId === 'my-low') {
                    populateMyLowTests();
                }
            }
        }

        function saveInterpretations() {
            // Save current status values as interpretations
            localStorage.setItem('healthDashboardStatuses', JSON.stringify(customStatuses));
            
            // Show confirmation with count
            const highCount = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('high'));
            }).length;
            
            const lowCount = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('low'));
            }).length;
            
            // Show a nice confirmation message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
            `;
            message.innerHTML = `
                <i class="fas fa-check-circle"></i> Interpretations Saved!<br>
                <small style="opacity: 0.9;">High: ${highCount} | Low: ${lowCount}</small>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function populateMyHighTests() {
            const myHighResults = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('high'));
            });
            
            const container = document.getElementById('myHighTableContainer');
            
            if (myHighResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-arrow-up" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; color: #dc3545;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No high test interpretations yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Go to "All Lab Results" and set tests to "High" or "Slightly High" status</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #dc3545;">
                    <i class="fas fa-arrow-up"></i> 
                    ${myHighResults.length} high test interpretation${myHighResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> â‡…</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name â‡…</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected â‡…</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result â‡…</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint â‡…</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status â‡…</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab â‡…</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel â‡…</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category â‡…</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician â‡…</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported â‡…</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="myHighResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('myHighResultsBody');
            renderResultsTable(myHighResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function populateMyLowTests() {
            const myLowResults = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('low'));
            });
            
            const container = document.getElementById('myLowTableContainer');
            
            if (myLowResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-arrow-down" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; color: #ffc107;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No low test interpretations yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Go to "All Lab Results" and set tests to "Low" or "Slightly Low" status</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #ffc107;">
                    <i class="fas fa-arrow-down"></i> 
                    ${myLowResults.length} low test interpretation${myLowResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> â‡…</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name â‡…</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected â‡…</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result â‡…</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint â‡…</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status â‡…</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab â‡…</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel â‡…</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category â‡…</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician â‡…</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported â‡…</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="myLowResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('myLowResultsBody');
            renderResultsTable(myLowResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function exportMyInterpretations(type) {
            const results = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                if (type === 'high') {
                    return status && (status.includes('high'));
                } else {
                    return status && (status.includes('low'));
                }
            });
            
            if (results.length === 0) {
                alert(`No ${type} test interpretations to export`);
                return;
            }

            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported', 
                           'Source', 'Specimen ID', 'Fasting', 'Notes'];
            
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported,
                r.source, r.specimenID, r.fasting, r.notes
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_${type}_tests_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function calculateMidpoint(low, high) {
            if (low && high && !isNaN(low) && !isNaN(high)) {
                return ((parseFloat(low) + parseFloat(high)) / 2).toFixed(2);
            }
            return 'N/A';
        }

        function determineStatus(value, low, high, midpoint) {
            if (!value || isNaN(value) || !low || !high || isNaN(low) || isNaN(high)) {
                return 'Middle';
            }
            
            const val = parseFloat(value);
            const lowVal = parseFloat(low);
            const highVal = parseFloat(high);
            const mid = parseFloat(midpoint);
            
            const lowerQuarter = lowVal + (mid - lowVal) / 2;
            const upperQuarter = mid + (highVal - mid) / 2;
            
            if (val < lowVal) return 'Low';
            if (val < lowerQuarter) return 'Slightly Low';
            if (val < upperQuarter) return 'Middle';
            if (val < highVal) return 'Slightly High';
            return 'High';
        }

        function compileAllResults() {
            allLabResults = [];
            
            Object.keys(healthData.lab_results).forEach(testName => {
                const results = healthData.lab_results[testName];
                results.forEach((result, index) => {
                    const midpoint = calculateMidpoint(result.range_low, result.range_high);
                    const resultId = `${testName}_${result.collected || result.date}_${index}`;
                    const autoStatus = determineStatus(result.result || result.value, result.range_low, result.range_high, midpoint);
                    
                    allLabResults.push({
                        id: resultId,
                        bookmarked: bookmarkedTests[resultId] || false,
                        testName: result.test_name ? formatTestName(result.test_name) : formatTestName(testName),
                        collected: result.collected || result.date,
                        result: result.result || result.value,
                        units: result.units || result.unit || 'N/A',
                        refLow: result.range_low,
                        refHigh: result.range_high,
                        midpoint: midpoint,
                        referenceRange: result.reference_range || formatRange(result.range_low, result.range_high),
                        flag: result.flag || '',
                        status: customStatuses[resultId] || autoStatus,
                        lab: result.lab || 'N/A',
                        panel: result.panel || determinePanel(testName),
                        category: result.test_category || determineCategory(testName),
                        physician: result.ordering_physician || 'N/A',
                        reported: result.reported || result.collected || result.date,
                        source: result.source_pdf || determineSource(result.collected || result.date, result.lab),
                        specimenID: result.specimen_id || 'N/A',
                        fasting: result.fasting || 'N/A',
                        notes: result.notes || result.note || '',
                        rawTestName: testName
                    });
                });
            });

            // Sort by date (most recent first)
            allLabResults.sort((a, b) => new Date(b.collected) - new Date(a.collected));
            filteredResults = [...allLabResults];
        }

        function formatTestName(name) {
            return name.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatRange(low, high) {
            if (low && high) return `${low} - ${high}`;
            if (low) return `> ${low}`;
            if (high) return `< ${high}`;
            return 'N/A';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function determinePanel(testName) {
            const panels = {
                glucose: 'Comprehensive Metabolic Panel',
                bun: 'Comprehensive Metabolic Panel',
                creatinine: 'Comprehensive Metabolic Panel',
                sodium: 'Comprehensive Metabolic Panel',
                potassium: 'Comprehensive Metabolic Panel',
                chloride: 'Comprehensive Metabolic Panel',
                cholesterol_total: 'Lipid Panel',
                hdl_cholesterol: 'Lipid Panel',
                ldl_cholesterol: 'Lipid Panel',
                triglycerides: 'Lipid Panel',
                tsh: 'Thyroid Panel',
                t4_free: 'Thyroid Panel',
                t3_free: 'Thyroid Panel',
                hemoglobin: 'Complete Blood Count',
                wbc: 'Complete Blood Count',
                platelets: 'Complete Blood Count'
            };
            return panels[testName] || 'N/A';
        }

        function determineCategory(testName) {
            const categories = {
                glucose: 'Metabolic',
                hemoglobin_a1c: 'Metabolic',
                bun: 'Renal',
                creatinine: 'Renal',
                egfr: 'Renal',
                cholesterol_total: 'Lipid',
                hdl_cholesterol: 'Lipid',
                ldl_cholesterol: 'Lipid',
                triglycerides: 'Lipid',
                tsh: 'Thyroid',
                t4_free: 'Thyroid',
                t3_free: 'Thyroid',
                alt: 'Hepatic',
                ast: 'Hepatic',
                alkaline_phosphatase: 'Hepatic',
                hemoglobin: 'Hematology',
                wbc: 'Hematology',
                platelets: 'Hematology',
                vitamin_d: 'Vitamins',
                vitamin_b12: 'Vitamins',
                crp: 'Inflammation',
                sed_rate: 'Inflammation'
            };
            return categories[testName] || 'General';
        }

        function determineSource(date, lab) {
            const year = new Date(date).getFullYear();
            if (lab && lab.includes('DLO')) return 'DLO Lab Work.pdf';
            if (lab && lab.includes('LabCorp')) {
                if (year === 2024) return 'Healow 2024 Data.txt';
                if (year === 2025) return 'Healow 2025 Data.txt';
            }
            return 'Medical Records';
        }

        function showHealthAlerts() {
            const alerts = [];
            
            // Check for abnormal results
            allLabResults.forEach(result => {
                if (result.flag && (result.flag.toLowerCase().includes('high') || result.flag.toLowerCase().includes('low'))) {
                    // Only show most recent abnormal for each test
                    if (!alerts.some(a => a.test === result.testName)) {
                        alerts.push({
                            test: result.testName,
                            value: result.result,
                            flag: result.flag,
                            date: result.collected
                        });
                    }
                }
            });

            // Add diagnosis alerts
            healthData.diagnoses.forEach(dx => {
                if (dx.status === 'Active') {
                    alerts.push({
                        test: dx.condition,
                        value: '',
                        flag: 'Active Diagnosis',
                        date: ''
                    });
                }
            });

            if (alerts.length > 0) {
                document.getElementById('alertBanner').style.display = 'block';
                const alertList = document.getElementById('alertList');
                alertList.innerHTML = alerts.slice(0, 8).map(alert => 
                    `<div class="alert-badge">${alert.test}${alert.value ? ': ' + alert.value : ''}</div>`
                ).join('');
            }
        }

        function populateSummaryCards() {
            const alertGrid = document.getElementById('alertCardsGrid');
            const statsGrid = document.getElementById('statsGrid');
            
            // Count results with either flag field OR status field indicating high/low
            const highResults = allLabResults.filter(r => {
                const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                const statusHigh = r.status && r.status.toLowerCase().includes('high');
                return flagHigh || statusHigh;
            }).length;
            
            const lowResults = allLabResults.filter(r => {
                const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                const statusLow = r.status && r.status.toLowerCase().includes('low');
                return flagLow || statusLow;
            }).length;
            
            const normalResults = allLabResults.filter(r => {
                const hasFlag = r.flag && r.flag !== '';
                const statusMiddle = r.status && r.status.toLowerCase() === 'middle';
                const statusNormal = !r.status || r.status === '';
                return (!hasFlag && statusNormal) || statusMiddle;
            }).length;
            
            const recentDate = new Date();
            recentDate.setMonth(recentDate.getMonth() - 6);
            const recentTests = allLabResults.filter(r => new Date(r.collected) >= recentDate).length;

            // Alert Cards (High, Low, Normal results - always visible)
            const alertCards = [
                { value: highResults, label: 'High Results', type: 'alert', action: 'filter-high' },
                { value: lowResults, label: 'Low Results', type: 'warning', action: 'filter-low' },
                { value: normalResults, label: 'Normal Results', type: 'success', action: 'filter-normal' }
            ];

            // Stats Cards (other metrics - collapsible)
            const statsCards = [
                { value: allLabResults.length, label: 'Total Lab Tests', type: '', action: 'all-results' },
                { value: recentTests, label: 'Tests (Last 6 Mo)', type: '', action: 'filter-recent' },
                { value: healthData.diagnoses.length, label: 'Active Diagnoses', type: '', action: 'diagnoses' },
                { value: healthData.medications.length, label: 'Current Medications', type: '', action: 'medications' },
                { value: new Set(allLabResults.map(r => r.lab)).size, label: 'Lab Facilities', type: '', action: 'all-results' }
            ];

            const cardHTML = (card) => `
                <div class="summary-card ${card.type}" onclick="handleCardClick('${card.action}')" style="cursor: pointer; transition: transform 0.2s;" 
                     onmouseover="this.style.transform='translateY(-3px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div class="summary-value">${card.value}</div>
                    <div class="summary-label">${card.label}</div>
                </div>
            `;

            alertGrid.innerHTML = alertCards.map(cardHTML).join('');
            statsGrid.innerHTML = statsCards.map(cardHTML).join('');
        }

        function toggleStats() {
            const statsSection = document.getElementById('statsSection');
            const icon = document.getElementById('statsToggleIcon');
            const text = document.getElementById('statsToggleText');
            
            statsSection.classList.toggle('collapsed');
            if (statsSection.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'Show Statistics';
            } else {
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'Hide Statistics';
            }
        }

        function handleCardClick(action) {
            switch(action) {
                case 'all-results':
                    showView('all-results');
                    break;
                case 'filter-high':
                    showView('all-results');
                    document.getElementById('flagFilter').value = 'high';
                    filterAllResults();
                    break;
                case 'filter-low':
                    showView('all-results');
                    document.getElementById('flagFilter').value = 'low';
                    filterAllResults();
                    break;
                case 'filter-normal':
                    showView('all-results');
                    document.getElementById('flagFilter').value = '';
                    // Filter for results with no flag
                    const tbody = document.getElementById('allResultsBody');
                    const normalResults = allLabResults.filter(r => !r.flag || r.flag === '');
                    renderResultsTable(normalResults, tbody);
                    // Re-apply column visibility after rendering
                    applyColumnClasses();
                    break;
                case 'filter-recent':
                    showView('all-results');
                    document.getElementById('dateFilter').value = '180';
                    filterAllResults();
                    break;
                case 'diagnoses':
                    showView('diagnoses');
                    break;
                case 'medications':
                    showView('medications');
                    break;
            }
        }

        function populateRecentResults() {
            const tbody = document.getElementById('recentResultsBody');
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const recent = allLabResults.filter(r => new Date(r.collected) >= sixMonthsAgo).slice(0, 20);
            
            tbody.innerHTML = recent.map(r => `
                <tr>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result} ${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                    <td>${r.lab}</td>
                </tr>
            `).join('');
        }

        function populateAbnormalResults() {
            const tbody = document.getElementById('abnormalResultsBody');
            const abnormal = allLabResults.filter(r => r.flag && r.flag !== '');
            
            tbody.innerHTML = abnormal.slice(0, 15).map(r => `
                <tr>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low'}">${r.result} ${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td><span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span></td>
                </tr>
            `).join('');
        }

        function changeStatus(resultId, newStatus) {
            customStatuses[resultId] = newStatus;
            // Save to localStorage for persistence
            localStorage.setItem('healthDashboardStatuses', JSON.stringify(customStatuses));
            
            // Update the display
            const result = allLabResults.find(r => r.id === resultId);
            if (result) {
                result.status = newStatus;
            }
            
            // Update summary cards to reflect new counts
            populateSummaryCards();
            
            // Re-render current view
            const currentView = document.querySelector('.view-content.active');
            if (currentView) {
                const viewId = currentView.id.replace('view-', '');
                if (viewId === 'all-results') {
                    populateAllResults();
                } else if (viewId === 'my-high') {
                    populateMyHighTests();
                } else if (viewId === 'my-low') {
                    populateMyLowTests();
                } else if (viewId === 'flagged') {
                    populateFlaggedTests();
                }
            }
        }

        function createMiniChart(testName) {
            // Get all results for this test
            const testResults = allLabResults.filter(r => r.testName === testName).sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            if (testResults.length < 2) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem;">Not enough data</div>';
            }

            // Extract numeric values and dates
            const values = testResults.map(r => {
                const val = parseFloat(r.result);
                return isNaN(val) ? null : val;
            }).filter(v => v !== null);

            if (values.length < 2) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem;">No numeric data</div>';
            }

            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            
            // Get reference range from first result
            const refLow = testResults[0].rangeLow;
            const refHigh = testResults[0].rangeHigh;
            
            const width = 160;
            const height = 50;
            const padding = 5;
            
            // Create SVG points
            const points = testResults.map((r, i) => {
                const val = parseFloat(r.result);
                if (isNaN(val)) return null;
                
                const x = padding + (i / (testResults.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((val - minVal) / range) * (height - 2 * padding);
                
                // Determine color based on reference range
                let color = '#1e3c72';
                if (refLow && refHigh) {
                    if (val < refLow) color = '#ffc107';
                    else if (val > refHigh) color = '#dc3545';
                    else color = '#28a745';
                }
                
                return { x, y, val, date: r.collected, color };
            }).filter(p => p !== null);

            // Create reference range zone
            let refZone = '';
            if (refLow && refHigh && minVal < refHigh && maxVal > refLow) {
                const yLow = height - padding - ((refLow - minVal) / range) * (height - 2 * padding);
                const yHigh = height - padding - ((refHigh - minVal) / range) * (height - 2 * padding);
                refZone = `<rect x="${padding}" y="${yHigh}" width="${width - 2 * padding}" height="${yLow - yHigh}" fill="#28a745" opacity="0.1"/>`;
            }

            // Create line path
            const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x},${p.y}`).join(' ');
            
            // Calculate trend
            const firstVal = values[0];
            const lastVal = values[values.length - 1];
            const trendPercent = ((lastVal - firstVal) / firstVal * 100).toFixed(1);
            const trendClass = lastVal > firstVal ? 'chart-trend-up' : lastVal < firstVal ? 'chart-trend-down' : 'chart-trend-stable';
            const trendIcon = lastVal > firstVal ? 'â†—' : lastVal < firstVal ? 'â†˜' : 'â†’';

            return `
                <div class="mini-chart-container" onclick="showTestDetail('${testName}')">
                    <svg class="mini-chart-svg" viewBox="0 0 ${width} ${height}">
                        ${refZone}
                        <path d="${pathData}" fill="none" stroke="#1e3c72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        ${points.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="4" fill="${p.color}" class="mini-chart-point" 
                                    onmouseover="showMiniTooltip(event, '${formatDate(p.date)}', '${p.val}')"
                                    onmouseout="hideMiniTooltip()"/>
                        `).join('')}
                    </svg>
                    <div class="mini-chart-label">
                        <span class="${trendClass}">${trendIcon} ${Math.abs(trendPercent)}%</span> | ${testResults.length} tests
                    </div>
                </div>
            `;
        }

        function showMiniTooltip(event, date, value) {
            let tooltip = document.getElementById('miniChartTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'miniChartTooltip';
                tooltip.className = 'mini-chart-tooltip';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `<strong>${date}</strong><br>${value}`;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 40) + 'px';
        }

        function hideMiniTooltip() {
            const tooltip = document.getElementById('miniChartTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function showTestDetail(testName) {
            // Open the detail panel for this test
            openTestDetailPanel(testName);
        }

        function renderResultsTable(results, tbody) {
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td style="text-align: center;">
                        <i class="fas fa-flag" 
                           onclick="toggleBookmark('${r.id}')" 
                           style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'}; font-size: 1.2em; transition: color 0.2s;"
                           onmouseover="this.style.opacity='0.7'"
                           onmouseout="this.style.opacity='1'"></i>
                    </td>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                    <td class="mini-chart-cell">${createMiniChart(r.testName)}</td>
                    <td>${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td><strong>${r.midpoint}</strong></td>
                    <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : ''}</td>
                    <td>
                        <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                onchange="changeStatus('${r.id}', this.value)">
                            <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                            <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                            <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                            <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                        </select>
                    </td>
                    <td>${r.lab}</td>
                    <td>${r.panel}</td>
                    <td>${r.category}</td>
                    <td>${r.physician}</td>
                    <td>${formatDate(r.reported)}</td>
                    <td>${r.source}</td>
                    <td>${r.specimenID}</td>
                    <td>${r.fasting}</td>
                    <td>${r.notes}</td>
                </tr>
            `).join('');
        }

        // Sort table function
        function sortTable(column) {
            // Toggle direction if same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            const sortedResults = [...allLabResults].sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'bookmark':
                        valA = a.bookmarked ? 1 : 0;
                        valB = b.bookmarked ? 1 : 0;
                        break;
                    case 'testName':
                        valA = a.testName.toLowerCase();
                        valB = b.testName.toLowerCase();
                        break;
                    case 'collected':
                    case 'reported':
                        valA = new Date(a[column]);
                        valB = new Date(b[column]);
                        break;
                    case 'result':
                    case 'midpoint':
                        valA = parseFloat(a[column]) || 0;
                        valB = parseFloat(b[column]) || 0;
                        break;
                    default:
                        valA = (a[column] || '').toString().toLowerCase();
                        valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(sortedResults, tbody);
            
            // Re-apply column visibility after sorting
            applyColumnClasses();
        }

        function populateAllResults() {
            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(allLabResults, tbody);
        }

        function populateFlaggedTests() {
            const flaggedResults = allLabResults.filter(r => r.bookmarked);
            const container = document.getElementById('flaggedTableContainer');
            
            if (flaggedResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-flag" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No tests flagged yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click the flag icon on any test to bookmark it</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #666;">
                    <i class="fas fa-flag" style="color: #ffc107;"></i> 
                    ${flaggedResults.length} flagged test${flaggedResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> â‡…</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name â‡…</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected â‡…</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result â‡…</th>
                                <th><i class="fas fa-chart-line"></i> Trend</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint â‡…</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status â‡…</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab â‡…</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel â‡…</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category â‡…</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician â‡…</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported â‡…</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="flaggedResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('flaggedResultsBody');
            renderResultsTable(flaggedResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function exportFlaggedTests() {
            const flaggedResults = allLabResults.filter(r => r.bookmarked);
            
            if (flaggedResults.length === 0) {
                alert('No flagged tests to export');
                return;
            }

            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported', 
                           'Source', 'Specimen ID', 'Fasting', 'Notes'];
            
            const rows = flaggedResults.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported,
                r.source, r.specimenID, r.fasting, r.notes
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flagged_lab_tests_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function filterAllResults() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const lab = document.getElementById('labFilter').value;
            const flag = document.getElementById('flagFilter').value;
            const dateRange = parseInt(document.getElementById('dateFilter').value) || 0;
            
            let filtered = [...allLabResults];
            
            if (search) {
                filtered = filtered.filter(r => r.testName.toLowerCase().includes(search));
            }
            
            if (lab) {
                filtered = filtered.filter(r => r.lab === lab);
            }
            
            if (flag) {
                // Check both the flag field (from lab reports) AND the status field (from custom status dropdown)
                filtered = filtered.filter(r => {
                    const flagMatch = r.flag && r.flag.toLowerCase().includes(flag.toLowerCase());
                    const statusMatch = r.status && r.status.toLowerCase().includes(flag.toLowerCase());
                    return flagMatch || statusMatch;
                });
            }
            
            if (dateRange > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateRange);
                filtered = filtered.filter(r => new Date(r.collected) >= cutoffDate);
            }
            
            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(filtered, tbody);
            
            // Re-apply column visibility after re-rendering
            applyColumnClasses();
        }

        function populateCategoryViews() {
            const categories = {
                metabolic: ['glucose', 'hemoglobin_a1c', 'sodium', 'potassium', 'chloride', 'carbon_dioxide', 'calcium'],
                lipid: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol'],
                thyroid: ['tsh', 't4_free', 't3_free', 't3_total'],
                cbc: ['hemoglobin', 'hematocrit', 'wbc', 'platelets', 'rbc'],
                kidney: ['creatinine', 'bun', 'egfr'],
                liver: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total'],
                vitamins: ['vitamin_d', 'vitamin_b12', 'folate', 'zinc', 'ferritin'],
                inflammation: ['crp', 'sed_rate']
            };

            Object.keys(categories).forEach(cat => {
                const view = document.getElementById(`view-${cat}`);
                const results = allLabResults.filter(r => 
                    categories[cat].includes(r.rawTestName)
                );

                view.innerHTML = `
                    <div class="page-header">
                        <h2>${cat.charAt(0).toUpperCase() + cat.slice(1)} Panel Results</h2>
                        <div class="action-bar">
                            <button class="btn btn-success" onclick="exportCategory('${cat}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Result</th>
                                            <th>Units</th>
                                            <th>Reference Range</th>
                                            <th>Midpoint</th>
                                            <th>Flag</th>
                                            <th>Status</th>
                                            <th>Lab</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map(r => `
                                            <tr>
                                                <td><strong>${r.testName}</strong></td>
                                                <td>${formatDate(r.collected)}</td>
                                                <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                                <td>${r.units}</td>
                                                <td>${r.referenceRange}</td>
                                                <td><strong>${r.midpoint}</strong></td>
                                                <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                                <td>
                                                    <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                                            onchange="changeStatus('${r.id}', this.value)">
                                                        <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                        <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                        <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                        <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                        <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                    </select>
                                                </td>
                                                <td>${r.lab}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function populateOrganSystemViews() {
            const organSystems = {
                circulatory: {
                    name: 'Circulatory System',
                    icon: 'heart-pulse',
                    description: 'Heart, blood vessels, and blood composition',
                    tests: ['hemoglobin', 'hematocrit', 'rbc', 'wbc', 'platelets', 'cholesterol_total', 'hdl_cholesterol', 
                            'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol', 'neutrophils', 'lymphocytes', 
                            'monocytes', 'eosinophils', 'basophils', 'mcv', 'mch', 'mchc', 'rdw']
                },
                endocrine: {
                    name: 'Endocrine System',
                    icon: 'gland',
                    description: 'Hormones and metabolic regulation',
                    tests: ['tsh', 't4_free', 't3_free', 't3_total', 'glucose', 'hemoglobin_a1c']
                },
                digestive: {
                    name: 'Digestive/Liver System',
                    icon: 'stomach',
                    description: 'Liver function and protein metabolism',
                    tests: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total', 'protein_total', 'albumin', 
                            'globulin', 'ag_ratio']
                },
                urinary: {
                    name: 'Urinary/Kidney System',
                    icon: 'kidneys',
                    description: 'Kidney function and electrolyte balance',
                    tests: ['creatinine', 'bun', 'egfr', 'bun_creatinine_ratio', 'sodium', 'potassium', 
                            'chloride', 'carbon_dioxide']
                },
                immune: {
                    name: 'Immune/Lymphatic System',
                    icon: 'shield-virus',
                    description: 'Immune function and infection response',
                    tests: ['wbc', 'lymphocytes', 'neutrophils', 'monocytes', 'eosinophils', 'basophils', 
                            'ebv_early_ag_ab', 'ebv_vca_igg', 'ebv_vca_igm', 'ebv_nuclear_igg', 'crp', 'sed_rate']
                },
                skeletal: {
                    name: 'Skeletal System',
                    icon: 'bone',
                    description: 'Bone health and calcium metabolism',
                    tests: ['calcium', 'vitamin_d', 'alkaline_phosphatase']
                },
                nervous: {
                    name: 'Nervous System',
                    icon: 'brain',
                    description: 'Neurological health and nerve function',
                    tests: ['vitamin_b12', 'folate', 'glucose', 'sodium', 'potassium', 'calcium']
                }
            };

            Object.keys(organSystems).forEach(systemKey => {
                const system = organSystems[systemKey];
                const view = document.getElementById(`view-system-${systemKey}`);
                const results = allLabResults.filter(r => 
                    system.tests.includes(r.rawTestName)
                );

                const highCount = results.filter(r => {
                    const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                    const statusHigh = r.status && r.status.toLowerCase().includes('high');
                    return flagHigh || statusHigh;
                }).length;

                const lowCount = results.filter(r => {
                    const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                    const statusLow = r.status && r.status.toLowerCase().includes('low');
                    return flagLow || statusLow;
                }).length;

                const normalCount = results.length - highCount - lowCount;

                view.innerHTML = `
                    <div class="page-header">
                        <h2><i class="fas fa-${system.icon}"></i> ${system.name}</h2>
                        <div class="action-bar">
                            <button class="btn btn-success" onclick="exportOrganSystem('${systemKey}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="card-body">
                            <p style="font-size: 0.95rem; margin-bottom: 15px; opacity: 0.95;">${system.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${results.length}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Tests</div>
                                </div>
                                <div style="background: rgba(220, 53, 69, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${highCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">High Results</div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${lowCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Low Results</div>
                                </div>
                                <div style="background: rgba(40, 167, 69, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${normalCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Normal Results</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-flag"></i></th>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Result</th>
                                            <th>Units</th>
                                            <th>Reference Range</th>
                                            <th>Midpoint</th>
                                            <th>Flag</th>
                                            <th>Status</th>
                                            <th>Lab</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                            <tr>
                                                <td style="text-align: center;">
                                                    <i class="fas fa-flag" 
                                                       onclick="toggleBookmark('${r.id}')" 
                                                       style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'}; font-size: 1.2em;"></i>
                                                </td>
                                                <td><strong>${r.testName}</strong></td>
                                                <td>${formatDate(r.collected)}</td>
                                                <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                                <td>${r.units}</td>
                                                <td>${r.referenceRange}</td>
                                                <td><strong>${r.midpoint}</strong></td>
                                                <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                                <td>
                                                    <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                                            onchange="changeStatus('${r.id}', this.value)">
                                                        <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                        <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                        <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                        <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                        <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                    </select>
                                                </td>
                                                <td>${r.lab}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function exportOrganSystem(systemKey) {
            const systemTests = {
                circulatory: ['hemoglobin', 'hematocrit', 'rbc', 'wbc', 'platelets', 'cholesterol_total', 'hdl_cholesterol', 
                            'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol', 'neutrophils', 'lymphocytes', 
                            'monocytes', 'eosinophils', 'basophils', 'mcv', 'mch', 'mchc', 'rdw'],
                endocrine: ['tsh', 't4_free', 't3_free', 't3_total', 'glucose', 'hemoglobin_a1c'],
                digestive: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total', 'protein_total', 'albumin', 'globulin', 'ag_ratio'],
                urinary: ['creatinine', 'bun', 'egfr', 'bun_creatinine_ratio', 'sodium', 'potassium', 'chloride', 'carbon_dioxide'],
                immune: ['wbc', 'lymphocytes', 'neutrophils', 'monocytes', 'eosinophils', 'basophils', 
                        'ebv_early_ag_ab', 'ebv_vca_igg', 'ebv_vca_igm', 'ebv_nuclear_igg', 'crp', 'sed_rate'],
                skeletal: ['calcium', 'vitamin_d', 'alkaline_phosphatase'],
                nervous: ['vitamin_b12', 'folate', 'glucose', 'sodium', 'potassium', 'calcium']
            };

            const results = allLabResults.filter(r => systemTests[systemKey].includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported'];
            
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${systemKey}_system_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Research Templates
        function populateResearchViews() {
            const researchTemplates = {
                fatigue: {
                    name: 'Fatigue/Energy Investigation',
                    icon: 'battery-quarter',
                    description: 'Tests related to fatigue, low energy, and tiredness',
                    tests: ['ferritin', 'iron', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 
                            'glucose', 'hemoglobin', 'hematocrit', 'magnesium'],
                    color: '#dc3545'
                },
                mood: {
                    name: 'Depression/Mood Investigation',
                    icon: 'cloud-sun',
                    description: 'Tests related to depression and mood disorders',
                    tests: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 't3_free', 
                            'magnesium', 'iron', 'ferritin'],
                    color: '#6c757d'
                },
                anxiety: {
                    name: 'Anxiety/Stress Investigation',
                    icon: 'heart-pulse',
                    description: 'Tests related to anxiety and stress levels',
                    tests: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'glucose', 
                            'calcium', 'potassium'],
                    color: '#ffc107'
                },
                muscle: {
                    name: 'Muscle Weakness Investigation',
                    icon: 'dumbbell',
                    description: 'Tests related to muscle weakness and fatigue',
                    tests: ['vitamin_d', 'calcium', 'magnesium', 'potassium', 'tsh', 't4_free', 
                            'creatinine', 'protein_total'],
                    color: '#fd7e14'
                },
                hairloss: {
                    name: 'Hair Loss Investigation',
                    icon: 'head-side-medical',
                    description: 'Tests related to hair loss and thinning',
                    tests: ['iron', 'ferritin', 'zinc', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 
                            't3_free', 'protein_total', 'albumin'],
                    color: '#20c997'
                },
                heart: {
                    name: 'Heart Health Investigation',
                    icon: 'heart',
                    description: 'Tests related to cardiovascular health',
                    tests: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 
                            'crp', 'glucose', 'hemoglobin_a1c', 'potassium', 'magnesium'],
                    color: '#e83e8c'
                },
                cognitive: {
                    name: 'Cognitive Function Investigation',
                    icon: 'brain',
                    description: 'Tests related to brain function and memory',
                    tests: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 'glucose', 
                            'hemoglobin', 'iron'],
                    color: '#6f42c1'
                },
                bone: {
                    name: 'Bone Health Investigation',
                    icon: 'bone',
                    description: 'Tests related to bone density and health',
                    tests: ['vitamin_d', 'calcium', 'alkaline_phosphatase', 'magnesium', 'protein_total'],
                    color: '#17a2b8'
                },
                inflammation: {
                    name: 'Inflammation Investigation',
                    icon: 'fire-flame-curved',
                    description: 'Tests related to inflammation in the body',
                    tests: ['crp', 'sed_rate', 'wbc', 'neutrophils', 'lymphocytes'],
                    color: '#dc3545'
                },
                sleep: {
                    name: 'Sleep Issues Investigation',
                    icon: 'bed',
                    description: 'Tests related to sleep quality and disorders',
                    tests: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'iron', 
                            'ferritin', 'glucose'],
                    color: '#6610f2'
                }
            };

            Object.keys(researchTemplates).forEach(key => {
                const template = researchTemplates[key];
                const view = document.getElementById(`view-research-${key}`);
                const results = allLabResults.filter(r => template.tests.includes(r.rawTestName));

                const highCount = results.filter(r => {
                    const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                    const statusHigh = r.status && r.status.toLowerCase().includes('high');
                    return flagHigh || statusHigh;
                }).length;

                const lowCount = results.filter(r => {
                    const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                    const statusLow = r.status && r.status.toLowerCase().includes('low');
                    return flagLow || statusLow;
                }).length;

                view.innerHTML = `
                    <div class="page-header">
                        <h2><i class="fas fa-${template.icon}"></i> ${template.name}</h2>
                        <div class="action-bar">
                            <button class="btn btn-outline" onclick="openColumnVisibilityModal()">
                                <i class="fas fa-columns"></i> Columns
                            </button>
                            <button class="btn btn-success" onclick="exportResearchTemplate('${key}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px; background: ${template.color}; color: white;">
                        <div class="card-body">
                            <p style="font-size: 1rem; margin-bottom: 15px; opacity: 0.95;">${template.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${results.length}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Tests Found</div>
                                </div>
                                <div style="background: rgba(220, 53, 69, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${highCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">High</div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${lowCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Low</div>
                                </div>
                                <div style="background: rgba(40, 167, 69, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${results.length - highCount - lowCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Normal</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            ${visibleColumns.bookmark !== false ? '<th><i class="fas fa-flag"></i></th>' : ''}
                                            ${visibleColumns.testName !== false ? '<th>Test Name</th>' : ''}
                                            ${visibleColumns.collected !== false ? '<th>Collected</th>' : ''}
                                            ${visibleColumns.result !== false ? '<th>Result</th>' : ''}
                                            ${visibleColumns.units !== false ? '<th>Units</th>' : ''}
                                            ${visibleColumns.referenceRange !== false ? '<th>Reference Range</th>' : ''}
                                            ${visibleColumns.midpoint !== false ? '<th>Midpoint</th>' : ''}
                                            ${visibleColumns.flag !== false ? '<th>Flag</th>' : ''}
                                            ${visibleColumns.status !== false ? '<th>Status</th>' : ''}
                                            ${visibleColumns.lab !== false ? '<th>Lab</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                            <tr>
                                                ${visibleColumns.bookmark !== false ? `<td style="text-align: center;"><i class="fas fa-flag" onclick="toggleBookmark('${r.id}')" style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'};"></i></td>` : ''}
                                                ${visibleColumns.testName !== false ? `<td><strong>${r.testName}</strong></td>` : ''}
                                                ${visibleColumns.collected !== false ? `<td>${formatDate(r.collected)}</td>` : ''}
                                                ${visibleColumns.result !== false ? `<td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>` : ''}
                                                ${visibleColumns.units !== false ? `<td>${r.units}</td>` : ''}
                                                ${visibleColumns.referenceRange !== false ? `<td>${r.referenceRange}</td>` : ''}
                                                ${visibleColumns.midpoint !== false ? `<td><strong>${r.midpoint}</strong></td>` : ''}
                                                ${visibleColumns.flag !== false ? `<td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>` : ''}
                                                ${visibleColumns.status !== false ? `<td><select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" onchange="changeStatus('${r.id}', this.value)">
                                                    <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                    <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                    <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                    <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                    <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                </select></td>` : ''}
                                                ${visibleColumns.lab !== false ? `<td>${r.lab}</td>` : ''}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function exportResearchTemplate(templateKey) {
            const templates = {
                fatigue: ['ferritin', 'iron', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'glucose', 'hemoglobin', 'hematocrit', 'magnesium'],
                mood: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'magnesium', 'iron', 'ferritin'],
                anxiety: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'glucose', 'calcium', 'potassium'],
                muscle: ['vitamin_d', 'calcium', 'magnesium', 'potassium', 'tsh', 't4_free', 'creatinine', 'protein_total'],
                hairloss: ['iron', 'ferritin', 'zinc', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'protein_total', 'albumin'],
                heart: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 'crp', 'glucose', 'hemoglobin_a1c', 'potassium', 'magnesium'],
                cognitive: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 'glucose', 'hemoglobin', 'iron'],
                bone: ['vitamin_d', 'calcium', 'alkaline_phosphatase', 'magnesium', 'protein_total'],
                inflammation: ['crp', 'sed_rate', 'wbc', 'neutrophils', 'lymphocytes'],
                sleep: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'iron', 'ferritin', 'glucose']
            };

            const results = allLabResults.filter(r => templates[templateKey].includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab'];
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${templateKey}_research_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Custom Views Management
        let customViews = [];
        let selectedIcon = 'microscope';
        let editingViewId = null;

        const availableIcons = [
            'microscope', 'heart', 'brain', 'lungs', 'bone', 'eye', 'hand-sparkles',
            'pills', 'syringe', 'stethoscope', 'dna', 'virus', 'bacteria',
            'flask', 'vial', 'notes-medical', 'file-medical', 'hospital'
        ];

        function loadCustomViews() {
            const saved = localStorage.getItem('healthDashboardCustomViews');
            if (saved) {
                try {
                    customViews = JSON.parse(saved);
                } catch (e) {
                    customViews = [];
                }
            }
        }

        function saveCustomViewsToStorage() {
            localStorage.setItem('healthDashboardCustomViews', JSON.stringify(customViews));
        }

        function createCustomView() {
            // Reset form
            document.getElementById('customViewName').value = '';
            document.getElementById('customViewDescription').value = '';
            selectedIcon = 'microscope';
            
            // Populate icon selector
            const iconContainer = document.getElementById('iconSelector');
            iconContainer.innerHTML = availableIcons.map(icon => `
                <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">
                    <i class="fas fa-${icon}"></i>
                </div>
            `).join('');
            
            // Populate tests list
            const uniqueTests = {};
            allLabResults.forEach(r => {
                if (!uniqueTests[r.rawTestName]) {
                    uniqueTests[r.rawTestName] = r.testName;
                }
            });
            
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = Object.entries(uniqueTests)
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([key, name]) => `
                    <div class="test-item">
                        <input type="checkbox" id="test-${key}" value="${key}">
                        <label for="test-${key}">${name}</label>
                    </div>
                `).join('');
            
            document.getElementById('customViewModal').classList.add('active');
        }

        function selectIcon(icon) {
            selectedIcon = icon;
            document.querySelectorAll('#iconSelector .icon-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.icon-option').classList.add('selected');
        }

        function selectIconEdit(icon) {
            selectedIcon = icon;
            document.querySelectorAll('#editIconSelector .icon-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.icon-option').classList.add('selected');
        }

        function closeCustomViewModal() {
            document.getElementById('customViewModal').classList.remove('active');
        }

        function closeCustomViewModalOnClickOutside(event) {
            if (event.target.id === 'customViewModal') {
                closeCustomViewModal();
            }
        }

        function selectAllTests() {
            document.querySelectorAll('#testsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllTests() {
            document.querySelectorAll('#testsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function filterTestsList() {
            const search = document.getElementById('testSearchInput').value.toLowerCase();
            document.querySelectorAll('#testsList .test-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }

        function saveCustomView() {
            const name = document.getElementById('customViewName').value.trim();
            const description = document.getElementById('customViewDescription').value.trim();
            
            if (!name) {
                alert('Please enter a view name');
                return;
            }
            
            const selectedTests = [];
            document.querySelectorAll('#testsList input[type="checkbox"]:checked').forEach(cb => {
                selectedTests.push(cb.value);
            });
            
            if (selectedTests.length === 0) {
                alert('Please select at least one test');
                return;
            }
            
            const newView = {
                id: Date.now(),
                name: name,
                description: description || '',
                icon: selectedIcon,
                tests: selectedTests,
                created: new Date().toISOString()
            };
            
            customViews.push(newView);
            saveCustomViewsToStorage();
            closeCustomViewModal();
            populateCustomViewsList();
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-check-circle"></i> Custom view "${name}" created!`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function populateCustomViewsList() {
            const container = document.getElementById('customViewsList');
            
            if (customViews.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1.2rem; margin: 0;">No custom views yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click "Create New View" to get started</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = customViews.map(view => `
                <div class="custom-view-card">
                    <div class="custom-view-header">
                        <div class="custom-view-title">
                            <i class="fas fa-${view.icon}" style="color: #1e3c72;"></i>
                            <span>${view.name}</span>
                        </div>
                        <div class="custom-view-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewCustomView(${view.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editCustomView(${view.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deleteCustomView(${view.id})" style="color: #dc3545; border-color: #dc3545;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    ${view.description ? `<p style="color: #666; margin: 8px 0;">${view.description}</p>` : ''}
                    <div class="custom-view-meta">
                        <i class="fas fa-flask"></i> ${view.tests.length} tests â€¢ 
                        <i class="fas fa-calendar"></i> Created ${new Date(view.created).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function viewCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            // Create dynamic view
            showView(`custom-${viewId}`);
            renderCustomView(view);
        }

        function renderCustomView(view) {
            let viewElement = document.getElementById(`view-custom-${view.id}`);
            if (!viewElement) {
                // Create the view element dynamically
                viewElement = document.createElement('div');
                viewElement.id = `view-custom-${view.id}`;
                viewElement.className = 'view-content';
                document.querySelector('.content-area').appendChild(viewElement);
            }
            
            const results = allLabResults.filter(r => view.tests.includes(r.rawTestName));
            
            const highCount = results.filter(r => {
                const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                const statusHigh = r.status && r.status.toLowerCase().includes('high');
                return flagHigh || statusHigh;
            }).length;

            const lowCount = results.filter(r => {
                const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                const statusLow = r.status && r.status.toLowerCase().includes('low');
                return flagLow || statusLow;
            }).length;

            viewElement.innerHTML = `
                <div class="page-header">
                    <h2><i class="fas fa-${view.icon}"></i> ${view.name}</h2>
                    <div class="action-bar">
                        <button class="btn btn-outline" onclick="openColumnVisibilityModal()">
                            <i class="fas fa-columns"></i> Columns
                        </button>
                        <button class="btn btn-outline" onclick="editCustomView(${view.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-success" onclick="exportCustomView(${view.id})">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                ${view.description ? `<div class="card" style="margin-bottom: 20px; background: #6c757d; color: white;">
                    <div class="card-body">
                        <p style="margin: 0; font-size: 1rem;">${view.description}</p>
                    </div>
                </div>` : ''}

                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #1e3c72;">${results.length}</div>
                                <div style="font-size: 0.85rem; color: #666;">Tests</div>
                            </div>
                            <div style="background: #f8d7da; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #dc3545;">${highCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">High</div>
                            </div>
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #ffc107;">${lowCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">Low</div>
                            </div>
                            <div style="background: #d4edda; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${results.length - highCount - lowCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">Normal</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-flag"></i></th>
                                        <th>Test Name</th>
                                        <th>Collected</th>
                                        <th>Result</th>
                                        <th>Units</th>
                                        <th>Reference Range</th>
                                        <th>Midpoint</th>
                                        <th>Flag</th>
                                        <th>Status</th>
                                        <th>Lab</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                        <tr>
                                            <td style="text-align: center;"><i class="fas fa-flag" onclick="toggleBookmark('${r.id}')" style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'};"></i></td>
                                            <td><strong>${r.testName}</strong></td>
                                            <td>${formatDate(r.collected)}</td>
                                            <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                            <td>${r.units}</td>
                                            <td>${r.referenceRange}</td>
                                            <td><strong>${r.midpoint}</strong></td>
                                            <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                            <td><select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" onchange="changeStatus('${r.id}', this.value)">
                                                <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                            </select></td>
                                            <td>${r.lab}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function editCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            editingViewId = viewId;
            selectedIcon = view.icon;
            
            document.getElementById('editViewName').value = view.name;
            document.getElementById('editViewDescription').value = view.description;
            
            // Populate icon selector
            const iconContainer = document.getElementById('editIconSelector');
            iconContainer.innerHTML = availableIcons.map(icon => `
                <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIconEdit('${icon}')">
                    <i class="fas fa-${icon}"></i>
                </div>
            `).join('');
            
            // Populate tests list
            const uniqueTests = {};
            allLabResults.forEach(r => {
                if (!uniqueTests[r.rawTestName]) {
                    uniqueTests[r.rawTestName] = r.testName;
                }
            });
            
            const testsList = document.getElementById('editTestsList');
            testsList.innerHTML = Object.entries(uniqueTests)
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([key, name]) => `
                    <div class="test-item">
                        <input type="checkbox" id="edit-test-${key}" value="${key}" ${view.tests.includes(key) ? 'checked' : ''}>
                        <label for="edit-test-${key}">${name}</label>
                    </div>
                `).join('');
            
            document.getElementById('editCustomViewModal').classList.add('active');
        }

        function closeEditCustomViewModal() {
            document.getElementById('editCustomViewModal').classList.remove('active');
            editingViewId = null;
        }

        function closeEditCustomViewModalOnClickOutside(event) {
            if (event.target.id === 'editCustomViewModal') {
                closeEditCustomViewModal();
            }
        }

        function selectAllTestsEdit() {
            document.querySelectorAll('#editTestsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllTestsEdit() {
            document.querySelectorAll('#editTestsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function filterEditTestsList() {
            const search = document.getElementById('editTestSearchInput').value.toLowerCase();
            document.querySelectorAll('#editTestsList .test-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }

        function updateCustomView() {
            const name = document.getElementById('editViewName').value.trim();
            const description = document.getElementById('editViewDescription').value.trim();
            
            if (!name) {
                alert('Please enter a view name');
                return;
            }
            
            const selectedTests = [];
            document.querySelectorAll('#editTestsList input[type="checkbox"]:checked').forEach(cb => {
                selectedTests.push(cb.value);
            });
            
            if (selectedTests.length === 0) {
                alert('Please select at least one test');
                return;
            }
            
            const viewIndex = customViews.findIndex(v => v.id === editingViewId);
            if (viewIndex === -1) return;
            
            customViews[viewIndex] = {
                ...customViews[viewIndex],
                name: name,
                description: description,
                icon: selectedIcon,
                tests: selectedTests
            };
            
            saveCustomViewsToStorage();
            closeEditCustomViewModal();
            populateCustomViewsList();
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-check-circle"></i> View "${name}" updated!`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function deleteCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            if (!confirm(`Are you sure you want to delete "${view.name}"?`)) {
                return;
            }
            
            customViews = customViews.filter(v => v.id !== viewId);
            saveCustomViewsToStorage();
            populateCustomViewsList();
            
            // Remove the view element if it exists
            const viewElement = document.getElementById(`view-custom-${viewId}`);
            if (viewElement) {
                viewElement.remove();
            }
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #dc3545; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-trash"></i> View "${view.name}" deleted`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function exportCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            const results = allLabResults.filter(r => view.tests.includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab'];
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${view.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function populateMedications() {
            const view = document.getElementById('medicationsContent');
            view.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        ${healthData.medications.map(med => `
                            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                                <h4 style="color: #1e3c72; margin-bottom: 5px;">${med.medication}</h4>
                                <p style="color: #666; margin-bottom: 5px;"><strong>Dosage:</strong> ${med.dosage}</p>
                                <p style="color: #666;"><strong>Status:</strong> <span style="color: #28a745; font-weight: 600;">${med.status}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function populateDiagnoses() {
            const view = document.getElementById('diagnosesContent');
            view.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        ${healthData.diagnoses.map(dx => `
                            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                                <h4 style="color: #1e3c72; margin-bottom: 5px;">${dx.condition}</h4>
                                <p style="color: #666; margin-bottom: 5px;"><strong>ICD Code:</strong> ${dx.icd_code}</p>
                                <p style="color: #666;"><strong>Status:</strong> <span style="color: ${dx.status === 'Active' ? '#dc3545' : '#28a745'}; font-weight: 600;">${dx.status}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createCharts() {
            const container = document.getElementById('chartsContainer');
            const testNames = ['glucose', 'tsh', 'cholesterol_total', 'vitamin_d', 'creatinine', 'vitamin_b12'];
            
            container.innerHTML = testNames.map(test => `
                <div class="chart-card">
                    <h4>${formatTestName(test)} Trend</h4>
                    <canvas id="chart-${test}"></canvas>
                </div>
            `).join('');

            testNames.forEach(test => {
                const data = healthData.lab_results[test];
                if (!data || data.length === 0) return;

                const sorted = [...data].sort((a, b) => new Date(a.collected || a.date) - new Date(b.collected || b.date));
                
                const ctx = document.getElementById(`chart-${test}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sorted.map(d => formatDate(d.collected || d.date)),
                        datasets: [{
                            label: formatTestName(test),
                            data: sorted.map(d => parseFloat(d.result || d.value)),
                            borderColor: '#1e3c72',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: sorted[0].units || sorted[0].unit || ''
                                }
                            }
                        }
                    }
                });
            });
        }

        function showView(viewName) {
            // Handle custom views
            if (viewName.startsWith('custom-')) {
                const viewId = parseInt(viewName.replace('custom-', ''));
                const view = customViews.find(v => v.id === viewId);
                if (view) {
                    // Hide all views
                    document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    
                    renderCustomView(view);
                    document.getElementById(`view-${viewName}`).classList.add('active');
                    return;
                }
            }
            
            // Hide all views
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Populate special views if selected
            if (viewName === 'flagged') {
                populateFlaggedTests();
            } else if (viewName === 'my-high') {
                populateMyHighTests();
            } else if (viewName === 'my-low') {
                populateMyLowTests();
            } else if (viewName === 'custom-views') {
                populateCustomViewsList();
            } else if (viewName === 'trends-analysis') {
                populateTrendsAnalysisView();
            } else if (viewName === 'body-explorer') {
                initBodyExplorerOnView();
            } else if (viewName === 'calendar-labs') {
                initializeCalendarView();
            }
            
            // Highlight nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(viewName.replace('-', ' '))) {
                    item.classList.add('active');
                }
            });
        }

        function exportAllData() {
            const csv = convertToCSV(allLabResults);
            downloadCSV(csv, 'complete_health_data.csv');
        }

        function exportFilteredData() {
            const tbody = document.getElementById('allResultsBody');
            const rows = tbody.querySelectorAll('tr');
            const filtered = Array.from(rows).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    testName: cells[0].textContent,
                    collected: cells[1].textContent,
                    result: cells[2].textContent,
                    units: cells[3].textContent,
                    referenceRange: cells[4].textContent,
                    flag: cells[5].textContent,
                    lab: cells[6].textContent,
                    panel: cells[7].textContent,
                    category: cells[8].textContent,
                    physician: cells[9].textContent,
                    reported: cells[10].textContent,
                    source: cells[11].textContent,
                    specimenID: cells[12].textContent,
                    fasting: cells[13].textContent,
                    notes: cells[14].textContent
                };
            });
            
            const csv = convertToCSV(filtered);
            downloadCSV(csv, 'filtered_health_data.csv');
        }

        function exportCategory(category) {
            const results = allLabResults.filter(r => r.category.toLowerCase() === category.toLowerCase());
            const csv = convertToCSV(results);
            downloadCSV(csv, `${category}_panel_data.csv`);
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${row[h]}"`).join(','))
            ].join('\n');
            return csv;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Test Detail Panel Functions
        const testCategories = {
            'Metabolic': ['glucose', 'calcium', 'sodium', 'potassium', 'chloride', 'carbon_dioxide', 'bun', 'creatinine', 'albumin', 'protein_total', 'alkaline_phosphatase', 'alt', 'ast'],
            'Lipid': ['cholesterol_total', 'hdl', 'ldl', 'triglycerides', 'vldl'],
            'Thyroid': ['tsh', 't4_free', 't3_total', 't4_total'],
            'CBC': ['wbc', 'rbc', 'hemoglobin', 'hematocrit', 'mcv', 'mch', 'mchc', 'rdw', 'platelets', 'mpv', 'nrbcs', 'neutrophils_percent', 'lymphocytes_percent', 'monocytes_percent', 'eosinophils_percent', 'basophils_percent'],
            'Kidney': ['bun', 'creatinine', 'egfr', 'bun_creatinine_ratio'],
            'Liver': ['ast', 'alt', 'alkaline_phosphatase', 'bilirubin_total', 'albumin', 'protein_total'],
            'Vitamins': ['vitamin_d', 'vitamin_b12', 'folate'],
            'Iron': ['iron', 'tibc', 'transferrin', 'iron_saturation', 'ferritin'],
            'Inflammation': ['crp', 'sed_rate'],
            'Hormones': ['testosterone_total']
        };

        let currentDetailChart = null;

        function openTestDetailPanel(testName) {
            const overlay = document.getElementById('testDetailOverlay');
            const panel = document.getElementById('testDetailPanel');
            
            overlay.classList.add('active');
            panel.classList.add('active');
            
            // Populate categories if not already done
            populateTestCategories();
            
            // Load the test chart
            loadTestChart(testName);
        }

        function closeTestDetailPanel() {
            const overlay = document.getElementById('testDetailOverlay');
            const panel = document.getElementById('testDetailPanel');
            
            overlay.classList.remove('active');
            panel.classList.remove('active');
            
            // Destroy chart if exists
            if (currentDetailChart) {
                currentDetailChart.destroy();
                currentDetailChart = null;
            }
        }

        function populateTestCategories() {
            const container = document.getElementById('testCategoriesList');
            
            if (container.children.length > 0) return; // Already populated
            
            container.innerHTML = Object.keys(testCategories).map(category => {
                const tests = testCategories[category];
                const testCount = tests.length;
                
                return `
                    <div class="test-category">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <i class="fas fa-chevron-right category-icon" id="icon-${category}"></i>
                            <span class="category-name">${category} Panel</span>
                            <span class="test-count">${testCount}</span>
                        </div>
                        <div class="test-list" id="list-${category}">
                            ${tests.map(test => `
                                <a href="javascript:void(0)" 
                                   class="test-item-link" 
                                   onclick="loadTestChart('${test}')"
                                   id="link-${test}">
                                    ${formatTestName(test)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCategory(category) {
            const icon = document.getElementById(`icon-${category}`);
            const list = document.getElementById(`list-${category}`);
            
            icon.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        function formatTestName(testKey) {
            // Convert test key to readable name
            const nameMap = {
                'glucose': 'Glucose',
                'calcium': 'Calcium',
                'sodium': 'Sodium',
                'potassium': 'Potassium',
                'chloride': 'Chloride',
                'carbon_dioxide': 'Carbon Dioxide',
                'bun': 'BUN',
                'creatinine': 'Creatinine',
                'albumin': 'Albumin',
                'protein_total': 'Total Protein',
                'alkaline_phosphatase': 'Alkaline Phosphatase',
                'alt': 'ALT',
                'ast': 'AST',
                'cholesterol_total': 'Total Cholesterol',
                'hdl': 'HDL Cholesterol',
                'ldl': 'LDL Cholesterol',
                'triglycerides': 'Triglycerides',
                'vldl': 'VLDL',
                'tsh': 'TSH',
                't4_free': 'Free T4',
                't3_total': 'Total T3',
                't4_total': 'Total T4',
                'wbc': 'WBC',
                'rbc': 'RBC',
                'hemoglobin': 'Hemoglobin',
                'hematocrit': 'Hematocrit',
                'mcv': 'MCV',
                'mch': 'MCH',
                'mchc': 'MCHC',
                'rdw': 'RDW',
                'platelets': 'Platelets',
                'mpv': 'MPV',
                'nrbcs': 'nRBCs',
                'neutrophils_percent': 'Neutrophils %',
                'lymphocytes_percent': 'Lymphocytes %',
                'monocytes_percent': 'Monocytes %',
                'eosinophils_percent': 'Eosinophils %',
                'basophils_percent': 'Basophils %',
                'egfr': 'eGFR',
                'bun_creatinine_ratio': 'BUN/Creatinine Ratio',
                'bilirubin_total': 'Total Bilirubin',
                'vitamin_d': 'Vitamin D',
                'vitamin_b12': 'Vitamin B12',
                'folate': 'Folate',
                'iron': 'Iron',
                'tibc': 'TIBC',
                'transferrin': 'Transferrin',
                'iron_saturation': 'Iron Saturation',
                'ferritin': 'Ferritin',
                'crp': 'C-Reactive Protein',
                'sed_rate': 'Sed Rate',
                'testosterone_total': 'Total Testosterone'
            };
            
            return nameMap[testKey] || testKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function loadTestChart(testKey) {
            // Remove active class from all test links
            document.querySelectorAll('.test-item-link').forEach(link => link.classList.remove('active'));
            
            // Add active class to clicked test
            const activeLink = document.getElementById(`link-${testKey}`);
            if (activeLink) activeLink.classList.add('active');
            
            // Get test data from allLabResults
            const testData = allLabResults.filter(r => r.rawTestName === testKey);
            
            if (!testData || testData.length === 0) {
                document.getElementById('testChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No data available for this test</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            const sortedData = [...testData].sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            // Extract data for chart
            const dates = sortedData.map(d => formatDate(d.collected));
            const values = sortedData.map(d => parseFloat(d.result)).filter(v => !isNaN(v));
            
            if (values.length === 0) {
                document.getElementById('testChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No numeric data available for charting</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const firstResult = sortedData.find(d => !isNaN(parseFloat(d.result)));
            const units = firstResult.units || '';
            const refLow = firstResult.refLow;
            const refHigh = firstResult.refHigh;
            const refRange = refLow && refHigh ? `${refLow} - ${refHigh} ${units}` : firstResult.referenceRange;
            
            // Create chart HTML
            document.getElementById('testChartContainer').innerHTML = `
                <div class="chart-container-detail">
                    <div class="chart-header-detail">
                        <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                        <p class="chart-subtitle-detail">Normal range: ${refRange}</p>
                    </div>
                    
                    <div class="chart-canvas-wrapper">
                        <canvas id="detailChart"></canvas>
                    </div>
                    
                    <div class="data-table-toggle">
                        <button class="data-table-btn" onclick="toggleDetailDataTable()">
                            Data table <i class="fas fa-chevron-down" id="tableToggleIcon"></i>
                        </button>
                    </div>
                    
                    <table class="detail-data-table" id="detailDataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Normal Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(d => `
                                <tr data-row-id="${d.id}">
                                    <td>${formatDate(d.collected)}</td>
                                    <td><strong>${d.result} ${d.units || ''}</strong></td>
                                    <td>${d.reference_range}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Create Chart.js chart
            const ctx = document.getElementById('detailChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (currentDetailChart) {
                currentDetailChart.destroy();
            }
            
            // Calculate y-axis range
            const dataMin = Math.min(...values);
            const dataMax = Math.max(...values);
            let yMin, yMax, yMid;
            
            if (refLow && refHigh) {
                yMin = Math.min(dataMin, refLow) * 0.9;
                yMax = Math.max(dataMax, refHigh) * 1.1;
                yMid = (refLow + refHigh) / 2;
            } else {
                yMin = dataMin * 0.9;
                yMax = dataMax * 1.1;
                yMid = (yMin + yMax) / 2;
            }
            
            // Build an array of row ids aligned to the data points
            const pointRowIds = sortedData.map(d => d.id);

            currentDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: formatTestName(testKey),
                        data: values,
                        borderColor: '#007AFF',
                        backgroundColor: '#007AFF',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    onClick: function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const chart = this;
                        const idx = elements[0].index;
                        const rowId = pointRowIds[idx];
                        if (rowId) highlightDataRow(rowId);
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} ${units}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                count: 3
                            },
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function toggleDetailDataTable() {
            const table = document.getElementById('detailDataTable');
            const icon = document.getElementById('tableToggleIcon');
            
            table.classList.toggle('visible');
            icon.classList.toggle('rotated');
        }

        function highlightDataRow(rowId) {
            try {
                const table = document.getElementById('detailDataTable');
                if (!table) return;

                // Remove existing highlights
                document.querySelectorAll('.detail-data-table tr.highlight-row').forEach(r => r.classList.remove('highlight-row'));

                const target = table.querySelector(`tr[data-row-id="${rowId}"]`);
                if (!target) return;

                // Ensure table is visible
                if (!table.classList.contains('visible')) {
                    table.classList.add('visible');
                    const icon = document.getElementById('tableToggleIcon');
                    if (icon) icon.classList.add('rotated');
                }

                // Scroll into view smoothly within the table container
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add highlight class and remove after 3s
                target.classList.add('highlight-row');
                setTimeout(() => {
                    target.classList.remove('highlight-row');
                }, 3000);
            } catch (e) {
                console.warn('highlightDataRow error', e);
            }
        }

        // Trends Analysis View Functions
        function populateTrendsAnalysisView() {
            const container = document.getElementById('trendsAnalysisCategoriesList');
            
            if (container.children.length > 0) return; // Already populated
            
            container.innerHTML = Object.keys(testCategories).map(category => {
                const tests = testCategories[category];
                const testCount = tests.length;
                
                return `
                    <div class="test-category">
                        <div class="category-header" onclick="toggleTrendsCategory('${category}')">
                            <i class="fas fa-chevron-right category-icon" id="trends-icon-${category}"></i>
                            <span class="category-name">${category} Panel</span>
                            <span class="test-count">${testCount}</span>
                        </div>
                        <div class="test-list" id="trends-list-${category}">
                            ${tests.map(test => `
                                <a href="javascript:void(0)" 
                                   class="test-item-link" 
                                   onclick="loadTrendsChart('${test}')"
                                   id="trends-link-${test}">
                                    ${formatTestName(test)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTrendsCategory(category) {
            const icon = document.getElementById(`trends-icon-${category}`);
            const list = document.getElementById(`trends-list-${category}`);
            
            icon.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        function loadTrendsChart(testKey) {
            // Remove active class from all test links
            document.querySelectorAll('#trendsAnalysisCategoriesList .test-item-link').forEach(link => link.classList.remove('active'));
            
            // Add active class to clicked test
            const activeLink = document.getElementById(`trends-link-${testKey}`);
            if (activeLink) activeLink.classList.add('active');
            
            // Get test data from healthData
            const testData = healthData.lab_results[testKey];
            
            if (!testData || testData.length === 0) {
                document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No data available for this test</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            const sortedData = [...testData].sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            // Extract data for chart
            const dates = sortedData.map(d => formatDate(d.collected));
            const values = sortedData.map(d => parseFloat(d.result)).filter(v => !isNaN(v));
            
            if (values.length === 0) {
                document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No numeric data available for charting</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const firstResult = sortedData.find(d => !isNaN(parseFloat(d.result)));
            const units = firstResult.units || '';
            const refLow = firstResult.range_low;
            const refHigh = firstResult.range_high;
            const refRange = refLow && refHigh ? `${refLow} - ${refHigh} ${units}` : firstResult.reference_range;
            
            // Create chart HTML
            document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                <div class="chart-container-detail">
                    <div class="chart-header-detail">
                        <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                        <p class="chart-subtitle-detail">Normal range: ${refRange}</p>
                    </div>
                    
                    <div class="chart-canvas-wrapper">
                        <canvas id="trendsAnalysisChart"></canvas>
                    </div>
                    
                    <div class="data-table-toggle">
                        <button class="data-table-btn" onclick="toggleTrendsDataTable()">
                            Data table <i class="fas fa-chevron-down" id="trendsTableToggleIcon"></i>
                        </button>
                    </div>
                    
                    <table class="detail-data-table" id="trendsDataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Normal Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(d => `
                                <tr data-row-id="${d.id}">
                                    <td>${formatDate(d.collected)}</td>
                                    <td><strong>${d.result} ${d.units || ''}</strong></td>
                                    <td>${d.reference_range}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Create Chart.js chart
            const ctx = document.getElementById('trendsAnalysisChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (window.trendsAnalysisChartInstance) {
                window.trendsAnalysisChartInstance.destroy();
            }
            
            // Calculate y-axis range
            const dataMin = Math.min(...values);
            const dataMax = Math.max(...values);
            let yMin, yMax, yMid;
            
            if (refLow && refHigh) {
                yMin = Math.min(dataMin, refLow) * 0.9;
                yMax = Math.max(dataMax, refHigh) * 1.1;
                yMid = (refLow + refHigh) / 2;
            } else {
                yMin = dataMin * 0.9;
                yMax = dataMax * 1.1;
                yMid = (yMin + yMax) / 2;
            }
            
            const trendsPointRowIds = sortedData.map(d => d.id);

            window.trendsAnalysisChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: formatTestName(testKey),
                        data: values,
                        borderColor: '#007AFF',
                        backgroundColor: '#007AFF',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    onClick: function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const idx = elements[0].index;
                        const rowId = trendsPointRowIds[idx];
                        if (rowId) highlightDataRow(rowId);
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} ${units}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                count: 3
                            },
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function toggleTrendsDataTable() {
            const table = document.getElementById('trendsDataTable');
            const icon = document.getElementById('trendsTableToggleIcon');
            
            table.classList.toggle('visible');
            icon.classList.toggle('rotated');
        }

        // Body Explorer Data and Functions
        const bodyPartData = {
            'head': {
                name: 'Head',
                icon: 'fa-head-side',
                category: 'External Body Part',
                description: 'The head is the upper part of the human body containing the brain, eyes, ears, nose, and mouth. It houses the primary sensory organs and the central processing unit of the nervous system.',
                functions: [
                    'Houses and protects the brain',
                    'Contains sensory organs (eyes, ears, nose, tongue)',
                    'Enables facial expressions and communication',
                    'Protects entry points to respiratory and digestive systems'
                ],
                relatedOrgans: ['Brain', 'Eyes', 'Ears', 'Nose', 'Mouth'],
                relatedTests: ['MRI', 'CT Scan', 'EEG', 'Vision Tests', 'Hearing Tests']
            },
            'brain': {
                name: 'Brain',
                icon: 'fa-brain',
                category: 'Internal Organ',
                description: 'The brain is the command center of the human body. It controls all voluntary and involuntary actions, processes sensory information, enables thought, memory, emotion, and consciousness.',
                functions: [
                    'Controls all body functions and movements',
                    'Processes and stores memories',
                    'Enables thinking, reasoning, and emotions',
                    'Regulates hormones and body temperature',
                    'Interprets sensory information'
                ],
                relatedOrgans: ['Spinal Cord', 'Nerves', 'Pituitary Gland'],
                relatedTests: ['MRI Brain', 'CT Scan', 'EEG', 'Cognitive Tests', 'Neurological Exam']
            },
            'neck': {
                name: 'Neck',
                icon: 'fa-head-side',
                category: 'External Body Part',
                description: 'The neck connects the head to the torso and contains vital structures including the cervical spine, trachea, esophagus, thyroid gland, and major blood vessels to the brain.',
                functions: [
                    'Supports and allows movement of the head',
                    'Contains the airway (trachea)',
                    'Houses the thyroid gland',
                    'Carries blood vessels to and from the brain',
                    'Contains lymph nodes for immune function'
                ],
                relatedOrgans: ['Thyroid', 'Trachea', 'Esophagus', 'Cervical Spine', 'Carotid Arteries'],
                relatedTests: ['TSH', 'T3', 'T4', 'Thyroid Ultrasound', 'Neck X-ray']
            },
            'chest': {
                name: 'Chest (Thorax)',
                icon: 'fa-lungs',
                category: 'External Body Part',
                description: 'The chest, or thorax, is the area between the neck and abdomen. It contains vital organs including the heart, lungs, and major blood vessels, protected by the rib cage.',
                functions: [
                    'Protects heart and lungs with the rib cage',
                    'Enables breathing through chest expansion',
                    'Houses the heart for blood circulation',
                    'Contains major blood vessels and lymph nodes'
                ],
                relatedOrgans: ['Heart', 'Lungs', 'Ribs', 'Esophagus', 'Thymus'],
                relatedTests: ['Chest X-ray', 'ECG/EKG', 'Echocardiogram', 'Pulmonary Function Tests']
            },
            'heart': {
                name: 'Heart',
                icon: 'fa-heart',
                category: 'Internal Organ',
                description: 'The heart is a muscular organ that pumps blood throughout the body via the circulatory system. It beats approximately 100,000 times per day, supplying oxygen and nutrients to all tissues.',
                functions: [
                    'Pumps oxygenated blood to the body',
                    'Returns deoxygenated blood to the lungs',
                    'Maintains blood pressure',
                    'Responds to body\'s oxygen demands',
                    'Produces hormones that regulate blood volume'
                ],
                relatedOrgans: ['Arteries', 'Veins', 'Lungs', 'Blood Vessels'],
                relatedTests: ['ECG/EKG', 'Echocardiogram', 'Cholesterol Panel', 'Troponin', 'BNP', 'Stress Test']
            },
            'lungs': {
                name: 'Lungs',
                icon: 'fa-lungs',
                category: 'Internal Organ',
                description: 'The lungs are a pair of spongy organs responsible for respiration. They exchange oxygen from the air with carbon dioxide from the blood, essential for cellular metabolism.',
                functions: [
                    'Exchange oxygen and carbon dioxide',
                    'Filter small blood clots and air bubbles',
                    'Regulate blood pH through CO2 levels',
                    'Produce surfactant to prevent lung collapse',
                    'Play a role in immune defense'
                ],
                relatedOrgans: ['Trachea', 'Bronchi', 'Diaphragm', 'Heart'],
                relatedTests: ['Pulmonary Function Tests', 'Chest X-ray', 'CT Chest', 'Arterial Blood Gas', 'Pulse Oximetry']
            },
            'abdomen': {
                name: 'Abdomen',
                icon: 'fa-stomach',
                category: 'External Body Part',
                description: 'The abdomen is the region between the chest and pelvis containing many vital digestive and urinary organs. It is divided into regions for medical examination and diagnosis.',
                functions: [
                    'Houses digestive organs',
                    'Contains kidneys and adrenal glands',
                    'Protects abdominal organs with muscle wall',
                    'Assists in breathing through diaphragm movement',
                    'Supports core body stability'
                ],
                relatedOrgans: ['Stomach', 'Liver', 'Intestines', 'Kidneys', 'Spleen', 'Pancreas'],
                relatedTests: ['Abdominal Ultrasound', 'CT Abdomen', 'Liver Function Tests', 'Kidney Function Tests', 'Lipase', 'Amylase']
            },
            'stomach': {
                name: 'Stomach',
                icon: 'fa-stomach',
                category: 'Internal Organ',
                description: 'The stomach is a muscular, hollow organ that receives food from the esophagus. It secretes acid and enzymes to break down food, mixing it into a semi-liquid form called chyme.',
                functions: [
                    'Stores and mixes food with digestive juices',
                    'Secretes hydrochloric acid to kill bacteria',
                    'Produces pepsin to digest proteins',
                    'Absorbs some medications and alcohol',
                    'Releases food gradually to small intestine'
                ],
                relatedOrgans: ['Esophagus', 'Small Intestine', 'Liver', 'Pancreas'],
                relatedTests: ['H. pylori Test', 'Upper Endoscopy', 'Gastric Emptying Study', 'Barium Swallow']
            },
            'liver': {
                name: 'Liver',
                icon: 'fa-liver',
                category: 'Internal Organ',
                description: 'The liver is the largest internal organ and performs over 500 vital functions. It detoxifies blood, produces bile for digestion, stores nutrients, and synthesizes essential proteins.',
                functions: [
                    'Detoxifies blood and metabolizes drugs',
                    'Produces bile for fat digestion',
                    'Stores glycogen, vitamins, and minerals',
                    'Synthesizes proteins including clotting factors',
                    'Regulates blood sugar levels',
                    'Breaks down old red blood cells'
                ],
                relatedOrgans: ['Gallbladder', 'Pancreas', 'Small Intestine'],
                relatedTests: ['AST', 'ALT', 'Alkaline Phosphatase', 'Bilirubin', 'Albumin', 'GGT', 'Liver Ultrasound']
            },
            'kidneys': {
                name: 'Kidneys',
                icon: 'fa-kidneys',
                category: 'Internal Organ',
                description: 'The kidneys are a pair of bean-shaped organs that filter blood, remove waste products, and regulate fluid balance. They produce urine and play crucial roles in blood pressure regulation.',
                functions: [
                    'Filter blood and remove waste products',
                    'Regulate fluid and electrolyte balance',
                    'Control blood pressure through renin',
                    'Produce erythropoietin for red blood cell production',
                    'Activate vitamin D for bone health',
                    'Maintain acid-base balance'
                ],
                relatedOrgans: ['Ureters', 'Bladder', 'Adrenal Glands'],
                relatedTests: ['Creatinine', 'BUN', 'eGFR', 'Urinalysis', 'Kidney Ultrasound', 'Electrolytes']
            },
            'intestines': {
                name: 'Intestines',
                icon: 'fa-bacteria',
                category: 'Internal Organ',
                description: 'The intestines consist of the small and large intestine. The small intestine absorbs most nutrients, while the large intestine absorbs water and forms waste for elimination.',
                functions: [
                    'Digest and absorb nutrients (small intestine)',
                    'Absorb water and electrolytes (large intestine)',
                    'House beneficial gut bacteria (microbiome)',
                    'Produce some vitamins through bacteria',
                    'Form and store feces for elimination',
                    'Participate in immune function'
                ],
                relatedOrgans: ['Stomach', 'Liver', 'Pancreas', 'Appendix', 'Rectum'],
                relatedTests: ['Colonoscopy', 'Stool Tests', 'Celiac Panel', 'Fecal Occult Blood', 'CT Colonography']
            },
            'pelvis': {
                name: 'Pelvis',
                icon: 'fa-bone',
                category: 'External Body Part',
                description: 'The pelvis is the bony structure at the base of the spine. It supports the weight of the upper body, protects pelvic organs, and connects the spine to the legs.',
                functions: [
                    'Supports upper body weight',
                    'Protects reproductive and urinary organs',
                    'Provides attachment for leg muscles',
                    'Allows walking and running movements',
                    'Houses the bladder and reproductive organs'
                ],
                relatedOrgans: ['Bladder', 'Reproductive Organs', 'Hip Bones', 'Sacrum'],
                relatedTests: ['Pelvic X-ray', 'Pelvic Ultrasound', 'MRI Pelvis', 'Bone Density Scan']
            },
            'left-arm': {
                name: 'Left Arm',
                icon: 'fa-hand',
                category: 'External Body Part',
                description: 'The arm extends from the shoulder to the wrist and contains muscles, bones, blood vessels, and nerves. It enables a wide range of movements and fine motor skills.',
                functions: [
                    'Enables reaching and lifting',
                    'Performs fine motor movements',
                    'Carries blood to and from the hand',
                    'Contains sensory nerves for touch',
                    'Supports daily activities and work'
                ],
                relatedOrgans: ['Humerus', 'Radius', 'Ulna', 'Biceps', 'Triceps', 'Brachial Artery'],
                relatedTests: ['Blood Pressure', 'X-ray', 'EMG', 'Nerve Conduction Study', 'Blood Draw']
            },
            'right-arm': {
                name: 'Right Arm',
                icon: 'fa-hand',
                category: 'External Body Part',
                description: 'The arm extends from the shoulder to the wrist and contains muscles, bones, blood vessels, and nerves. It enables a wide range of movements and fine motor skills.',
                functions: [
                    'Enables reaching and lifting',
                    'Performs fine motor movements',
                    'Carries blood to and from the hand',
                    'Contains sensory nerves for touch',
                    'Supports daily activities and work'
                ],
                relatedOrgans: ['Humerus', 'Radius', 'Ulna', 'Biceps', 'Triceps', 'Brachial Artery'],
                relatedTests: ['Blood Pressure', 'X-ray', 'EMG', 'Nerve Conduction Study', 'Blood Draw']
            },
            'left-hand': {
                name: 'Left Hand',
                icon: 'fa-hand-paper',
                category: 'External Body Part',
                description: 'The hand is one of the most complex parts of the body with 27 bones, numerous muscles, and a high density of nerve endings. It enables precise movements and tactile sensation.',
                functions: [
                    'Performs fine motor tasks and grip',
                    'Provides sense of touch and temperature',
                    'Enables tool use and manipulation',
                    'Facilitates communication through gestures',
                    'Contains pulse points for vital signs'
                ],
                relatedOrgans: ['Carpal Bones', 'Metacarpals', 'Phalanges', 'Hand Muscles', 'Radial Artery'],
                relatedTests: ['Hand X-ray', 'Grip Strength Test', 'Rheumatoid Factor', 'Carpal Tunnel Tests']
            },
            'right-hand': {
                name: 'Right Hand',
                icon: 'fa-hand-paper',
                category: 'External Body Part',
                description: 'The hand is one of the most complex parts of the body with 27 bones, numerous muscles, and a high density of nerve endings. It enables precise movements and tactile sensation.',
                functions: [
                    'Performs fine motor tasks and grip',
                    'Provides sense of touch and temperature',
                    'Enables tool use and manipulation',
                    'Facilitates communication through gestures',
                    'Contains pulse points for vital signs'
                ],
                relatedOrgans: ['Carpal Bones', 'Metacarpals', 'Phalanges', 'Hand Muscles', 'Radial Artery'],
                relatedTests: ['Hand X-ray', 'Grip Strength Test', 'Rheumatoid Factor', 'Carpal Tunnel Tests']
            },
            'left-leg': {
                name: 'Left Leg',
                icon: 'fa-person-walking',
                category: 'External Body Part',
                description: 'The leg extends from the hip to the ankle and is designed for weight-bearing, locomotion, and balance. It contains the body\'s largest bones and muscles.',
                functions: [
                    'Supports body weight when standing',
                    'Enables walking, running, and jumping',
                    'Maintains balance and posture',
                    'Returns blood to the heart via veins',
                    'Contains large muscle groups for strength'
                ],
                relatedOrgans: ['Femur', 'Tibia', 'Fibula', 'Quadriceps', 'Hamstrings', 'Femoral Artery'],
                relatedTests: ['Leg X-ray', 'Doppler Ultrasound', 'Bone Density', 'EMG', 'Ankle-Brachial Index']
            },
            'right-leg': {
                name: 'Right Leg',
                icon: 'fa-person-walking',
                category: 'External Body Part',
                description: 'The leg extends from the hip to the ankle and is designed for weight-bearing, locomotion, and balance. It contains the body\'s largest bones and muscles.',
                functions: [
                    'Supports body weight when standing',
                    'Enables walking, running, and jumping',
                    'Maintains balance and posture',
                    'Returns blood to the heart via veins',
                    'Contains large muscle groups for strength'
                ],
                relatedOrgans: ['Femur', 'Tibia', 'Fibula', 'Quadriceps', 'Hamstrings', 'Femoral Artery'],
                relatedTests: ['Leg X-ray', 'Doppler Ultrasound', 'Bone Density', 'EMG', 'Ankle-Brachial Index']
            },
            'left-foot': {
                name: 'Left Foot',
                icon: 'fa-shoe-prints',
                category: 'External Body Part',
                description: 'The foot is a complex structure with 26 bones, 33 joints, and over 100 muscles, tendons, and ligaments. It provides balance, support, and propulsion during movement.',
                functions: [
                    'Bears body weight and provides balance',
                    'Absorbs shock during walking',
                    'Provides propulsion for movement',
                    'Enables standing on various surfaces',
                    'Contains arch for efficient weight distribution'
                ],
                relatedOrgans: ['Tarsal Bones', 'Metatarsals', 'Phalanges', 'Achilles Tendon', 'Plantar Fascia'],
                relatedTests: ['Foot X-ray', 'Gait Analysis', 'Diabetes Foot Exam', 'Ankle-Brachial Index']
            },
            'right-foot': {
                name: 'Right Foot',
                icon: 'fa-shoe-prints',
                category: 'External Body Part',
                description: 'The foot is a complex structure with 26 bones, 33 joints, and over 100 muscles, tendons, and ligaments. It provides balance, support, and propulsion during movement.',
                functions: [
                    'Bears body weight and provides balance',
                    'Absorbs shock during walking',
                    'Provides propulsion for movement',
                    'Enables standing on various surfaces',
                    'Contains arch for efficient weight distribution'
                ],
                relatedOrgans: ['Tarsal Bones', 'Metatarsals', 'Phalanges', 'Achilles Tendon', 'Plantar Fascia'],
                relatedTests: ['Foot X-ray', 'Gait Analysis', 'Diabetes Foot Exam', 'Ankle-Brachial Index']
            }
        };

        function initBodyExplorer() {
            const bodyParts = document.querySelectorAll('.body-part');
            const tooltip = document.getElementById('bodyPartTooltip');
            const svgWrapper = document.querySelector('.body-svg-wrapper');
            
            bodyParts.forEach(part => {
                // Mouse enter - show tooltip
                part.addEventListener('mouseenter', function(e) {
                    const partId = this.getAttribute('data-part');
                    const partInfo = bodyPartData[partId];
                    if (partInfo) {
                        tooltip.textContent = partInfo.name;
                        tooltip.classList.add('visible');
                    }
                });
                
                // Mouse move - position tooltip
                part.addEventListener('mousemove', function(e) {
                    const rect = svgWrapper.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
                    tooltip.style.top = (e.clientY - rect.top - 10) + 'px';
                });
                
                // Mouse leave - hide tooltip
                part.addEventListener('mouseleave', function() {
                    tooltip.classList.remove('visible');
                });
                
                // Click - show detailed info
                part.addEventListener('click', function() {
                    const partId = this.getAttribute('data-part');
                    showBodyPartInfo(partId);
                    
                    // Remove active class from all parts
                    bodyParts.forEach(p => p.classList.remove('active'));
                    
                    // Add active class to clicked part (and any parts with same data-part)
                    document.querySelectorAll(`[data-part="${partId}"]`).forEach(p => {
                        p.classList.add('active');
                    });
                });
            });
        }

        function showBodyPartInfo(partId) {
            const partInfo = bodyPartData[partId];
            const infoPanel = document.getElementById('bodyPartInfo');
            
            if (!partInfo) {
                infoPanel.innerHTML = `
                    <div class="info-placeholder">
                        <i class="fas fa-question-circle" style="font-size: 3rem; color: #999; margin-bottom: 15px;"></i>
                        <h3>Information Not Available</h3>
                        <p>Details for this body part are not yet available.</p>
                    </div>
                `;
                return;
            }
            
            infoPanel.innerHTML = `
                <div class="body-part-detail">
                    <h3><i class="fas ${partInfo.icon}"></i> ${partInfo.name}</h3>
                    <div class="part-category">${partInfo.category}</div>
                    
                    <p class="part-description">${partInfo.description}</p>
                    
                    <div class="part-section">
                        <h4><i class="fas fa-cogs"></i> Key Functions</h4>
                        <ul>
                            ${partInfo.functions.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="part-section">
                        <h4><i class="fas fa-sitemap"></i> Related Organs & Structures</h4>
                        <ul>
                            ${partInfo.relatedOrgans.map(o => `<li>${o}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="related-tests">
                        <h4><i class="fas fa-flask"></i> Related Medical Tests</h4>
                        <div>
                            ${partInfo.relatedTests.map(t => `<span class="test-tag">${t}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize body explorer when the view is shown
        function initBodyExplorerOnView() {
            // Use requestAnimationFrame for better timing consistency
            requestAnimationFrame(function() {
                const bodySvg = document.getElementById('body-svg');
                if (bodySvg && bodySvg.querySelectorAll('.body-part').length > 0) {
                    initBodyExplorer();
                } else {
                    // Fallback: retry on next frame if elements not ready
                    requestAnimationFrame(initBodyExplorer);
                }
            });
        }

        // Calendar View Functions
        let calendarCurrentDate = new Date();
        let calendarViewMode = 'month'; // 'month' or 'week'
        let comparisonDates = [];
        let calendarLabsByDate = {};

        function initializeCalendarView() {
            // Build date-indexed lab data
            calendarLabsByDate = {};
            
            allLabResults.forEach(lab => {
                const date = lab.collected;
                if (!date) return;
                
                if (!calendarLabsByDate[date]) {
                    calendarLabsByDate[date] = [];
                }
                calendarLabsByDate[date].push(lab);
            });

            // Populate marker filter dropdown
            const markerFilter = document.getElementById('calendarMarkerFilter');
            const uniqueTests = [...new Set(allLabResults.map(r => r.testName))].sort();
            markerFilter.innerHTML = '<option value="">All Markers</option>' + 
                uniqueTests.map(test => `<option value="${test}">${test}</option>`).join('');

            // Reset to current month
            calendarCurrentDate = new Date();
            comparisonDates = [];
            refreshCalendar();
        }

        function refreshCalendar() {
            if (calendarViewMode === 'month') {
                renderMonthView();
            } else {
                renderWeekView();
            }
        }

        function renderMonthView() {
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

            // Get filter values
            const panelFilter = document.getElementById('calendarPanelFilter').value;
            const markerFilter = document.getElementById('calendarMarkerFilter').value;

            // Calculate calendar grid
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const todayStr = formatDateISO(today);

            let html = '<div class="calendar-grid">';
            
            // Weekday headers
            const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            weekdays.forEach(day => {
                html += `<div class="calendar-weekday">${day}</div>`;
            });

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = formatDateISO(new Date(year, month, day));
                const labs = calendarLabsByDate[dateStr] || [];
                
                // Apply filters
                let filteredLabs = labs;
                if (panelFilter) {
                    filteredLabs = filteredLabs.filter(lab => lab.panel === panelFilter);
                }
                if (markerFilter) {
                    filteredLabs = filteredLabs.filter(lab => lab.testName === markerFilter);
                }

                const status = calculateDateStatus(filteredLabs);
                const isToday = dateStr === todayStr;
                const isSelected = comparisonDates.includes(dateStr);

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="handleDateClick('${dateStr}')"
                         data-date="${dateStr}">
                        <div class="calendar-day-number">${day}</div>
                        ${filteredLabs.length > 0 ? `
                            <div class="calendar-day-status">
                                <span class="status-badge ${status}">${status === 'not-run' ? '' : status}</span>
                            </div>
                            <div class="lab-count">${filteredLabs.length} test${filteredLabs.length > 1 ? 's' : ''}</div>
                        ` : '<div class="calendar-day-status"><span class="status-badge not-run"></span></div>'}
                    </div>
                `;
            }

            html += '</div>';
            document.getElementById('calendarViewContainer').innerHTML = html;
        }

        function renderWeekView() {
            const year = calendarCurrentDate.getFullYear();
            const month = calendarCurrentDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Get the week containing the current date
            const startOfWeek = new Date(calendarCurrentDate);
            startOfWeek.setDate(calendarCurrentDate.getDate() - calendarCurrentDate.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            document.getElementById('calendarMonthYear').textContent = 
                `${formatDate(formatDateISO(startOfWeek))} - ${formatDate(formatDateISO(endOfWeek))}`;

            // Get filter values
            const panelFilter = document.getElementById('calendarPanelFilter').value;
            const markerFilter = document.getElementById('calendarMarkerFilter').value;

            const today = new Date();
            const todayStr = formatDateISO(today);

            let html = '<div class="calendar-weekly">';
            
            // Weekday headers
            html += '<div class="week-row">';
            const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            weekdays.forEach(day => {
                html += `<div class="calendar-weekday">${day}</div>`;
            });
            html += '</div>';

            // Week days
            html += '<div class="week-row">';
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = formatDateISO(date);
                const labs = calendarLabsByDate[dateStr] || [];
                
                // Apply filters
                let filteredLabs = labs;
                if (panelFilter) {
                    filteredLabs = filteredLabs.filter(lab => lab.panel === panelFilter);
                }
                if (markerFilter) {
                    filteredLabs = filteredLabs.filter(lab => lab.testName === markerFilter);
                }

                const status = calculateDateStatus(filteredLabs);
                const isToday = dateStr === todayStr;

                html += `
                    <div class="week-day ${isToday ? 'today' : ''}" onclick="handleDateClick('${dateStr}')">
                        <div class="calendar-day-number">${date.getDate()}</div>
                        <div style="font-size: 0.75em; color: #999; margin-bottom: 8px;">
                            ${monthNames[date.getMonth()].substring(0, 3)}
                        </div>
                        ${filteredLabs.length > 0 ? `
                            <div class="status-badge ${status}" style="margin-bottom: 8px;">${status}</div>
                            <div class="lab-count">${filteredLabs.length} tests</div>
                            <div style="margin-top: 8px; font-size: 0.75em; color: #666;">
                                ${getPanelSummary(filteredLabs)}
                            </div>
                        ` : '<div class="status-badge not-run">No Labs</div>'}
                    </div>
                `;
            }
            html += '</div>';

            html += '</div>';
            document.getElementById('calendarViewContainer').innerHTML = html;
        }

        function calculateDateStatus(labs) {
            if (!labs || labs.length === 0) return 'not-run';
            
            let hasHigh = false;
            let hasLow = false;
            let hasNormal = false;

            labs.forEach(lab => {
                const flag = (lab.flag || '').toLowerCase();
                const status = (lab.status || '').toLowerCase();
                
                if (flag.includes('high') || status.includes('high')) {
                    hasHigh = true;
                } else if (flag.includes('low') || status.includes('low')) {
                    hasLow = true;
                } else {
                    hasNormal = true;
                }
            });

            if (hasHigh && hasLow) return 'mixed';
            if (hasHigh) return 'high';
            if (hasLow) return 'low';
            return 'normal';
        }

        function getPanelSummary(labs) {
            const panels = {};
            labs.forEach(lab => {
                const panel = lab.panel || 'Other';
                panels[panel] = (panels[panel] || 0) + 1;
            });
            
            const panelNames = {
                'Comprehensive Metabolic Panel': 'CMP',
                'Complete Blood Count': 'CBC',
                'Lipid Panel': 'Lipid',
                'Thyroid Panel': 'Thyroid'
            };
            
            return Object.entries(panels)
                .map(([panel, count]) => `${panelNames[panel] || panel}: ${count}`)
                .join(', ');
        }

        function handleDateClick(dateStr) {
            const compareMode = document.getElementById('calendarCompareMode').value;
            
            if (compareMode === 'compare') {
                handleComparisonDateClick(dateStr);
            } else {
                openLabDetailPanel(dateStr);
            }
        }

        function handleComparisonDateClick(dateStr) {
            const index = comparisonDates.indexOf(dateStr);
            
            if (index > -1) {
                // Remove from selection
                comparisonDates.splice(index, 1);
            } else {
                // Add to selection (max 2 dates)
                if (comparisonDates.length >= 2) {
                    comparisonDates.shift();
                }
                comparisonDates.push(dateStr);
            }

            updateComparisonDisplay();
            refreshCalendar();

            // If we have 2 dates selected, show comparison
            if (comparisonDates.length === 2) {
                showComparison(comparisonDates[0], comparisonDates[1]);
            }
        }

        function updateComparisonDisplay() {
            const display = document.getElementById('comparisonDatesDisplay');
            
            if (comparisonDates.length === 0) {
                display.innerHTML = '';
            } else {
                display.innerHTML = comparisonDates.map(date => `
                    <div class="comparison-date-tag">
                        <i class="fas fa-calendar-check"></i>
                        ${formatDate(date)}
                        <button onclick="removeComparisonDate('${date}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }
        }

        function removeComparisonDate(dateStr) {
            comparisonDates = comparisonDates.filter(d => d !== dateStr);
            updateComparisonDisplay();
            refreshCalendar();
        }

        function showComparison(date1, date2) {
            const labs1 = calendarLabsByDate[date1] || [];
            const labs2 = calendarLabsByDate[date2] || [];
            
            // Build comparison view
            const testMap = {};
            
            labs1.forEach(lab => {
                if (!testMap[lab.testName]) {
                    testMap[lab.testName] = { date1: null, date2: null };
                }
                testMap[lab.testName].date1 = lab;
            });
            
            labs2.forEach(lab => {
                if (!testMap[lab.testName]) {
                    testMap[lab.testName] = { date1: null, date2: null };
                }
                testMap[lab.testName].date2 = lab;
            });

            let html = `
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">
                        <i class="fas fa-code-compare"></i> Comparing Lab Results
                    </h4>
                    <div style="display: flex; gap: 20px;">
                        <div><strong>Date 1:</strong> ${formatDate(date1)}</div>
                        <div><strong>Date 2:</strong> ${formatDate(date2)}</div>
                    </div>
                </div>
            `;

            // Group by panel
            const byPanel = {};
            Object.entries(testMap).forEach(([testName, data]) => {
                const panel = (data.date1 || data.date2).panel || 'Other';
                if (!byPanel[panel]) byPanel[panel] = [];
                byPanel[panel].push({ testName, ...data });
            });

            Object.entries(byPanel).forEach(([panel, tests]) => {
                html += `
                    <div class="lab-panel-group">
                        <div class="lab-panel-group-title">
                            <i class="fas fa-flask"></i> ${panel}
                        </div>
                `;

                tests.forEach(test => {
                    const val1 = test.date1 ? `${test.date1.result} ${test.date1.units || ''}` : 'Not run';
                    const val2 = test.date2 ? `${test.date2.result} ${test.date2.units || ''}` : 'Not run';
                    
                    let change = '';
                    if (test.date1 && test.date2) {
                        const num1 = parseFloat(test.date1.result);
                        const num2 = parseFloat(test.date2.result);
                        if (!isNaN(num1) && !isNaN(num2)) {
                            const diff = num2 - num1;
                            const pct = ((diff / num1) * 100).toFixed(1);
                            change = `<span style="color: ${diff > 0 ? '#dc3545' : '#28a745'};">
                                ${diff > 0 ? 'â†—' : 'â†˜'} ${Math.abs(pct)}%
                            </span>`;
                        }
                    }

                    html += `
                        <div class="lab-marker">
                            <div class="lab-marker-name">${test.testName}</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; margin-top: 8px;">
                                <div>
                                    <div style="font-size: 0.75em; color: #999;">Date 1</div>
                                    <div style="font-weight: 600; color: #1e3c72;">${val1}</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #999;">Date 2</div>
                                    <div style="font-weight: 600; color: #1e3c72;">${val2}</div>
                                </div>
                                <div style="text-align: right;">
                                    ${change}
                                </div>
                            </div>
                            ${test.date1 || test.date2 ? `
                                <div class="lab-marker-range">
                                    Range: ${(test.date1 || test.date2).referenceRange}
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
            });

            document.getElementById('labPanelContent').innerHTML = html;
            document.getElementById('labPanelDate').innerHTML = `
                <i class="fas fa-code-compare"></i>
                <span>Comparison: ${formatDate(date1)} vs ${formatDate(date2)}</span>
            `;
            document.getElementById('labDetailPanel').classList.add('open');
            document.getElementById('calendarOverlay').classList.add('active');
        }

        function openLabDetailPanel(dateStr) {
            const labs = calendarLabsByDate[dateStr] || [];
            
            if (labs.length === 0) {
                return; // Don't open panel if no labs
            }

            // Apply filters
            const panelFilter = document.getElementById('calendarPanelFilter').value;
            const markerFilter = document.getElementById('calendarMarkerFilter').value;
            
            let filteredLabs = labs;
            if (panelFilter) {
                filteredLabs = filteredLabs.filter(lab => lab.panel === panelFilter);
            }
            if (markerFilter) {
                filteredLabs = filteredLabs.filter(lab => lab.testName === markerFilter);
            }

            // Group by panel
            const byPanel = {};
            filteredLabs.forEach(lab => {
                const panel = lab.panel || 'Other';
                if (!byPanel[panel]) byPanel[panel] = [];
                byPanel[panel].push(lab);
            });

            let html = '';
            Object.entries(byPanel).forEach(([panel, panelLabs]) => {
                html += `
                    <div class="lab-panel-group">
                        <div class="lab-panel-group-title">
                            <i class="fas fa-flask"></i> ${panel}
                        </div>
                `;

                panelLabs.forEach(lab => {
                    const flag = lab.flag || '';
                    const flagClass = flag.toLowerCase().includes('high') ? 'high' : 
                                     flag.toLowerCase().includes('low') ? 'low' : 'normal';

                    html += `
                        <div class="lab-marker" onclick="showTestTrend('${lab.rawTestName}')">
                            <div class="lab-marker-name">${lab.testName}</div>
                            <div class="lab-marker-value">
                                <span class="lab-marker-result">${lab.result} ${lab.units || ''}</span>
                                ${flag ? `<span class="lab-marker-flag ${flagClass}">${flag}</span>` : 
                                        '<span class="lab-marker-flag normal">Normal</span>'}
                            </div>
                            <div class="lab-marker-range">
                                Reference: ${lab.referenceRange}
                            </div>
                            ${lab.notes ? `<div style="font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic;">${lab.notes}</div>` : ''}
                        </div>
                    `;
                });

                html += '</div>';
            });

            document.getElementById('labPanelContent').innerHTML = html;
            document.getElementById('labPanelDate').innerHTML = `
                <i class="fas fa-calendar-day"></i>
                <span>${formatDate(dateStr)}</span>
            `;
            document.getElementById('labDetailPanel').classList.add('open');
            document.getElementById('calendarOverlay').classList.add('active');
        }

        function closeLabDetailPanel() {
            document.getElementById('labDetailPanel').classList.remove('open');
            document.getElementById('calendarOverlay').classList.remove('active');
        }

        function showTestTrend(testKey) {
            closeLabDetailPanel();
            showView('trends-analysis');
            setTimeout(() => {
                showTrendsAnalysisChart(testKey);
            }, 100);
        }

        function calendarPreviousMonth() {
            if (calendarViewMode === 'month') {
                calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() - 1);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() - 7);
            }
            refreshCalendar();
        }

        function calendarNextMonth() {
            if (calendarViewMode === 'month') {
                calendarCurrentDate.setMonth(calendarCurrentDate.getMonth() + 1);
            } else {
                calendarCurrentDate.setDate(calendarCurrentDate.getDate() + 7);
            }
            refreshCalendar();
        }

        function calendarToday() {
            calendarCurrentDate = new Date();
            refreshCalendar();
        }

        function switchCalendarView(mode) {
            calendarViewMode = mode;
            document.getElementById('monthViewBtn').classList.toggle('active', mode === 'month');
            document.getElementById('weekViewBtn').classList.toggle('active', mode === 'week');
            refreshCalendar();
        }

        function toggleComparisonMode() {
            const mode = document.getElementById('calendarCompareMode').value;
            const info = document.getElementById('comparisonModeInfo');
            
            if (mode === 'compare') {
                info.style.display = 'block';
                comparisonDates = [];
                updateComparisonDisplay();
            } else {
                info.style.display = 'none';
                comparisonDates = [];
            }
            
            refreshCalendar();
        }

        function formatDateISO(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Initialize on load
        window.onload = loadData;
    </script>

    <!-- Column Visibility Modal -->
    <div id="columnModal" class="modal-overlay" onclick="closeColumnModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-columns"></i> Column Visibility</h3>
                <button class="modal-close" onclick="closeColumnVisibilityModal()">&times;</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Select which columns to display in the table</p>
            <div class="column-checkboxes" id="columnCheckboxes"></div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="selectAllColumns()">Select All</button>
                <button class="btn btn-outline" onclick="deselectAllColumns()">Deselect All</button>
                <button class="btn btn-primary" onclick="applyColumnVisibility()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Custom View Builder Modal -->
    <div id="customViewModal" class="modal-overlay" onclick="closeCustomViewModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Create Custom Research View</h3>
                <button class="modal-close" onclick="closeCustomViewModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">View Name</label>
                <input type="text" id="customViewName" placeholder="e.g., My Monthly Checkup" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description (Optional)</label>
                <input type="text" id="customViewDescription" placeholder="What is this view for?" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Icon</label>
                <div id="iconSelector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                    <!-- Icons will be populated here -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label style="font-weight: 600; color: #333;">Select Tests to Include</label>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="selectAllTests()" style="padding: 5px 12px; font-size: 0.85rem;">Select All</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllTests()" style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">Deselect All</button>
                    </div>
                </div>
                <input type="text" id="testSearchInput" placeholder="Search tests..." 
                       onkeyup="filterTestsList()" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; margin-bottom: 12px;">
                <div id="testsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                    <!-- Tests will be populated here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeCustomViewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCustomView()">
                    <i class="fas fa-save"></i> Save Custom View
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Custom View Modal -->
    <div id="editCustomViewModal" class="modal-overlay" onclick="closeEditCustomViewModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Custom View</h3>
                <button class="modal-close" onclick="closeEditCustomViewModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">View Name</label>
                <input type="text" id="editViewName" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description (Optional)</label>
                <input type="text" id="editViewDescription" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Icon</label>
                <div id="editIconSelector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                    <!-- Icons will be populated here -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label style="font-weight: 600; color: #333;">Select Tests to Include</label>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="selectAllTestsEdit()" style="padding: 5px 12px; font-size: 0.85rem;">Select All</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllTestsEdit()" style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">Deselect All</button>
                    </div>
                </div>
                <input type="text" id="editTestSearchInput" placeholder="Search tests..." 
                       onkeyup="filterEditTestsList()" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; margin-bottom: 12px;">
                <div id="editTestsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                    <!-- Tests will be populated here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeEditCustomViewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateCustomView()">
                    <i class="fas fa-save"></i> Update View
                </button>
            </div>
        </div>
    </div>

    <!-- Test Detail Slide-in Panel -->
    <div class="test-detail-overlay" id="testDetailOverlay" onclick="closeTestDetailPanel()"></div>
    <div class="test-detail-panel" id="testDetailPanel">
        <button class="panel-close-btn" onclick="closeTestDetailPanel()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="test-detail-sidebar">
            <div class="sidebar-title">
                <i class="fas fa-flask"></i> Lab Tests
            </div>
            <div id="testCategoriesList"></div>
        </div>
        
        <div class="test-detail-content">
            <div id="testChartContainer"></div>
        </div>
    </div>

    <!-- Calendar Lab Detail Panel -->
    <div class="calendar-overlay" id="calendarOverlay" onclick="closeLabDetailPanel()"></div>
    <div class="lab-detail-panel" id="labDetailPanel">
        <div class="lab-panel-header">
            <h3 id="labPanelDate">
                <i class="fas fa-calendar-day"></i>
                <span>Lab Results</span>
            </h3>
            <button class="lab-panel-close" onclick="closeLabDetailPanel()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="lab-panel-content" id="labPanelContent">
            <!-- Lab details will be populated here -->
        </div>
    </div>
</body>
</html>
