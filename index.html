<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyHealth Portal - Zain Khan</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-nav h1 {
            font-size: 1.6em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .datetime {
            font-size: 0.9em;
            opacity: 0.95;
        }

        /* Patient Banner */
        .patient-banner {
            background: white;
            border-bottom: 4px solid #1e3c72;
            padding: 25px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .patient-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .patient-name {
            font-size: 2em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-btn {
            background: #1e3c72;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.5em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toggle-btn:hover {
            background: #2a5298;
            transform: translateY(-1px);
        }

        .collapsible-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .info-item {
            display: flex;
            gap: 8px;
            font-size: 0.95em;
            color: #555;
        }

        .info-item strong {
            color: #1e3c72;
            font-weight: 600;
        }

        .alert-banner {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border-left: 5px solid #ffc107;
            padding: 15px 20px;
            margin-top: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .alert-banner h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .alert-badge {
            background: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #856404;
            border: 1px solid #ffc107;
            font-weight: 500;
        }

        /* Layout */
        .main-container {
            display: flex;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            border-right: 1px solid #e0e0e0;
            min-height: calc(100vh - 200px);
            padding: 20px 0;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section-title {
            padding: 8px 25px;
            font-size: 0.75em;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            color: #444;
            font-size: 0.95em;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-item:hover {
            background: #f8f9fa;
            color: #1e3c72;
        }

        .nav-item.active {
            background: #e8f2f8;
            color: #1e3c72;
            border-left-color: #1e3c72;
            font-weight: 600;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-header h2 {
            font-size: 2em;
            color: #1a1a1a;
            font-weight: 700;
        }

        .action-bar {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #152949;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(30, 60, 114, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .btn-outline {
            background: white;
            color: #1e3c72;
            border: 2px solid #1e3c72;
        }

        .btn-outline:hover {
            background: #1e3c72;
            color: white;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        #alertCardsGrid {
            grid-template-columns: repeat(3, 1fr);
            max-width: 1200px;
            margin: 0 auto 30px;
        }

        @media (max-width: 900px) {
            #alertCardsGrid {
                grid-template-columns: 1fr;
            }
        }

        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-left: 5px solid #1e3c72;
            transition: all 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .summary-card.alert {
            border-left-color: #dc3545;
        }

        .summary-card.warning {
            border-left-color: #ffc107;
        }

        .summary-card.success {
            border-left-color: #28a745;
        }

        .summary-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .summary-card.alert .summary-value {
            color: #dc3545;
        }

        .summary-card.warning .summary-value {
            color: #ffc107;
        }

        .summary-card.success .summary-value {
            color: #28a745;
        }

        .summary-label {
            font-size: 0.9em;
            color: #666;
            font-weight: 500;
        }

        /* Card */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px 25px;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h3 {
            font-size: 1.25em;
            font-weight: 700;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-body {
            padding: 25px;
        }

        /* Filter Bar */
        .filter-bar {
            background: white;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 200px;
            flex: 1;
        }

        .filter-group label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.95em;
            background: white;
            transition: border-color 0.2s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #1e3c72;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        th {
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        th:last-child {
            border-right: none;
        }

        tbody tr {
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        tbody tr:last-child {
            border-bottom: none;
        }

        td {
            padding: 14px 12px;
            vertical-align: middle;
        }

        td:first-child {
            font-weight: 600;
            color: #1a1a1a;
        }

        /* Result Badges */
        .result-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 700;
            letter-spacing: 0.3px;
        }

        .badge-high {
            background: #fee;
            color: #dc3545;
            border: 1px solid #dc3545;
        }

        .badge-low {
            background: #e3f2fd;
            color: #0066cc;
            border: 1px solid #0066cc;
        }

        .badge-abnormal {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .badge-normal {
            background: #d4edda;
            color: #155724;
            border: 1px solid #28a745;
        }

        .value-high {
            color: #dc3545;
            font-weight: 700;
        }

        .value-low {
            color: #0066cc;
            font-weight: 700;
        }

        /* Status Dropdown */
        .status-dropdown {
            padding: 6px 12px;
            border-radius: 6px;
            border: 2px solid #ddd;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            min-width: 130px;
        }

        .status-dropdown:hover {
            border-color: #1e3c72;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .status-dropdown:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .status-low {
            background: #ffebee;
            border-color: #dc3545;
            color: #dc3545;
        }

        .status-slightly-low {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .status-middle {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .status-slightly-high {
            background: #fff3e0;
            border-color: #ff9800;
            color: #e65100;
        }

        .status-high {
            background: #fce4ec;
            border-color: #e91e63;
            color: #c2185b;
        }

        /* Chart Container */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-card h4 {
            font-size: 1.15em;
            margin-bottom: 20px;
            color: #1a1a1a;
            font-weight: 700;
        }

        /* View Management */
        .view-content {
            display: none;
        }

        .view-content.active {
            display: block;
        }

        /* Loading & Empty States */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 1.1em;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        /* Result Groups */
        .result-section {
            margin-bottom: 30px;
        }

        .section-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px 6px 0 0;
            font-weight: 600;
            font-size: 1.05em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 6px 6px;
            overflow: hidden;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                min-height: auto;
            }

            .nav-section {
                display: inline-block;
                margin-bottom: 0;
                margin-right: 15px;
            }

            .nav-item {
                display: inline-block;
                border-left: none;
                border-bottom: 4px solid transparent;
            }

            .nav-item.active {
                border-left: none;
                border-bottom-color: #1e3c72;
            }

            .content-area {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }

            .top-nav h1 {
                font-size: 1.2em;
            }

            .patient-name {
                font-size: 1.5em;
            }

            .page-header h2 {
                font-size: 1.5em;
            }
        }

        /* Column Visibility Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            margin: 0;
            color: #1e3c72;
            font-size: 1.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .column-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            user-select: none;
            font-size: 0.95rem;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .hidden-column {
            display: none !important;
        }

        /* Icon Selector */
        .icon-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.5rem;
        }

        .icon-option:hover {
            border-color: #1e3c72;
            background: #f8f9fa;
        }

        .icon-option.selected {
            border-color: #1e3c72;
            background: #1e3c72;
            color: white;
        }

        /* Test Selection List */
        .test-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .test-item:hover {
            background: #f8f9fa;
        }

        .test-item input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .test-item label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        /* Custom View Card */
        .custom-view-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }

        .custom-view-card:hover {
            border-color: #1e3c72;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .custom-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .custom-view-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3c72;
        }

        .custom-view-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .custom-view-meta {
            color: #666;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        /* Mini Inline Charts */
        .mini-chart-cell {
            position: relative;
            min-width: 180px;
            padding: 8px !important;
        }

        .mini-chart-container {
            width: 100%;
            height: 60px;
            position: relative;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mini-chart-container:hover {
            background: #e9ecef;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mini-chart-svg {
            width: 100%;
            height: 50px;
        }

        .mini-chart-point {
            cursor: pointer;
            transition: r 0.2s;
        }

        .mini-chart-point:hover {
            r: 6 !important;
        }

        .mini-chart-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .mini-chart-label {
            font-size: 0.7rem;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }

        .chart-trend-up {
            color: #28a745;
        }

        .chart-trend-down {
            color: #dc3545;
        }

        .chart-trend-stable {
            color: #6c757d;
        }

        /* Slide-in Panel Styles */
        .test-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            backdrop-filter: blur(3px);
        }

        .test-detail-overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .test-detail-panel {
            position: fixed;
            top: 0;
            right: -95%;
            width: 95%;
            height: 100%;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
        }

        .test-detail-panel.active {
            right: 0;
        }

        .test-detail-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
        }

        .test-detail-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: white;
        }

        .panel-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 1;
        }

        .panel-close-btn:hover {
            background: #e0e0e0;
            color: #333;
            transform: scale(1.1);
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .test-category {
            margin-bottom: 10px;
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
            margin-bottom: 5px;
        }

        .category-header:hover {
            background: #e8f0fe;
            border-color: #1e3c72;
        }

        .category-header.active {
            background: #e8f0fe;
            border-color: #1e3c72;
            font-weight: 600;
        }

        .category-icon {
            font-size: 1rem;
            margin-right: 8px;
            color: #1e3c72;
            transition: transform 0.2s;
        }

        .category-icon.expanded {
            transform: rotate(90deg);
        }

        .category-name {
            flex: 1;
            font-size: 0.95rem;
            color: #333;
        }

        .test-count {
            font-size: 0.75rem;
            background: #1e3c72;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .test-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-left: 20px;
        }

        .test-list.expanded {
            max-height: 1000px;
        }

        .test-item-link {
            display: block;
            padding: 8px 12px;
            color: #555;
            text-decoration: none;
            font-size: 0.9rem;
            border-radius: 4px;
            transition: all 0.2s;
            margin-bottom: 3px;
        }

        .test-item-link:hover {
            background: #e8f0fe;
            color: #1e3c72;
            padding-left: 16px;
        }

        .test-item-link.active {
            background: #1e3c72;
            color: white;
            font-weight: 500;
        }

        .chart-container-detail {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .chart-header-detail {
            margin-bottom: 20px;
        }

        .chart-title-detail {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 8px;
        }

        .chart-subtitle-detail {
            font-size: 1.1rem;
            color: #666;
        }

        .chart-canvas-wrapper {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }

        .data-table-toggle {
            text-align: center;
            margin-top: 30px;
        }

        .data-table-btn {
            background: none;
            border: none;
            color: #ff6b35;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .data-table-btn:hover {
            background: #fff3f0;
        }

        .data-table-btn i {
            transition: transform 0.2s;
        }

        .data-table-btn i.rotated {
            transform: rotate(180deg);
        }

        .detail-data-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            display: none;
        }

        .detail-data-table.visible {
            display: table;
        }

        .detail-data-table th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        .detail-data-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-data-table tr:hover {
            background: #f8f9fa;
        }

        #tableToggleIcon {
            transition: transform 0.3s ease;
        }

        #tableToggleIcon.rotated {
            transform: rotate(180deg);
        }

        /* Highlighted row when clicking a chart point */
        .highlight-row {
            background: rgba(255, 235, 59, 0.2); /* soft yellow */
            transition: background 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <div class="top-nav">
        <h1><i class="fas fa-hospital"></i> MyHealth Portal</h1>
        <div class="datetime" id="currentDateTime"></div>
    </div>

    <!-- Patient Banner -->
    <div class="patient-banner">
        <div class="patient-name">
            <span id="patientName">Loading...</span>
            <button class="toggle-btn" onclick="togglePatientInfo()">
                <i class="fas fa-chevron-down" id="toggleIcon"></i>
                <span id="toggleText">Details</span>
            </button>
        </div>
        
        <div class="collapsible-content collapsed" id="patientInfo">
            <div class="patient-info-grid">
                <div class="info-item"><strong>DOB:</strong> <span id="patientDOB">Loading...</span></div>
                <div class="info-item"><strong>Age:</strong> <span id="patientAge">Loading...</span></div>
                <div class="info-item"><strong>Gender:</strong> <span id="patientGender">Loading...</span></div>
                <div class="info-item"><strong>MRN:</strong> <span>ZK-031994</span></div>
                <div class="info-item"><strong>Ethnicity:</strong> <span id="patientEthnicity">Loading...</span></div>
                <div class="info-item"><strong>Total Lab Tests:</strong> <span id="totalTests">Loading...</span></div>
            </div>
        </div>

        <div class="alert-banner" id="alertBanner" style="display:none;">
            <h4 style="cursor: pointer;" onclick="toggleAlerts()">
                <i class="fas fa-exclamation-triangle"></i> 
                Active Health Alerts 
                <i class="fas fa-chevron-down" id="alertToggleIcon" style="font-size: 0.8em; margin-left: 8px;"></i>
            </h4>
            <div class="alert-list" id="alertList"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="nav-section">
                <div class="nav-section-title">Health Records</div>
                <div class="nav-item active" onclick="showView('overview')">
                    <i class="fas fa-home"></i> Overview
                </div>
                <div class="nav-item" onclick="showView('trends-analysis')">
                    <i class="fas fa-chart-area"></i> Trends Analysis
                </div>
                <div class="nav-item" onclick="showView('all-results')">
                    <i class="fas fa-flask"></i> All Lab Results
                </div>
                <div class="nav-item" onclick="showView('trends')">
                    <i class="fas fa-chart-line"></i> Trends & Charts
                </div>
                <div class="nav-item" onclick="showView('flagged')">
                    <i class="fas fa-flag"></i> Flagged Tests
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">My Interpretations</div>
                <div class="nav-item" onclick="showView('my-high')">
                    <i class="fas fa-arrow-up"></i> My High Tests
                </div>
                <div class="nav-item" onclick="showView('my-low')">
                    <i class="fas fa-arrow-down"></i> My Low Tests
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Test Categories</div>
                <div class="nav-item" onclick="showView('metabolic')">
                    <i class="fas fa-heartbeat"></i> Metabolic Panel
                </div>
                <div class="nav-item" onclick="showView('lipid')">
                    <i class="fas fa-droplet"></i> Lipid Panel
                </div>
                <div class="nav-item" onclick="showView('thyroid')">
                    <i class="fas fa-user-md"></i> Thyroid Function
                </div>
                <div class="nav-item" onclick="showView('cbc')">
                    <i class="fas fa-syringe"></i> Complete Blood Count
                </div>
                <div class="nav-item" onclick="showView('kidney')">
                    <i class="fas fa-kidneys"></i> Kidney Function
                </div>
                <div class="nav-item" onclick="showView('liver')">
                    <i class="fas fa-liver"></i> Liver Function
                </div>
                <div class="nav-item" onclick="showView('vitamins')">
                    <i class="fas fa-pills"></i> Vitamins & Nutrients
                </div>
                <div class="nav-item" onclick="showView('inflammation')">
                    <i class="fas fa-fire"></i> Inflammation
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Zain's Research</div>
                <div class="nav-item" onclick="showView('research-fatigue')">
                    <i class="fas fa-battery-quarter"></i> Fatigue/Energy
                </div>
                <div class="nav-item" onclick="showView('research-mood')">
                    <i class="fas fa-cloud-sun"></i> Depression/Mood
                </div>
                <div class="nav-item" onclick="showView('research-anxiety')">
                    <i class="fas fa-heart-pulse"></i> Anxiety/Stress
                </div>
                <div class="nav-item" onclick="showView('research-muscle')">
                    <i class="fas fa-dumbbell"></i> Muscle Weakness
                </div>
                <div class="nav-item" onclick="showView('research-hairloss')">
                    <i class="fas fa-head-side-medical"></i> Hair Loss
                </div>
                <div class="nav-item" onclick="showView('research-heart')">
                    <i class="fas fa-heart"></i> Heart Health
                </div>
                <div class="nav-item" onclick="showView('research-cognitive')">
                    <i class="fas fa-brain"></i> Cognitive Function
                </div>
                <div class="nav-item" onclick="showView('research-bone')">
                    <i class="fas fa-bone"></i> Bone Health
                </div>
                <div class="nav-item" onclick="showView('research-inflammation')">
                    <i class="fas fa-fire-flame-curved"></i> Inflammation
                </div>
                <div class="nav-item" onclick="showView('research-sleep')">
                    <i class="fas fa-bed"></i> Sleep Issues
                </div>
                <div class="nav-item" onclick="showView('custom-views')" style="border-top: 2px solid #e0e0e0; margin-top: 10px; padding-top: 10px;">
                    <i class="fas fa-plus-circle"></i> My Custom Views
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Organ Systems</div>
                <div class="nav-item" onclick="showView('system-circulatory')">
                    <i class="fas fa-heart-pulse"></i> Circulatory
                </div>
                <div class="nav-item" onclick="showView('system-endocrine')">
                    <i class="fas fa-gland"></i> Endocrine
                </div>
                <div class="nav-item" onclick="showView('system-digestive')">
                    <i class="fas fa-stomach"></i> Digestive/Liver
                </div>
                <div class="nav-item" onclick="showView('system-urinary')">
                    <i class="fas fa-kidneys"></i> Urinary/Kidney
                </div>
                <div class="nav-item" onclick="showView('system-immune')">
                    <i class="fas fa-shield-virus"></i> Immune/Lymphatic
                </div>
                <div class="nav-item" onclick="showView('system-skeletal')">
                    <i class="fas fa-bone"></i> Skeletal
                </div>
                <div class="nav-item" onclick="showView('system-nervous')">
                    <i class="fas fa-brain"></i> Nervous
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Additional</div>
                <div class="nav-item" onclick="showView('medications')">
                    <i class="fas fa-prescription-bottle"></i> Medications
                </div>
                <div class="nav-item" onclick="showView('diagnoses')">
                    <i class="fas fa-notes-medical"></i> Diagnoses
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Overview View -->
            <div id="view-overview" class="view-content active">
                <div class="page-header">
                    <h2><i class="fas fa-home"></i> Health Overview</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportAllData()">
                            <i class="fas fa-download"></i> Export All
                        </button>
                        <button class="btn btn-outline" onclick="window.print()">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                </div>

                <!-- Alert Cards (Always Visible) -->
                <div class="summary-grid" id="alertCardsGrid"></div>

                <!-- Stats Section (Collapsible) -->
                <div style="margin: 25px 0;">
                    <button class="toggle-btn" onclick="toggleStats()" style="width: 100%; justify-content: center; font-size: 1em;">
                        <i class="fas fa-chart-bar"></i>
                        <span id="statsToggleText">Show Statistics</span>
                        <i class="fas fa-chevron-down" id="statsToggleIcon"></i>
                    </button>
                </div>
                <div class="collapsible-content collapsed" id="statsSection">
                    <div class="summary-grid" id="statsGrid"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-clock"></i> Recent Lab Results (Last 6 Months)</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="recentResultsTable">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Date</th>
                                        <th>Result</th>
                                        <th>Reference Range</th>
                                        <th>Status</th>
                                        <th>Lab</th>
                                    </tr>
                                </thead>
                                <tbody id="recentResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-exclamation-circle"></i> Abnormal Results</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table id="abnormalResultsTable">
                                <thead>
                                    <tr>
                                        <th>Test Name</th>
                                        <th>Date</th>
                                        <th>Result</th>
                                        <th>Reference Range</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="abnormalResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Analysis View -->
            <div id="view-trends-analysis" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-chart-area"></i> Trends Analysis</h2>
                    <p style="color: #666; margin-top: 8px;">Select a test from the sidebar to view detailed trends and historical data</p>
                </div>

                <div style="display: flex; gap: 0; height: calc(100vh - 200px); margin: 0 -30px;">
                    <!-- Left Sidebar - Test Categories -->
                    <div style="width: 300px; background: #f8f9fa; border-right: 2px solid #e0e0e0; overflow-y: auto; padding: 20px;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-flask"></i> Lab Tests
                        </div>
                        <div id="trendsAnalysisCategoriesList"></div>
                    </div>
                    
                    <!-- Right Content - Chart Display -->
                    <div style="flex: 1; overflow-y: auto; padding: 30px; background: white;">
                        <div id="trendsAnalysisChartContainer">
                            <div style="text-align: center; padding: 100px 20px; color: #999;">
                                <i class="fas fa-chart-line" style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;"></i>
                                <h3 style="color: #666; font-weight: 400;">Select a test from the sidebar to view trends</h3>
                                <p style="margin-top: 10px;">Click on any test category to expand and choose a specific lab test</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Lab Results View -->
            <div id="view-all-results" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-flask"></i> Complete Lab Results</h2>
                    <div class="action-bar">
                        <button class="btn btn-outline" onclick="openColumnVisibilityModal()" style="margin-right: 10px;">
                            <i class="fas fa-columns"></i> Columns
                        </button>
                        <button class="btn btn-primary" onclick="saveInterpretations()" style="margin-right: 10px;">
                            <i class="fas fa-save"></i> Save Interpretations
                        </button>
                        <button class="btn btn-success" onclick="exportFilteredData()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Search Test Name</label>
                        <input type="text" id="searchInput" placeholder="Type to search..." onkeyup="filterAllResults()">
                    </div>
                    <div class="filter-group">
                        <label>Laboratory</label>
                        <select id="labFilter" onchange="filterAllResults()">
                            <option value="">All Labs</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Result Status</label>
                        <select id="flagFilter" onchange="filterAllResults()">
                            <option value="">All Results</option>
                            <option value="High">High</option>
                            <option value="Low">Low</option>
                            <option value="Abnormal">Abnormal</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Date Range</label>
                        <select id="dateFilter" onchange="filterAllResults()">
                            <option value="">All Time</option>
                            <option value="90">Last 3 Months</option>
                            <option value="180">Last 6 Months</option>
                            <option value="365">Last Year</option>
                        </select>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table id="allResultsTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> ⇅</th>
                                        <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name ⇅</th>
                                        <th onclick="sortTable('collected')" style="cursor: pointer;">Collected ⇅</th>
                                        <th onclick="sortTable('result')" style="cursor: pointer;">Result ⇅</th>
                                        <th><i class="fas fa-chart-line"></i> Trend</th>
                                        <th>Units</th>
                                        <th>Reference Range</th>
                                        <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint ⇅</th>
                                        <th>Flag</th>
                                        <th onclick="sortTable('status')" style="cursor: pointer;">Status ⇅</th>
                                        <th onclick="sortTable('lab')" style="cursor: pointer;">Lab ⇅</th>
                                        <th onclick="sortTable('panel')" style="cursor: pointer;">Panel ⇅</th>
                                        <th onclick="sortTable('category')" style="cursor: pointer;">Category ⇅</th>
                                        <th onclick="sortTable('physician')" style="cursor: pointer;">Physician ⇅</th>
                                        <th onclick="sortTable('reported')" style="cursor: pointer;">Reported ⇅</th>
                                        <th>Source</th>
                                        <th>Specimen ID</th>
                                        <th>Fasting</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="allResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends View -->
            <div id="view-trends" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-chart-line"></i> Health Trends & Analysis</h2>
                </div>
                <div class="chart-grid" id="chartsContainer"></div>
            </div>

            <!-- Flagged Tests View -->
            <div id="view-flagged" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-flag"></i> Flagged Tests</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportFlaggedTests()">
                            <i class="fas fa-download"></i> Export Flagged
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="flaggedTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- My High Tests View -->
            <div id="view-my-high" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-arrow-up"></i> My High Test Interpretations</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportMyInterpretations('high')">
                            <i class="fas fa-download"></i> Export High Tests
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="myHighTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- My Low Tests View -->
            <div id="view-my-low" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-arrow-down"></i> My Low Test Interpretations</h2>
                    <div class="action-bar">
                        <button class="btn btn-success" onclick="exportMyInterpretations('low')">
                            <i class="fas fa-download"></i> Export Low Tests
                        </button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <div class="table-container" id="myLowTableContainer"></div>
                    </div>
                </div>
            </div>

            <!-- Category Views (will be populated dynamically) -->
            <div id="view-metabolic" class="view-content"></div>
            <div id="view-lipid" class="view-content"></div>
            <div id="view-thyroid" class="view-content"></div>
            <div id="view-cbc" class="view-content"></div>
            <div id="view-kidney" class="view-content"></div>
            <div id="view-liver" class="view-content"></div>
            <div id="view-vitamins" class="view-content"></div>
            <div id="view-inflammation" class="view-content"></div>

            <!-- Organ System Views (will be populated dynamically) -->
            <div id="view-system-circulatory" class="view-content"></div>
            <div id="view-system-endocrine" class="view-content"></div>
            <div id="view-system-digestive" class="view-content"></div>
            <div id="view-system-urinary" class="view-content"></div>
            <div id="view-system-immune" class="view-content"></div>
            <div id="view-system-skeletal" class="view-content"></div>
            <div id="view-system-nervous" class="view-content"></div>

            <!-- Research Template Views (will be populated dynamically) -->
            <div id="view-research-fatigue" class="view-content"></div>
            <div id="view-research-mood" class="view-content"></div>
            <div id="view-research-anxiety" class="view-content"></div>
            <div id="view-research-muscle" class="view-content"></div>
            <div id="view-research-hairloss" class="view-content"></div>
            <div id="view-research-heart" class="view-content"></div>
            <div id="view-research-cognitive" class="view-content"></div>
            <div id="view-research-bone" class="view-content"></div>
            <div id="view-research-inflammation" class="view-content"></div>
            <div id="view-research-sleep" class="view-content"></div>

            <!-- Custom Views Manager -->
            <div id="view-custom-views" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-plus-circle"></i> My Custom Research Views</h2>
                    <div class="action-bar">
                        <button class="btn btn-primary" onclick="createCustomView()">
                            <i class="fas fa-plus"></i> Create New View
                        </button>
                    </div>
                </div>
                <div id="customViewsList"></div>
            </div>

            <!-- Medications View -->
            <div id="view-medications" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-prescription-bottle"></i> Current Medications</h2>
                </div>
                <div id="medicationsContent"></div>
            </div>

            <!-- Diagnoses View -->
            <div id="view-diagnoses" class="view-content">
                <div class="page-header">
                    <h2><i class="fas fa-notes-medical"></i> Active Diagnoses</h2>
                </div>
                <div id="diagnosesContent"></div>
            </div>
        </div>
    </div>

    <script>
        let healthData = null;
        let allLabResults = [];
        let filteredResults = [];

        // Update current date/time
        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Column Visibility Management
        let visibleColumns = {};
        const allColumns = [
            { id: 'bookmark', name: 'Bookmark', alwaysShow: false },
            { id: 'testName', name: 'Test Name', alwaysShow: true },
            { id: 'collected', name: 'Collected', alwaysShow: false },
            { id: 'result', name: 'Result', alwaysShow: true },
            { id: 'chart', name: 'Trend Chart', alwaysShow: false },
            { id: 'units', name: 'Units', alwaysShow: false },
            { id: 'referenceRange', name: 'Reference Range', alwaysShow: false },
            { id: 'midpoint', name: 'Midpoint', alwaysShow: false },
            { id: 'flag', name: 'Flag', alwaysShow: false },
            { id: 'status', name: 'Status', alwaysShow: false },
            { id: 'lab', name: 'Lab', alwaysShow: false },
            { id: 'panel', name: 'Panel', alwaysShow: false },
            { id: 'category', name: 'Category', alwaysShow: false },
            { id: 'physician', name: 'Physician', alwaysShow: false },
            { id: 'reported', name: 'Reported', alwaysShow: false },
            { id: 'source', name: 'Source', alwaysShow: false },
            { id: 'specimenID', name: 'Specimen ID', alwaysShow: false },
            { id: 'fasting', name: 'Fasting', alwaysShow: false },
            { id: 'notes', name: 'Notes', alwaysShow: false }
        ];

        function loadColumnVisibility() {
            const saved = localStorage.getItem('healthDashboardColumns');
            if (saved) {
                try {
                    visibleColumns = JSON.parse(saved);
                    // Ensure new columns default to visible
                    allColumns.forEach(col => {
                        if (visibleColumns[col.id] === undefined) {
                            visibleColumns[col.id] = true;
                        }
                    });
                } catch (e) {
                    // Default: show all columns
                    visibleColumns = {};
                    allColumns.forEach(col => visibleColumns[col.id] = true);
                }
            } else {
                // Default: show all columns
                allColumns.forEach(col => visibleColumns[col.id] = true);
            }
        }

        function saveColumnVisibility() {
            localStorage.setItem('healthDashboardColumns', JSON.stringify(visibleColumns));
        }

        function openColumnVisibilityModal() {
            const modal = document.getElementById('columnModal');
            const checkboxContainer = document.getElementById('columnCheckboxes');
            
            checkboxContainer.innerHTML = allColumns.map(col => `
                <div class="checkbox-item">
                    <input type="checkbox" 
                           id="col-${col.id}" 
                           ${visibleColumns[col.id] ? 'checked' : ''}
                           ${col.alwaysShow ? 'disabled' : ''}>
                    <label for="col-${col.id}">${col.name}${col.alwaysShow ? ' (Required)' : ''}</label>
                </div>
            `).join('');
            
            modal.classList.add('active');
        }

        function closeColumnVisibilityModal() {
            document.getElementById('columnModal').classList.remove('active');
        }

        function closeColumnModalOnClickOutside(event) {
            if (event.target.id === 'columnModal') {
                closeColumnVisibilityModal();
            }
        }

        function selectAllColumns() {
            allColumns.forEach(col => {
                visibleColumns[col.id] = true;
                const checkbox = document.getElementById(`col-${col.id}`);
                if (checkbox && !checkbox.disabled) checkbox.checked = true;
            });
        }

        function deselectAllColumns() {
            allColumns.forEach(col => {
                if (!col.alwaysShow) {
                    visibleColumns[col.id] = false;
                    const checkbox = document.getElementById(`col-${col.id}`);
                    if (checkbox) checkbox.checked = false;
                }
            });
        }

        function applyColumnVisibility() {
            // Update visibility settings from checkboxes
            allColumns.forEach(col => {
                const checkbox = document.getElementById(`col-${col.id}`);
                if (checkbox && !checkbox.disabled) {
                    visibleColumns[col.id] = checkbox.checked;
                }
            });
            
            saveColumnVisibility();
            closeColumnVisibilityModal();
            
            // Re-render current view
            const currentView = document.querySelector('.view-content.active');
            if (currentView) {
                const viewId = currentView.id.replace('view-', '');
                if (viewId === 'all-results') {
                    populateAllResults();
                }
            }
            
            // Apply column classes after re-rendering to ensure cells are hidden
            applyColumnClasses();
        }

        function applyColumnClasses() {
            // Apply hidden-column class to all table headers and cells
            document.querySelectorAll('table').forEach(table => {
                allColumns.forEach((col, index) => {
                    const headers = table.querySelectorAll(`thead th:nth-child(${index + 1})`);
                    const cells = table.querySelectorAll(`tbody td:nth-child(${index + 1})`);
                    
                    headers.forEach(header => {
                        if (visibleColumns[col.id]) {
                            header.classList.remove('hidden-column');
                        } else {
                            header.classList.add('hidden-column');
                        }
                    });
                    
                    cells.forEach(cell => {
                        if (visibleColumns[col.id]) {
                            cell.classList.remove('hidden-column');
                        } else {
                            cell.classList.add('hidden-column');
                        }
                    });
                });
            });
        }

        // Load data
        async function loadData() {
            try {
                const response = await fetch('health_data_database.json');
                healthData = await response.json();
                initializeDashboard();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Error loading health data. Please make sure the server is running.');
            }
        }

        function initializeDashboard() {
            // Load saved custom statuses from localStorage
            const savedStatuses = localStorage.getItem('healthDashboardStatuses');
            if (savedStatuses) {
                try {
                    customStatuses = JSON.parse(savedStatuses);
                } catch (e) {
                    console.error('Error loading saved statuses:', e);
                    customStatuses = {};
                }
            }

            // Load saved bookmarks from localStorage
            loadBookmarks();

            // Load column visibility settings
            loadColumnVisibility();

            // Load custom views from localStorage
            loadCustomViews();

            // Update patient info
            document.getElementById('patientName').textContent = healthData.patient.name;
            document.getElementById('patientDOB').textContent = formatDate(healthData.patient.dob);
            document.getElementById('patientAge').textContent = `${healthData.patient.age} years`;
            document.getElementById('patientGender').textContent = healthData.patient.gender;
            document.getElementById('patientEthnicity').textContent = healthData.patient.ethnicity;

            // Compile all lab results
            compileAllResults();
            document.getElementById('totalTests').textContent = allLabResults.length;

            // Populate lab filter dropdown
            const labs = [...new Set(allLabResults.map(r => r.lab))];
            const labFilter = document.getElementById('labFilter');
            labs.forEach(lab => {
                const option = document.createElement('option');
                option.value = lab;
                option.textContent = lab;
                labFilter.appendChild(option);
            });

            // Show alerts
            showHealthAlerts();

            // Populate views
            populateSummaryCards();
            populateRecentResults();
            populateAbnormalResults();
            populateAllResults();
            populateCategoryViews();
            populateOrganSystemViews();
            populateResearchViews();
            populateCustomViewsList();
            populateMedications();
            populateDiagnoses();
            createCharts();
            
            // Apply column visibility after all tables are populated
            applyColumnClasses();
        }

        // Toggle functions
        function togglePatientInfo() {
            const content = document.getElementById('patientInfo');
            const icon = document.getElementById('toggleIcon');
            const text = document.getElementById('toggleText');
            
            content.classList.toggle('collapsed');
            if (content.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'Details';
            } else {
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'Hide';
            }
        }

        function toggleAlerts() {
            const alertList = document.getElementById('alertList');
            const icon = document.getElementById('alertToggleIcon');
            
            if (alertList.style.display === 'none') {
                alertList.style.display = 'flex';
                icon.className = 'fas fa-chevron-down';
            } else {
                alertList.style.display = 'none';
                icon.className = 'fas fa-chevron-right';
            }
        }

        // Storage for custom statuses and bookmarks
        let customStatuses = {};
        let bookmarkedTests = {};
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        // Load bookmarked tests from localStorage
        function loadBookmarks() {
            const saved = localStorage.getItem('healthDashboardBookmarks');
            if (saved) {
                try {
                    bookmarkedTests = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading bookmarks:', e);
                    bookmarkedTests = {};
                }
            }
        }

        // Toggle bookmark for a test
        function toggleBookmark(resultId) {
            bookmarkedTests[resultId] = !bookmarkedTests[resultId];
            localStorage.setItem('healthDashboardBookmarks', JSON.stringify(bookmarkedTests));
            
            // Update display
            const result = allLabResults.find(r => r.id === resultId);
            if (result) {
                result.bookmarked = bookmarkedTests[resultId];
            }
            
            // Re-render current view
            const currentView = document.querySelector('.view-content:not([style*="display: none"])');
            if (currentView) {
                const viewId = currentView.id.replace('view-', '');
                if (viewId === 'all-results') {
                    populateAllResults();
                } else if (viewId === 'flagged') {
                    populateFlaggedTests();
                } else if (viewId === 'my-high') {
                    populateMyHighTests();
                } else if (viewId === 'my-low') {
                    populateMyLowTests();
                }
            }
        }

        function saveInterpretations() {
            // Save current status values as interpretations
            localStorage.setItem('healthDashboardStatuses', JSON.stringify(customStatuses));
            
            // Show confirmation with count
            const highCount = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('high'));
            }).length;
            
            const lowCount = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('low'));
            }).length;
            
            // Show a nice confirmation message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 5px;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000;
                font-weight: 500;
            `;
            message.innerHTML = `
                <i class="fas fa-check-circle"></i> Interpretations Saved!<br>
                <small style="opacity: 0.9;">High: ${highCount} | Low: ${lowCount}</small>
            `;
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function populateMyHighTests() {
            const myHighResults = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('high'));
            });
            
            const container = document.getElementById('myHighTableContainer');
            
            if (myHighResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-arrow-up" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; color: #dc3545;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No high test interpretations yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Go to "All Lab Results" and set tests to "High" or "Slightly High" status</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #dc3545;">
                    <i class="fas fa-arrow-up"></i> 
                    ${myHighResults.length} high test interpretation${myHighResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> ⇅</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name ⇅</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected ⇅</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result ⇅</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint ⇅</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status ⇅</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab ⇅</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel ⇅</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category ⇅</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician ⇅</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported ⇅</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="myHighResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('myHighResultsBody');
            renderResultsTable(myHighResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function populateMyLowTests() {
            const myLowResults = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                return status && (status.includes('low'));
            });
            
            const container = document.getElementById('myLowTableContainer');
            
            if (myLowResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-arrow-down" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; color: #ffc107;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No low test interpretations yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Go to "All Lab Results" and set tests to "Low" or "Slightly Low" status</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #ffc107;">
                    <i class="fas fa-arrow-down"></i> 
                    ${myLowResults.length} low test interpretation${myLowResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> ⇅</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name ⇅</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected ⇅</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result ⇅</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint ⇅</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status ⇅</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab ⇅</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel ⇅</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category ⇅</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician ⇅</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported ⇅</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="myLowResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('myLowResultsBody');
            renderResultsTable(myLowResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function exportMyInterpretations(type) {
            const results = allLabResults.filter(r => {
                const status = r.status && r.status.toLowerCase();
                if (type === 'high') {
                    return status && (status.includes('high'));
                } else {
                    return status && (status.includes('low'));
                }
            });
            
            if (results.length === 0) {
                alert(`No ${type} test interpretations to export`);
                return;
            }

            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported', 
                           'Source', 'Specimen ID', 'Fasting', 'Notes'];
            
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported,
                r.source, r.specimenID, r.fasting, r.notes
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `my_${type}_tests_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function calculateMidpoint(low, high) {
            if (low && high && !isNaN(low) && !isNaN(high)) {
                return ((parseFloat(low) + parseFloat(high)) / 2).toFixed(2);
            }
            return 'N/A';
        }

        function determineStatus(value, low, high, midpoint) {
            if (!value || isNaN(value) || !low || !high || isNaN(low) || isNaN(high)) {
                return 'Middle';
            }
            
            const val = parseFloat(value);
            const lowVal = parseFloat(low);
            const highVal = parseFloat(high);
            const mid = parseFloat(midpoint);
            
            const lowerQuarter = lowVal + (mid - lowVal) / 2;
            const upperQuarter = mid + (highVal - mid) / 2;
            
            if (val < lowVal) return 'Low';
            if (val < lowerQuarter) return 'Slightly Low';
            if (val < upperQuarter) return 'Middle';
            if (val < highVal) return 'Slightly High';
            return 'High';
        }

        function compileAllResults() {
            allLabResults = [];
            
            Object.keys(healthData.lab_results).forEach(testName => {
                const results = healthData.lab_results[testName];
                results.forEach((result, index) => {
                    const midpoint = calculateMidpoint(result.range_low, result.range_high);
                    const resultId = `${testName}_${result.collected || result.date}_${index}`;
                    const autoStatus = determineStatus(result.result || result.value, result.range_low, result.range_high, midpoint);
                    
                    allLabResults.push({
                        id: resultId,
                        bookmarked: bookmarkedTests[resultId] || false,
                        testName: result.test_name ? formatTestName(result.test_name) : formatTestName(testName),
                        collected: result.collected || result.date,
                        result: result.result || result.value,
                        units: result.units || result.unit || 'N/A',
                        refLow: result.range_low,
                        refHigh: result.range_high,
                        midpoint: midpoint,
                        referenceRange: result.reference_range || formatRange(result.range_low, result.range_high),
                        flag: result.flag || '',
                        status: customStatuses[resultId] || autoStatus,
                        lab: result.lab || 'N/A',
                        panel: result.panel || determinePanel(testName),
                        category: result.test_category || determineCategory(testName),
                        physician: result.ordering_physician || 'N/A',
                        reported: result.reported || result.collected || result.date,
                        source: result.source_pdf || determineSource(result.collected || result.date, result.lab),
                        specimenID: result.specimen_id || 'N/A',
                        fasting: result.fasting || 'N/A',
                        notes: result.notes || result.note || '',
                        rawTestName: testName
                    });
                });
            });

            // Sort by date (most recent first)
            allLabResults.sort((a, b) => new Date(b.collected) - new Date(a.collected));
            filteredResults = [...allLabResults];
        }

        function formatTestName(name) {
            return name.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatRange(low, high) {
            if (low && high) return `${low} - ${high}`;
            if (low) return `> ${low}`;
            if (high) return `< ${high}`;
            return 'N/A';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            if (isNaN(date)) return dateStr;
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function determinePanel(testName) {
            const panels = {
                glucose: 'Comprehensive Metabolic Panel',
                bun: 'Comprehensive Metabolic Panel',
                creatinine: 'Comprehensive Metabolic Panel',
                sodium: 'Comprehensive Metabolic Panel',
                potassium: 'Comprehensive Metabolic Panel',
                chloride: 'Comprehensive Metabolic Panel',
                cholesterol_total: 'Lipid Panel',
                hdl_cholesterol: 'Lipid Panel',
                ldl_cholesterol: 'Lipid Panel',
                triglycerides: 'Lipid Panel',
                tsh: 'Thyroid Panel',
                t4_free: 'Thyroid Panel',
                t3_free: 'Thyroid Panel',
                hemoglobin: 'Complete Blood Count',
                wbc: 'Complete Blood Count',
                platelets: 'Complete Blood Count'
            };
            return panels[testName] || 'N/A';
        }

        function determineCategory(testName) {
            const categories = {
                glucose: 'Metabolic',
                hemoglobin_a1c: 'Metabolic',
                bun: 'Renal',
                creatinine: 'Renal',
                egfr: 'Renal',
                cholesterol_total: 'Lipid',
                hdl_cholesterol: 'Lipid',
                ldl_cholesterol: 'Lipid',
                triglycerides: 'Lipid',
                tsh: 'Thyroid',
                t4_free: 'Thyroid',
                t3_free: 'Thyroid',
                alt: 'Hepatic',
                ast: 'Hepatic',
                alkaline_phosphatase: 'Hepatic',
                hemoglobin: 'Hematology',
                wbc: 'Hematology',
                platelets: 'Hematology',
                vitamin_d: 'Vitamins',
                vitamin_b12: 'Vitamins',
                crp: 'Inflammation',
                sed_rate: 'Inflammation'
            };
            return categories[testName] || 'General';
        }

        function determineSource(date, lab) {
            const year = new Date(date).getFullYear();
            if (lab && lab.includes('DLO')) return 'DLO Lab Work.pdf';
            if (lab && lab.includes('LabCorp')) {
                if (year === 2024) return 'Healow 2024 Data.txt';
                if (year === 2025) return 'Healow 2025 Data.txt';
            }
            return 'Medical Records';
        }

        function showHealthAlerts() {
            const alerts = [];
            
            // Check for abnormal results
            allLabResults.forEach(result => {
                if (result.flag && (result.flag.toLowerCase().includes('high') || result.flag.toLowerCase().includes('low'))) {
                    // Only show most recent abnormal for each test
                    if (!alerts.some(a => a.test === result.testName)) {
                        alerts.push({
                            test: result.testName,
                            value: result.result,
                            flag: result.flag,
                            date: result.collected
                        });
                    }
                }
            });

            // Add diagnosis alerts
            healthData.diagnoses.forEach(dx => {
                if (dx.status === 'Active') {
                    alerts.push({
                        test: dx.condition,
                        value: '',
                        flag: 'Active Diagnosis',
                        date: ''
                    });
                }
            });

            if (alerts.length > 0) {
                document.getElementById('alertBanner').style.display = 'block';
                const alertList = document.getElementById('alertList');
                alertList.innerHTML = alerts.slice(0, 8).map(alert => 
                    `<div class="alert-badge">${alert.test}${alert.value ? ': ' + alert.value : ''}</div>`
                ).join('');
            }
        }

        function populateSummaryCards() {
            const alertGrid = document.getElementById('alertCardsGrid');
            const statsGrid = document.getElementById('statsGrid');
            
            // Count results with either flag field OR status field indicating high/low
            const highResults = allLabResults.filter(r => {
                const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                const statusHigh = r.status && r.status.toLowerCase().includes('high');
                return flagHigh || statusHigh;
            }).length;
            
            const lowResults = allLabResults.filter(r => {
                const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                const statusLow = r.status && r.status.toLowerCase().includes('low');
                return flagLow || statusLow;
            }).length;
            
            const normalResults = allLabResults.filter(r => {
                const hasFlag = r.flag && r.flag !== '';
                const statusMiddle = r.status && r.status.toLowerCase() === 'middle';
                const statusNormal = !r.status || r.status === '';
                return (!hasFlag && statusNormal) || statusMiddle;
            }).length;
            
            const recentDate = new Date();
            recentDate.setMonth(recentDate.getMonth() - 6);
            const recentTests = allLabResults.filter(r => new Date(r.collected) >= recentDate).length;

            // Alert Cards (High, Low, Normal results - always visible)
            const alertCards = [
                { value: highResults, label: 'High Results', type: 'alert', action: 'filter-high' },
                { value: lowResults, label: 'Low Results', type: 'warning', action: 'filter-low' },
                { value: normalResults, label: 'Normal Results', type: 'success', action: 'filter-normal' }
            ];

            // Stats Cards (other metrics - collapsible)
            const statsCards = [
                { value: allLabResults.length, label: 'Total Lab Tests', type: '', action: 'all-results' },
                { value: recentTests, label: 'Tests (Last 6 Mo)', type: '', action: 'filter-recent' },
                { value: healthData.diagnoses.length, label: 'Active Diagnoses', type: '', action: 'diagnoses' },
                { value: healthData.medications.length, label: 'Current Medications', type: '', action: 'medications' },
                { value: new Set(allLabResults.map(r => r.lab)).size, label: 'Lab Facilities', type: '', action: 'all-results' }
            ];

            const cardHTML = (card) => `
                <div class="summary-card ${card.type}" onclick="handleCardClick('${card.action}')" style="cursor: pointer; transition: transform 0.2s;" 
                     onmouseover="this.style.transform='translateY(-3px)'" 
                     onmouseout="this.style.transform='translateY(0)'">
                    <div class="summary-value">${card.value}</div>
                    <div class="summary-label">${card.label}</div>
                </div>
            `;

            alertGrid.innerHTML = alertCards.map(cardHTML).join('');
            statsGrid.innerHTML = statsCards.map(cardHTML).join('');
        }

        function toggleStats() {
            const statsSection = document.getElementById('statsSection');
            const icon = document.getElementById('statsToggleIcon');
            const text = document.getElementById('statsToggleText');
            
            statsSection.classList.toggle('collapsed');
            if (statsSection.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-down';
                text.textContent = 'Show Statistics';
            } else {
                icon.className = 'fas fa-chevron-up';
                text.textContent = 'Hide Statistics';
            }
        }

        function handleCardClick(action) {
            switch(action) {
                case 'all-results':
                    showView('all-results');
                    break;
                case 'filter-high':
                    showView('all-results');
                    document.getElementById('flagFilter').value = 'high';
                    filterAllResults();
                    break;
                case 'filter-low':
                    showView('all-results');
                    document.getElementById('flagFilter').value = 'low';
                    filterAllResults();
                    break;
                case 'filter-normal':
                    showView('all-results');
                    document.getElementById('flagFilter').value = '';
                    // Filter for results with no flag
                    const tbody = document.getElementById('allResultsBody');
                    const normalResults = allLabResults.filter(r => !r.flag || r.flag === '');
                    renderResultsTable(normalResults, tbody);
                    // Re-apply column visibility after rendering
                    applyColumnClasses();
                    break;
                case 'filter-recent':
                    showView('all-results');
                    document.getElementById('dateFilter').value = '180';
                    filterAllResults();
                    break;
                case 'diagnoses':
                    showView('diagnoses');
                    break;
                case 'medications':
                    showView('medications');
                    break;
            }
        }

        function populateRecentResults() {
            const tbody = document.getElementById('recentResultsBody');
            const sixMonthsAgo = new Date();
            sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
            
            const recent = allLabResults.filter(r => new Date(r.collected) >= sixMonthsAgo).slice(0, 20);
            
            tbody.innerHTML = recent.map(r => `
                <tr>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result} ${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                    <td>${r.lab}</td>
                </tr>
            `).join('');
        }

        function populateAbnormalResults() {
            const tbody = document.getElementById('abnormalResultsBody');
            const abnormal = allLabResults.filter(r => r.flag && r.flag !== '');
            
            tbody.innerHTML = abnormal.slice(0, 15).map(r => `
                <tr>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low'}">${r.result} ${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td><span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span></td>
                </tr>
            `).join('');
        }

        function changeStatus(resultId, newStatus) {
            customStatuses[resultId] = newStatus;
            // Save to localStorage for persistence
            localStorage.setItem('healthDashboardStatuses', JSON.stringify(customStatuses));
            
            // Update the display
            const result = allLabResults.find(r => r.id === resultId);
            if (result) {
                result.status = newStatus;
            }
            
            // Update summary cards to reflect new counts
            populateSummaryCards();
            
            // Re-render current view
            const currentView = document.querySelector('.view-content.active');
            if (currentView) {
                const viewId = currentView.id.replace('view-', '');
                if (viewId === 'all-results') {
                    populateAllResults();
                } else if (viewId === 'my-high') {
                    populateMyHighTests();
                } else if (viewId === 'my-low') {
                    populateMyLowTests();
                } else if (viewId === 'flagged') {
                    populateFlaggedTests();
                }
            }
        }

        function createMiniChart(testName) {
            // Get all results for this test
            const testResults = allLabResults.filter(r => r.testName === testName).sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            if (testResults.length < 2) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem;">Not enough data</div>';
            }

            // Extract numeric values and dates
            const values = testResults.map(r => {
                const val = parseFloat(r.result);
                return isNaN(val) ? null : val;
            }).filter(v => v !== null);

            if (values.length < 2) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem;">No numeric data</div>';
            }

            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const range = maxVal - minVal || 1;
            
            // Get reference range from first result
            const refLow = testResults[0].rangeLow;
            const refHigh = testResults[0].rangeHigh;
            
            const width = 160;
            const height = 50;
            const padding = 5;
            
            // Create SVG points
            const points = testResults.map((r, i) => {
                const val = parseFloat(r.result);
                if (isNaN(val)) return null;
                
                const x = padding + (i / (testResults.length - 1)) * (width - 2 * padding);
                const y = height - padding - ((val - minVal) / range) * (height - 2 * padding);
                
                // Determine color based on reference range
                let color = '#1e3c72';
                if (refLow && refHigh) {
                    if (val < refLow) color = '#ffc107';
                    else if (val > refHigh) color = '#dc3545';
                    else color = '#28a745';
                }
                
                return { x, y, val, date: r.collected, color };
            }).filter(p => p !== null);

            // Create reference range zone
            let refZone = '';
            if (refLow && refHigh && minVal < refHigh && maxVal > refLow) {
                const yLow = height - padding - ((refLow - minVal) / range) * (height - 2 * padding);
                const yHigh = height - padding - ((refHigh - minVal) / range) * (height - 2 * padding);
                refZone = `<rect x="${padding}" y="${yHigh}" width="${width - 2 * padding}" height="${yLow - yHigh}" fill="#28a745" opacity="0.1"/>`;
            }

            // Create line path
            const pathData = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x},${p.y}`).join(' ');
            
            // Calculate trend
            const firstVal = values[0];
            const lastVal = values[values.length - 1];
            const trendPercent = ((lastVal - firstVal) / firstVal * 100).toFixed(1);
            const trendClass = lastVal > firstVal ? 'chart-trend-up' : lastVal < firstVal ? 'chart-trend-down' : 'chart-trend-stable';
            const trendIcon = lastVal > firstVal ? '↗' : lastVal < firstVal ? '↘' : '→';

            return `
                <div class="mini-chart-container" onclick="showTestDetail('${testName}')">
                    <svg class="mini-chart-svg" viewBox="0 0 ${width} ${height}">
                        ${refZone}
                        <path d="${pathData}" fill="none" stroke="#1e3c72" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        ${points.map(p => `
                            <circle cx="${p.x}" cy="${p.y}" r="4" fill="${p.color}" class="mini-chart-point" 
                                    onmouseover="showMiniTooltip(event, '${formatDate(p.date)}', '${p.val}')"
                                    onmouseout="hideMiniTooltip()"/>
                        `).join('')}
                    </svg>
                    <div class="mini-chart-label">
                        <span class="${trendClass}">${trendIcon} ${Math.abs(trendPercent)}%</span> | ${testResults.length} tests
                    </div>
                </div>
            `;
        }

        function showMiniTooltip(event, date, value) {
            let tooltip = document.getElementById('miniChartTooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.id = 'miniChartTooltip';
                tooltip.className = 'mini-chart-tooltip';
                document.body.appendChild(tooltip);
            }
            
            tooltip.innerHTML = `<strong>${date}</strong><br>${value}`;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 40) + 'px';
        }

        function hideMiniTooltip() {
            const tooltip = document.getElementById('miniChartTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        function showTestDetail(testName) {
            // Open the detail panel for this test
            openTestDetailPanel(testName);
        }

        function renderResultsTable(results, tbody) {
            tbody.innerHTML = results.map(r => `
                <tr>
                    <td style="text-align: center;">
                        <i class="fas fa-flag" 
                           onclick="toggleBookmark('${r.id}')" 
                           style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'}; font-size: 1.2em; transition: color 0.2s;"
                           onmouseover="this.style.opacity='0.7'"
                           onmouseout="this.style.opacity='1'"></i>
                    </td>
                    <td><strong>${r.testName}</strong></td>
                    <td>${formatDate(r.collected)}</td>
                    <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                    <td class="mini-chart-cell">${createMiniChart(r.testName)}</td>
                    <td>${r.units}</td>
                    <td>${r.referenceRange}</td>
                    <td><strong>${r.midpoint}</strong></td>
                    <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : ''}</td>
                    <td>
                        <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                onchange="changeStatus('${r.id}', this.value)">
                            <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                            <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                            <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                            <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                        </select>
                    </td>
                    <td>${r.lab}</td>
                    <td>${r.panel}</td>
                    <td>${r.category}</td>
                    <td>${r.physician}</td>
                    <td>${formatDate(r.reported)}</td>
                    <td>${r.source}</td>
                    <td>${r.specimenID}</td>
                    <td>${r.fasting}</td>
                    <td>${r.notes}</td>
                </tr>
            `).join('');
        }

        // Sort table function
        function sortTable(column) {
            // Toggle direction if same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            const sortedResults = [...allLabResults].sort((a, b) => {
                let valA, valB;
                
                switch(column) {
                    case 'bookmark':
                        valA = a.bookmarked ? 1 : 0;
                        valB = b.bookmarked ? 1 : 0;
                        break;
                    case 'testName':
                        valA = a.testName.toLowerCase();
                        valB = b.testName.toLowerCase();
                        break;
                    case 'collected':
                    case 'reported':
                        valA = new Date(a[column]);
                        valB = new Date(b[column]);
                        break;
                    case 'result':
                    case 'midpoint':
                        valA = parseFloat(a[column]) || 0;
                        valB = parseFloat(b[column]) || 0;
                        break;
                    default:
                        valA = (a[column] || '').toString().toLowerCase();
                        valB = (b[column] || '').toString().toLowerCase();
                }

                if (valA < valB) return currentSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(sortedResults, tbody);
            
            // Re-apply column visibility after sorting
            applyColumnClasses();
        }

        function populateAllResults() {
            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(allLabResults, tbody);
        }

        function populateFlaggedTests() {
            const flaggedResults = allLabResults.filter(r => r.bookmarked);
            const container = document.getElementById('flaggedTableContainer');
            
            if (flaggedResults.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <i class="fas fa-flag" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p style="font-size: 1.2rem; margin: 0;">No tests flagged yet</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click the flag icon on any test to bookmark it</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 1rem; font-weight: 500; color: #666;">
                    <i class="fas fa-flag" style="color: #ffc107;"></i> 
                    ${flaggedResults.length} flagged test${flaggedResults.length === 1 ? '' : 's'}
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortTable('bookmark')" style="cursor: pointer;"><i class="fas fa-flag"></i> ⇅</th>
                                <th onclick="sortTable('testName')" style="cursor: pointer;">Test Name ⇅</th>
                                <th onclick="sortTable('collected')" style="cursor: pointer;">Collected ⇅</th>
                                <th onclick="sortTable('result')" style="cursor: pointer;">Result ⇅</th>
                                <th><i class="fas fa-chart-line"></i> Trend</th>
                                <th>Units</th>
                                <th>Reference Range</th>
                                <th onclick="sortTable('midpoint')" style="cursor: pointer;">Midpoint ⇅</th>
                                <th>Flag</th>
                                <th onclick="sortTable('status')" style="cursor: pointer;">Status ⇅</th>
                                <th onclick="sortTable('lab')" style="cursor: pointer;">Lab ⇅</th>
                                <th onclick="sortTable('panel')" style="cursor: pointer;">Panel ⇅</th>
                                <th onclick="sortTable('category')" style="cursor: pointer;">Category ⇅</th>
                                <th onclick="sortTable('physician')" style="cursor: pointer;">Physician ⇅</th>
                                <th onclick="sortTable('reported')" style="cursor: pointer;">Reported ⇅</th>
                                <th>Source</th>
                                <th>Specimen ID</th>
                                <th>Fasting</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="flaggedResultsBody"></tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('flaggedResultsBody');
            renderResultsTable(flaggedResults, tbody);
            
            // Re-apply column visibility after rendering
            applyColumnClasses();
        }

        function exportFlaggedTests() {
            const flaggedResults = allLabResults.filter(r => r.bookmarked);
            
            if (flaggedResults.length === 0) {
                alert('No flagged tests to export');
                return;
            }

            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported', 
                           'Source', 'Specimen ID', 'Fasting', 'Notes'];
            
            const rows = flaggedResults.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported,
                r.source, r.specimenID, r.fasting, r.notes
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `flagged_lab_tests_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function filterAllResults() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const lab = document.getElementById('labFilter').value;
            const flag = document.getElementById('flagFilter').value;
            const dateRange = parseInt(document.getElementById('dateFilter').value) || 0;
            
            let filtered = [...allLabResults];
            
            if (search) {
                filtered = filtered.filter(r => r.testName.toLowerCase().includes(search));
            }
            
            if (lab) {
                filtered = filtered.filter(r => r.lab === lab);
            }
            
            if (flag) {
                // Check both the flag field (from lab reports) AND the status field (from custom status dropdown)
                filtered = filtered.filter(r => {
                    const flagMatch = r.flag && r.flag.toLowerCase().includes(flag.toLowerCase());
                    const statusMatch = r.status && r.status.toLowerCase().includes(flag.toLowerCase());
                    return flagMatch || statusMatch;
                });
            }
            
            if (dateRange > 0) {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - dateRange);
                filtered = filtered.filter(r => new Date(r.collected) >= cutoffDate);
            }
            
            const tbody = document.getElementById('allResultsBody');
            renderResultsTable(filtered, tbody);
            
            // Re-apply column visibility after re-rendering
            applyColumnClasses();
        }

        function populateCategoryViews() {
            const categories = {
                metabolic: ['glucose', 'hemoglobin_a1c', 'sodium', 'potassium', 'chloride', 'carbon_dioxide', 'calcium'],
                lipid: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol'],
                thyroid: ['tsh', 't4_free', 't3_free', 't3_total'],
                cbc: ['hemoglobin', 'hematocrit', 'wbc', 'platelets', 'rbc'],
                kidney: ['creatinine', 'bun', 'egfr'],
                liver: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total'],
                vitamins: ['vitamin_d', 'vitamin_b12', 'folate', 'zinc', 'ferritin'],
                inflammation: ['crp', 'sed_rate']
            };

            Object.keys(categories).forEach(cat => {
                const view = document.getElementById(`view-${cat}`);
                const results = allLabResults.filter(r => 
                    categories[cat].includes(r.rawTestName)
                );

                view.innerHTML = `
                    <div class="page-header">
                        <h2>${cat.charAt(0).toUpperCase() + cat.slice(1)} Panel Results</h2>
                        <div class="action-bar">
                            <button class="btn btn-success" onclick="exportCategory('${cat}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Result</th>
                                            <th>Units</th>
                                            <th>Reference Range</th>
                                            <th>Midpoint</th>
                                            <th>Flag</th>
                                            <th>Status</th>
                                            <th>Lab</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map(r => `
                                            <tr>
                                                <td><strong>${r.testName}</strong></td>
                                                <td>${formatDate(r.collected)}</td>
                                                <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                                <td>${r.units}</td>
                                                <td>${r.referenceRange}</td>
                                                <td><strong>${r.midpoint}</strong></td>
                                                <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                                <td>
                                                    <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                                            onchange="changeStatus('${r.id}', this.value)">
                                                        <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                        <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                        <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                        <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                        <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                    </select>
                                                </td>
                                                <td>${r.lab}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function populateOrganSystemViews() {
            const organSystems = {
                circulatory: {
                    name: 'Circulatory System',
                    icon: 'heart-pulse',
                    description: 'Heart, blood vessels, and blood composition',
                    tests: ['hemoglobin', 'hematocrit', 'rbc', 'wbc', 'platelets', 'cholesterol_total', 'hdl_cholesterol', 
                            'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol', 'neutrophils', 'lymphocytes', 
                            'monocytes', 'eosinophils', 'basophils', 'mcv', 'mch', 'mchc', 'rdw']
                },
                endocrine: {
                    name: 'Endocrine System',
                    icon: 'gland',
                    description: 'Hormones and metabolic regulation',
                    tests: ['tsh', 't4_free', 't3_free', 't3_total', 'glucose', 'hemoglobin_a1c']
                },
                digestive: {
                    name: 'Digestive/Liver System',
                    icon: 'stomach',
                    description: 'Liver function and protein metabolism',
                    tests: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total', 'protein_total', 'albumin', 
                            'globulin', 'ag_ratio']
                },
                urinary: {
                    name: 'Urinary/Kidney System',
                    icon: 'kidneys',
                    description: 'Kidney function and electrolyte balance',
                    tests: ['creatinine', 'bun', 'egfr', 'bun_creatinine_ratio', 'sodium', 'potassium', 
                            'chloride', 'carbon_dioxide']
                },
                immune: {
                    name: 'Immune/Lymphatic System',
                    icon: 'shield-virus',
                    description: 'Immune function and infection response',
                    tests: ['wbc', 'lymphocytes', 'neutrophils', 'monocytes', 'eosinophils', 'basophils', 
                            'ebv_early_ag_ab', 'ebv_vca_igg', 'ebv_vca_igm', 'ebv_nuclear_igg', 'crp', 'sed_rate']
                },
                skeletal: {
                    name: 'Skeletal System',
                    icon: 'bone',
                    description: 'Bone health and calcium metabolism',
                    tests: ['calcium', 'vitamin_d', 'alkaline_phosphatase']
                },
                nervous: {
                    name: 'Nervous System',
                    icon: 'brain',
                    description: 'Neurological health and nerve function',
                    tests: ['vitamin_b12', 'folate', 'glucose', 'sodium', 'potassium', 'calcium']
                }
            };

            Object.keys(organSystems).forEach(systemKey => {
                const system = organSystems[systemKey];
                const view = document.getElementById(`view-system-${systemKey}`);
                const results = allLabResults.filter(r => 
                    system.tests.includes(r.rawTestName)
                );

                const highCount = results.filter(r => {
                    const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                    const statusHigh = r.status && r.status.toLowerCase().includes('high');
                    return flagHigh || statusHigh;
                }).length;

                const lowCount = results.filter(r => {
                    const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                    const statusLow = r.status && r.status.toLowerCase().includes('low');
                    return flagLow || statusLow;
                }).length;

                const normalCount = results.length - highCount - lowCount;

                view.innerHTML = `
                    <div class="page-header">
                        <h2><i class="fas fa-${system.icon}"></i> ${system.name}</h2>
                        <div class="action-bar">
                            <button class="btn btn-success" onclick="exportOrganSystem('${systemKey}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div class="card-body">
                            <p style="font-size: 0.95rem; margin-bottom: 15px; opacity: 0.95;">${system.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${results.length}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Total Tests</div>
                                </div>
                                <div style="background: rgba(220, 53, 69, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${highCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">High Results</div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${lowCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Low Results</div>
                                </div>
                                <div style="background: rgba(40, 167, 69, 0.3); padding: 15px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 5px;">${normalCount}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9;">Normal Results</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-flag"></i></th>
                                            <th>Test Name</th>
                                            <th>Date</th>
                                            <th>Result</th>
                                            <th>Units</th>
                                            <th>Reference Range</th>
                                            <th>Midpoint</th>
                                            <th>Flag</th>
                                            <th>Status</th>
                                            <th>Lab</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                            <tr>
                                                <td style="text-align: center;">
                                                    <i class="fas fa-flag" 
                                                       onclick="toggleBookmark('${r.id}')" 
                                                       style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'}; font-size: 1.2em;"></i>
                                                </td>
                                                <td><strong>${r.testName}</strong></td>
                                                <td>${formatDate(r.collected)}</td>
                                                <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                                <td>${r.units}</td>
                                                <td>${r.referenceRange}</td>
                                                <td><strong>${r.midpoint}</strong></td>
                                                <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                                <td>
                                                    <select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" 
                                                            onchange="changeStatus('${r.id}', this.value)">
                                                        <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                        <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                        <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                        <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                        <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                    </select>
                                                </td>
                                                <td>${r.lab}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function exportOrganSystem(systemKey) {
            const systemTests = {
                circulatory: ['hemoglobin', 'hematocrit', 'rbc', 'wbc', 'platelets', 'cholesterol_total', 'hdl_cholesterol', 
                            'ldl_cholesterol', 'triglycerides', 'vldl_cholesterol', 'neutrophils', 'lymphocytes', 
                            'monocytes', 'eosinophils', 'basophils', 'mcv', 'mch', 'mchc', 'rdw'],
                endocrine: ['tsh', 't4_free', 't3_free', 't3_total', 'glucose', 'hemoglobin_a1c'],
                digestive: ['alt', 'ast', 'alkaline_phosphatase', 'bilirubin_total', 'protein_total', 'albumin', 'globulin', 'ag_ratio'],
                urinary: ['creatinine', 'bun', 'egfr', 'bun_creatinine_ratio', 'sodium', 'potassium', 'chloride', 'carbon_dioxide'],
                immune: ['wbc', 'lymphocytes', 'neutrophils', 'monocytes', 'eosinophils', 'basophils', 
                        'ebv_early_ag_ab', 'ebv_vca_igg', 'ebv_vca_igm', 'ebv_nuclear_igg', 'crp', 'sed_rate'],
                skeletal: ['calcium', 'vitamin_d', 'alkaline_phosphatase'],
                nervous: ['vitamin_b12', 'folate', 'glucose', 'sodium', 'potassium', 'calcium']
            };

            const results = allLabResults.filter(r => systemTests[systemKey].includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab', 'Panel', 'Category', 'Physician', 'Reported'];
            
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab, r.panel, r.category, r.physician, r.reported
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${systemKey}_system_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Research Templates
        function populateResearchViews() {
            const researchTemplates = {
                fatigue: {
                    name: 'Fatigue/Energy Investigation',
                    icon: 'battery-quarter',
                    description: 'Tests related to fatigue, low energy, and tiredness',
                    tests: ['ferritin', 'iron', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 
                            'glucose', 'hemoglobin', 'hematocrit', 'magnesium'],
                    color: '#dc3545'
                },
                mood: {
                    name: 'Depression/Mood Investigation',
                    icon: 'cloud-sun',
                    description: 'Tests related to depression and mood disorders',
                    tests: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 't3_free', 
                            'magnesium', 'iron', 'ferritin'],
                    color: '#6c757d'
                },
                anxiety: {
                    name: 'Anxiety/Stress Investigation',
                    icon: 'heart-pulse',
                    description: 'Tests related to anxiety and stress levels',
                    tests: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'glucose', 
                            'calcium', 'potassium'],
                    color: '#ffc107'
                },
                muscle: {
                    name: 'Muscle Weakness Investigation',
                    icon: 'dumbbell',
                    description: 'Tests related to muscle weakness and fatigue',
                    tests: ['vitamin_d', 'calcium', 'magnesium', 'potassium', 'tsh', 't4_free', 
                            'creatinine', 'protein_total'],
                    color: '#fd7e14'
                },
                hairloss: {
                    name: 'Hair Loss Investigation',
                    icon: 'head-side-medical',
                    description: 'Tests related to hair loss and thinning',
                    tests: ['iron', 'ferritin', 'zinc', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 
                            't3_free', 'protein_total', 'albumin'],
                    color: '#20c997'
                },
                heart: {
                    name: 'Heart Health Investigation',
                    icon: 'heart',
                    description: 'Tests related to cardiovascular health',
                    tests: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 
                            'crp', 'glucose', 'hemoglobin_a1c', 'potassium', 'magnesium'],
                    color: '#e83e8c'
                },
                cognitive: {
                    name: 'Cognitive Function Investigation',
                    icon: 'brain',
                    description: 'Tests related to brain function and memory',
                    tests: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 'glucose', 
                            'hemoglobin', 'iron'],
                    color: '#6f42c1'
                },
                bone: {
                    name: 'Bone Health Investigation',
                    icon: 'bone',
                    description: 'Tests related to bone density and health',
                    tests: ['vitamin_d', 'calcium', 'alkaline_phosphatase', 'magnesium', 'protein_total'],
                    color: '#17a2b8'
                },
                inflammation: {
                    name: 'Inflammation Investigation',
                    icon: 'fire-flame-curved',
                    description: 'Tests related to inflammation in the body',
                    tests: ['crp', 'sed_rate', 'wbc', 'neutrophils', 'lymphocytes'],
                    color: '#dc3545'
                },
                sleep: {
                    name: 'Sleep Issues Investigation',
                    icon: 'bed',
                    description: 'Tests related to sleep quality and disorders',
                    tests: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'iron', 
                            'ferritin', 'glucose'],
                    color: '#6610f2'
                }
            };

            Object.keys(researchTemplates).forEach(key => {
                const template = researchTemplates[key];
                const view = document.getElementById(`view-research-${key}`);
                const results = allLabResults.filter(r => template.tests.includes(r.rawTestName));

                const highCount = results.filter(r => {
                    const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                    const statusHigh = r.status && r.status.toLowerCase().includes('high');
                    return flagHigh || statusHigh;
                }).length;

                const lowCount = results.filter(r => {
                    const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                    const statusLow = r.status && r.status.toLowerCase().includes('low');
                    return flagLow || statusLow;
                }).length;

                view.innerHTML = `
                    <div class="page-header">
                        <h2><i class="fas fa-${template.icon}"></i> ${template.name}</h2>
                        <div class="action-bar">
                            <button class="btn btn-outline" onclick="openColumnVisibilityModal()">
                                <i class="fas fa-columns"></i> Columns
                            </button>
                            <button class="btn btn-success" onclick="exportResearchTemplate('${key}')">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-bottom: 20px; background: ${template.color}; color: white;">
                        <div class="card-body">
                            <p style="font-size: 1rem; margin-bottom: 15px; opacity: 0.95;">${template.description}</p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${results.length}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Tests Found</div>
                                </div>
                                <div style="background: rgba(220, 53, 69, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${highCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">High</div>
                                </div>
                                <div style="background: rgba(255, 193, 7, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${lowCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Low</div>
                                </div>
                                <div style="background: rgba(40, 167, 69, 0.4); padding: 12px; border-radius: 6px; text-align: center;">
                                    <div style="font-size: 1.8rem; font-weight: bold;">${results.length - highCount - lowCount}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Normal</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            ${visibleColumns.bookmark !== false ? '<th><i class="fas fa-flag"></i></th>' : ''}
                                            ${visibleColumns.testName !== false ? '<th>Test Name</th>' : ''}
                                            ${visibleColumns.collected !== false ? '<th>Collected</th>' : ''}
                                            ${visibleColumns.result !== false ? '<th>Result</th>' : ''}
                                            ${visibleColumns.units !== false ? '<th>Units</th>' : ''}
                                            ${visibleColumns.referenceRange !== false ? '<th>Reference Range</th>' : ''}
                                            ${visibleColumns.midpoint !== false ? '<th>Midpoint</th>' : ''}
                                            ${visibleColumns.flag !== false ? '<th>Flag</th>' : ''}
                                            ${visibleColumns.status !== false ? '<th>Status</th>' : ''}
                                            ${visibleColumns.lab !== false ? '<th>Lab</th>' : ''}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                            <tr>
                                                ${visibleColumns.bookmark !== false ? `<td style="text-align: center;"><i class="fas fa-flag" onclick="toggleBookmark('${r.id}')" style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'};"></i></td>` : ''}
                                                ${visibleColumns.testName !== false ? `<td><strong>${r.testName}</strong></td>` : ''}
                                                ${visibleColumns.collected !== false ? `<td>${formatDate(r.collected)}</td>` : ''}
                                                ${visibleColumns.result !== false ? `<td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>` : ''}
                                                ${visibleColumns.units !== false ? `<td>${r.units}</td>` : ''}
                                                ${visibleColumns.referenceRange !== false ? `<td>${r.referenceRange}</td>` : ''}
                                                ${visibleColumns.midpoint !== false ? `<td><strong>${r.midpoint}</strong></td>` : ''}
                                                ${visibleColumns.flag !== false ? `<td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>` : ''}
                                                ${visibleColumns.status !== false ? `<td><select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" onchange="changeStatus('${r.id}', this.value)">
                                                    <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                    <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                    <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                    <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                    <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                                </select></td>` : ''}
                                                ${visibleColumns.lab !== false ? `<td>${r.lab}</td>` : ''}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function exportResearchTemplate(templateKey) {
            const templates = {
                fatigue: ['ferritin', 'iron', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'glucose', 'hemoglobin', 'hematocrit', 'magnesium'],
                mood: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'magnesium', 'iron', 'ferritin'],
                anxiety: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'glucose', 'calcium', 'potassium'],
                muscle: ['vitamin_d', 'calcium', 'magnesium', 'potassium', 'tsh', 't4_free', 'creatinine', 'protein_total'],
                hairloss: ['iron', 'ferritin', 'zinc', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 't3_free', 'protein_total', 'albumin'],
                heart: ['cholesterol_total', 'hdl_cholesterol', 'ldl_cholesterol', 'triglycerides', 'crp', 'glucose', 'hemoglobin_a1c', 'potassium', 'magnesium'],
                cognitive: ['vitamin_b12', 'folate', 'vitamin_d', 'tsh', 't4_free', 'glucose', 'hemoglobin', 'iron'],
                bone: ['vitamin_d', 'calcium', 'alkaline_phosphatase', 'magnesium', 'protein_total'],
                inflammation: ['crp', 'sed_rate', 'wbc', 'neutrophils', 'lymphocytes'],
                sleep: ['magnesium', 'vitamin_b12', 'vitamin_d', 'tsh', 't4_free', 'iron', 'ferritin', 'glucose']
            };

            const results = allLabResults.filter(r => templates[templateKey].includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab'];
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${templateKey}_research_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Custom Views Management
        let customViews = [];
        let selectedIcon = 'microscope';
        let editingViewId = null;

        const availableIcons = [
            'microscope', 'heart', 'brain', 'lungs', 'bone', 'eye', 'hand-sparkles',
            'pills', 'syringe', 'stethoscope', 'dna', 'virus', 'bacteria',
            'flask', 'vial', 'notes-medical', 'file-medical', 'hospital'
        ];

        function loadCustomViews() {
            const saved = localStorage.getItem('healthDashboardCustomViews');
            if (saved) {
                try {
                    customViews = JSON.parse(saved);
                } catch (e) {
                    customViews = [];
                }
            }
        }

        function saveCustomViewsToStorage() {
            localStorage.setItem('healthDashboardCustomViews', JSON.stringify(customViews));
        }

        function createCustomView() {
            // Reset form
            document.getElementById('customViewName').value = '';
            document.getElementById('customViewDescription').value = '';
            selectedIcon = 'microscope';
            
            // Populate icon selector
            const iconContainer = document.getElementById('iconSelector');
            iconContainer.innerHTML = availableIcons.map(icon => `
                <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIcon('${icon}')">
                    <i class="fas fa-${icon}"></i>
                </div>
            `).join('');
            
            // Populate tests list
            const uniqueTests = {};
            allLabResults.forEach(r => {
                if (!uniqueTests[r.rawTestName]) {
                    uniqueTests[r.rawTestName] = r.testName;
                }
            });
            
            const testsList = document.getElementById('testsList');
            testsList.innerHTML = Object.entries(uniqueTests)
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([key, name]) => `
                    <div class="test-item">
                        <input type="checkbox" id="test-${key}" value="${key}">
                        <label for="test-${key}">${name}</label>
                    </div>
                `).join('');
            
            document.getElementById('customViewModal').classList.add('active');
        }

        function selectIcon(icon) {
            selectedIcon = icon;
            document.querySelectorAll('#iconSelector .icon-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.icon-option').classList.add('selected');
        }

        function selectIconEdit(icon) {
            selectedIcon = icon;
            document.querySelectorAll('#editIconSelector .icon-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.icon-option').classList.add('selected');
        }

        function closeCustomViewModal() {
            document.getElementById('customViewModal').classList.remove('active');
        }

        function closeCustomViewModalOnClickOutside(event) {
            if (event.target.id === 'customViewModal') {
                closeCustomViewModal();
            }
        }

        function selectAllTests() {
            document.querySelectorAll('#testsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllTests() {
            document.querySelectorAll('#testsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function filterTestsList() {
            const search = document.getElementById('testSearchInput').value.toLowerCase();
            document.querySelectorAll('#testsList .test-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }

        function saveCustomView() {
            const name = document.getElementById('customViewName').value.trim();
            const description = document.getElementById('customViewDescription').value.trim();
            
            if (!name) {
                alert('Please enter a view name');
                return;
            }
            
            const selectedTests = [];
            document.querySelectorAll('#testsList input[type="checkbox"]:checked').forEach(cb => {
                selectedTests.push(cb.value);
            });
            
            if (selectedTests.length === 0) {
                alert('Please select at least one test');
                return;
            }
            
            const newView = {
                id: Date.now(),
                name: name,
                description: description || '',
                icon: selectedIcon,
                tests: selectedTests,
                created: new Date().toISOString()
            };
            
            customViews.push(newView);
            saveCustomViewsToStorage();
            closeCustomViewModal();
            populateCustomViewsList();
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-check-circle"></i> Custom view "${name}" created!`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function populateCustomViewsList() {
            const container = document.getElementById('customViewsList');
            
            if (customViews.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="card-body" style="text-align: center; padding: 3rem; color: #666;">
                            <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p style="font-size: 1.2rem; margin: 0;">No custom views yet</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Click "Create New View" to get started</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = customViews.map(view => `
                <div class="custom-view-card">
                    <div class="custom-view-header">
                        <div class="custom-view-title">
                            <i class="fas fa-${view.icon}" style="color: #1e3c72;"></i>
                            <span>${view.name}</span>
                        </div>
                        <div class="custom-view-actions">
                            <button class="btn btn-sm btn-outline" onclick="viewCustomView(${view.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="editCustomView(${view.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="deleteCustomView(${view.id})" style="color: #dc3545; border-color: #dc3545;">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    ${view.description ? `<p style="color: #666; margin: 8px 0;">${view.description}</p>` : ''}
                    <div class="custom-view-meta">
                        <i class="fas fa-flask"></i> ${view.tests.length} tests • 
                        <i class="fas fa-calendar"></i> Created ${new Date(view.created).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function viewCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            // Create dynamic view
            showView(`custom-${viewId}`);
            renderCustomView(view);
        }

        function renderCustomView(view) {
            let viewElement = document.getElementById(`view-custom-${view.id}`);
            if (!viewElement) {
                // Create the view element dynamically
                viewElement = document.createElement('div');
                viewElement.id = `view-custom-${view.id}`;
                viewElement.className = 'view-content';
                document.querySelector('.content-area').appendChild(viewElement);
            }
            
            const results = allLabResults.filter(r => view.tests.includes(r.rawTestName));
            
            const highCount = results.filter(r => {
                const flagHigh = r.flag && r.flag.toLowerCase().includes('high');
                const statusHigh = r.status && r.status.toLowerCase().includes('high');
                return flagHigh || statusHigh;
            }).length;

            const lowCount = results.filter(r => {
                const flagLow = r.flag && r.flag.toLowerCase().includes('low');
                const statusLow = r.status && r.status.toLowerCase().includes('low');
                return flagLow || statusLow;
            }).length;

            viewElement.innerHTML = `
                <div class="page-header">
                    <h2><i class="fas fa-${view.icon}"></i> ${view.name}</h2>
                    <div class="action-bar">
                        <button class="btn btn-outline" onclick="openColumnVisibilityModal()">
                            <i class="fas fa-columns"></i> Columns
                        </button>
                        <button class="btn btn-outline" onclick="editCustomView(${view.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-success" onclick="exportCustomView(${view.id})">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                ${view.description ? `<div class="card" style="margin-bottom: 20px; background: #6c757d; color: white;">
                    <div class="card-body">
                        <p style="margin: 0; font-size: 1rem;">${view.description}</p>
                    </div>
                </div>` : ''}

                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #1e3c72;">${results.length}</div>
                                <div style="font-size: 0.85rem; color: #666;">Tests</div>
                            </div>
                            <div style="background: #f8d7da; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #dc3545;">${highCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">High</div>
                            </div>
                            <div style="background: #fff3cd; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #ffc107;">${lowCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">Low</div>
                            </div>
                            <div style="background: #d4edda; padding: 12px; border-radius: 6px; text-align: center;">
                                <div style="font-size: 1.8rem; font-weight: bold; color: #28a745;">${results.length - highCount - lowCount}</div>
                                <div style="font-size: 0.85rem; color: #666;">Normal</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-flag"></i></th>
                                        <th>Test Name</th>
                                        <th>Collected</th>
                                        <th>Result</th>
                                        <th>Units</th>
                                        <th>Reference Range</th>
                                        <th>Midpoint</th>
                                        <th>Flag</th>
                                        <th>Status</th>
                                        <th>Lab</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.sort((a, b) => new Date(b.collected) - new Date(a.collected)).map(r => `
                                        <tr>
                                            <td style="text-align: center;"><i class="fas fa-flag" onclick="toggleBookmark('${r.id}')" style="cursor: pointer; color: ${r.bookmarked ? '#ffc107' : '#ddd'};"></i></td>
                                            <td><strong>${r.testName}</strong></td>
                                            <td>${formatDate(r.collected)}</td>
                                            <td class="${r.flag ? (r.flag.toLowerCase().includes('high') ? 'value-high' : 'value-low') : ''}">${r.result}</td>
                                            <td>${r.units}</td>
                                            <td>${r.referenceRange}</td>
                                            <td><strong>${r.midpoint}</strong></td>
                                            <td>${r.flag ? `<span class="result-badge badge-${r.flag.toLowerCase().includes('high') ? 'high' : r.flag.toLowerCase().includes('low') ? 'low' : 'abnormal'}">${r.flag}</span>` : '<span class="result-badge badge-normal">Normal</span>'}</td>
                                            <td><select class="status-dropdown status-${r.status.toLowerCase().replace(/\s+/g, '-')}" onchange="changeStatus('${r.id}', this.value)">
                                                <option value="Low" ${r.status === 'Low' ? 'selected' : ''}>Low</option>
                                                <option value="Slightly Low" ${r.status === 'Slightly Low' ? 'selected' : ''}>Slightly Low</option>
                                                <option value="Middle" ${r.status === 'Middle' ? 'selected' : ''}>Middle</option>
                                                <option value="Slightly High" ${r.status === 'Slightly High' ? 'selected' : ''}>Slightly High</option>
                                                <option value="High" ${r.status === 'High' ? 'selected' : ''}>High</option>
                                            </select></td>
                                            <td>${r.lab}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        function editCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            editingViewId = viewId;
            selectedIcon = view.icon;
            
            document.getElementById('editViewName').value = view.name;
            document.getElementById('editViewDescription').value = view.description;
            
            // Populate icon selector
            const iconContainer = document.getElementById('editIconSelector');
            iconContainer.innerHTML = availableIcons.map(icon => `
                <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}" onclick="selectIconEdit('${icon}')">
                    <i class="fas fa-${icon}"></i>
                </div>
            `).join('');
            
            // Populate tests list
            const uniqueTests = {};
            allLabResults.forEach(r => {
                if (!uniqueTests[r.rawTestName]) {
                    uniqueTests[r.rawTestName] = r.testName;
                }
            });
            
            const testsList = document.getElementById('editTestsList');
            testsList.innerHTML = Object.entries(uniqueTests)
                .sort((a, b) => a[1].localeCompare(b[1]))
                .map(([key, name]) => `
                    <div class="test-item">
                        <input type="checkbox" id="edit-test-${key}" value="${key}" ${view.tests.includes(key) ? 'checked' : ''}>
                        <label for="edit-test-${key}">${name}</label>
                    </div>
                `).join('');
            
            document.getElementById('editCustomViewModal').classList.add('active');
        }

        function closeEditCustomViewModal() {
            document.getElementById('editCustomViewModal').classList.remove('active');
            editingViewId = null;
        }

        function closeEditCustomViewModalOnClickOutside(event) {
            if (event.target.id === 'editCustomViewModal') {
                closeEditCustomViewModal();
            }
        }

        function selectAllTestsEdit() {
            document.querySelectorAll('#editTestsList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function deselectAllTestsEdit() {
            document.querySelectorAll('#editTestsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function filterEditTestsList() {
            const search = document.getElementById('editTestSearchInput').value.toLowerCase();
            document.querySelectorAll('#editTestsList .test-item').forEach(item => {
                const label = item.querySelector('label').textContent.toLowerCase();
                item.style.display = label.includes(search) ? 'flex' : 'none';
            });
        }

        function updateCustomView() {
            const name = document.getElementById('editViewName').value.trim();
            const description = document.getElementById('editViewDescription').value.trim();
            
            if (!name) {
                alert('Please enter a view name');
                return;
            }
            
            const selectedTests = [];
            document.querySelectorAll('#editTestsList input[type="checkbox"]:checked').forEach(cb => {
                selectedTests.push(cb.value);
            });
            
            if (selectedTests.length === 0) {
                alert('Please select at least one test');
                return;
            }
            
            const viewIndex = customViews.findIndex(v => v.id === editingViewId);
            if (viewIndex === -1) return;
            
            customViews[viewIndex] = {
                ...customViews[viewIndex],
                name: name,
                description: description,
                icon: selectedIcon,
                tests: selectedTests
            };
            
            saveCustomViewsToStorage();
            closeEditCustomViewModal();
            populateCustomViewsList();
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #28a745; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-check-circle"></i> View "${name}" updated!`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function deleteCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            if (!confirm(`Are you sure you want to delete "${view.name}"?`)) {
                return;
            }
            
            customViews = customViews.filter(v => v.id !== viewId);
            saveCustomViewsToStorage();
            populateCustomViewsList();
            
            // Remove the view element if it exists
            const viewElement = document.getElementById(`view-custom-${viewId}`);
            if (viewElement) {
                viewElement.remove();
            }
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed; top: 20px; right: 20px; background: #dc3545; color: white;
                padding: 15px 25px; border-radius: 5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                z-index: 10000; font-weight: 500;
            `;
            message.innerHTML = `<i class="fas fa-trash"></i> View "${view.name}" deleted`;
            document.body.appendChild(message);
            setTimeout(() => {
                message.style.transition = 'opacity 0.5s';
                message.style.opacity = '0';
                setTimeout(() => message.remove(), 500);
            }, 3000);
        }

        function exportCustomView(viewId) {
            const view = customViews.find(v => v.id === viewId);
            if (!view) return;
            
            const results = allLabResults.filter(r => view.tests.includes(r.rawTestName));
            
            const headers = ['Test Name', 'Collected', 'Result', 'Units', 'Reference Range', 'Midpoint', 
                           'Flag', 'Status', 'Lab'];
            const rows = results.map(r => [
                r.testName, r.collected, r.result, r.units, r.referenceRange, r.midpoint,
                r.flag, r.status, r.lab
            ]);
            
            const csv = [headers, ...rows].map(row => 
                row.map(cell => `"${cell || ''}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${view.name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function populateMedications() {
            const view = document.getElementById('medicationsContent');
            view.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        ${healthData.medications.map(med => `
                            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                                <h4 style="color: #1e3c72; margin-bottom: 5px;">${med.medication}</h4>
                                <p style="color: #666; margin-bottom: 5px;"><strong>Dosage:</strong> ${med.dosage}</p>
                                <p style="color: #666;"><strong>Status:</strong> <span style="color: #28a745; font-weight: 600;">${med.status}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function populateDiagnoses() {
            const view = document.getElementById('diagnosesContent');
            view.innerHTML = `
                <div class="card">
                    <div class="card-body">
                        ${healthData.diagnoses.map(dx => `
                            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                                <h4 style="color: #1e3c72; margin-bottom: 5px;">${dx.condition}</h4>
                                <p style="color: #666; margin-bottom: 5px;"><strong>ICD Code:</strong> ${dx.icd_code}</p>
                                <p style="color: #666;"><strong>Status:</strong> <span style="color: ${dx.status === 'Active' ? '#dc3545' : '#28a745'}; font-weight: 600;">${dx.status}</span></p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createCharts() {
            const container = document.getElementById('chartsContainer');
            const testNames = ['glucose', 'tsh', 'cholesterol_total', 'vitamin_d', 'creatinine', 'vitamin_b12'];
            
            container.innerHTML = testNames.map(test => `
                <div class="chart-card">
                    <h4>${formatTestName(test)} Trend</h4>
                    <canvas id="chart-${test}"></canvas>
                </div>
            `).join('');

            testNames.forEach(test => {
                const data = healthData.lab_results[test];
                if (!data || data.length === 0) return;

                const sorted = [...data].sort((a, b) => new Date(a.collected || a.date) - new Date(b.collected || b.date));
                
                const ctx = document.getElementById(`chart-${test}`).getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sorted.map(d => formatDate(d.collected || d.date)),
                        datasets: [{
                            label: formatTestName(test),
                            data: sorted.map(d => parseFloat(d.result || d.value)),
                            borderColor: '#1e3c72',
                            backgroundColor: 'rgba(30, 60, 114, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: sorted[0].units || sorted[0].unit || ''
                                }
                            }
                        }
                    }
                });
            });
        }

        function showView(viewName) {
            // Handle custom views
            if (viewName.startsWith('custom-')) {
                const viewId = parseInt(viewName.replace('custom-', ''));
                const view = customViews.find(v => v.id === viewId);
                if (view) {
                    // Hide all views
                    document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
                    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                    
                    renderCustomView(view);
                    document.getElementById(`view-${viewName}`).classList.add('active');
                    return;
                }
            }
            
            // Hide all views
            document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Show selected view
            document.getElementById(`view-${viewName}`).classList.add('active');
            
            // Populate special views if selected
            if (viewName === 'flagged') {
                populateFlaggedTests();
            } else if (viewName === 'my-high') {
                populateMyHighTests();
            } else if (viewName === 'my-low') {
                populateMyLowTests();
            } else if (viewName === 'custom-views') {
                populateCustomViewsList();
            } else if (viewName === 'trends-analysis') {
                populateTrendsAnalysisView();
            }
            
            // Highlight nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                if (item.textContent.toLowerCase().includes(viewName.replace('-', ' '))) {
                    item.classList.add('active');
                }
            });
        }

        function exportAllData() {
            const csv = convertToCSV(allLabResults);
            downloadCSV(csv, 'complete_health_data.csv');
        }

        function exportFilteredData() {
            const tbody = document.getElementById('allResultsBody');
            const rows = tbody.querySelectorAll('tr');
            const filtered = Array.from(rows).map(row => {
                const cells = row.querySelectorAll('td');
                return {
                    testName: cells[0].textContent,
                    collected: cells[1].textContent,
                    result: cells[2].textContent,
                    units: cells[3].textContent,
                    referenceRange: cells[4].textContent,
                    flag: cells[5].textContent,
                    lab: cells[6].textContent,
                    panel: cells[7].textContent,
                    category: cells[8].textContent,
                    physician: cells[9].textContent,
                    reported: cells[10].textContent,
                    source: cells[11].textContent,
                    specimenID: cells[12].textContent,
                    fasting: cells[13].textContent,
                    notes: cells[14].textContent
                };
            });
            
            const csv = convertToCSV(filtered);
            downloadCSV(csv, 'filtered_health_data.csv');
        }

        function exportCategory(category) {
            const results = allLabResults.filter(r => r.category.toLowerCase() === category.toLowerCase());
            const csv = convertToCSV(results);
            downloadCSV(csv, `${category}_panel_data.csv`);
        }

        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${row[h]}"`).join(','))
            ].join('\n');
            return csv;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Test Detail Panel Functions
        const testCategories = {
            'Metabolic': ['glucose', 'calcium', 'sodium', 'potassium', 'chloride', 'carbon_dioxide', 'bun', 'creatinine', 'albumin', 'protein_total', 'alkaline_phosphatase', 'alt', 'ast'],
            'Lipid': ['cholesterol_total', 'hdl', 'ldl', 'triglycerides', 'vldl'],
            'Thyroid': ['tsh', 't4_free', 't3_total', 't4_total'],
            'CBC': ['wbc', 'rbc', 'hemoglobin', 'hematocrit', 'mcv', 'mch', 'mchc', 'rdw', 'platelets', 'mpv', 'nrbcs', 'neutrophils_percent', 'lymphocytes_percent', 'monocytes_percent', 'eosinophils_percent', 'basophils_percent'],
            'Kidney': ['bun', 'creatinine', 'egfr', 'bun_creatinine_ratio'],
            'Liver': ['ast', 'alt', 'alkaline_phosphatase', 'bilirubin_total', 'albumin', 'protein_total'],
            'Vitamins': ['vitamin_d', 'vitamin_b12', 'folate'],
            'Iron': ['iron', 'tibc', 'transferrin', 'iron_saturation', 'ferritin'],
            'Inflammation': ['crp', 'sed_rate'],
            'Hormones': ['testosterone_total']
        };

        let currentDetailChart = null;

        function openTestDetailPanel(testName) {
            const overlay = document.getElementById('testDetailOverlay');
            const panel = document.getElementById('testDetailPanel');
            
            overlay.classList.add('active');
            panel.classList.add('active');
            
            // Populate categories if not already done
            populateTestCategories();
            
            // Load the test chart
            loadTestChart(testName);
        }

        function closeTestDetailPanel() {
            const overlay = document.getElementById('testDetailOverlay');
            const panel = document.getElementById('testDetailPanel');
            
            overlay.classList.remove('active');
            panel.classList.remove('active');
            
            // Destroy chart if exists
            if (currentDetailChart) {
                currentDetailChart.destroy();
                currentDetailChart = null;
            }
        }

        function populateTestCategories() {
            const container = document.getElementById('testCategoriesList');
            
            if (container.children.length > 0) return; // Already populated
            
            container.innerHTML = Object.keys(testCategories).map(category => {
                const tests = testCategories[category];
                const testCount = tests.length;
                
                return `
                    <div class="test-category">
                        <div class="category-header" onclick="toggleCategory('${category}')">
                            <i class="fas fa-chevron-right category-icon" id="icon-${category}"></i>
                            <span class="category-name">${category} Panel</span>
                            <span class="test-count">${testCount}</span>
                        </div>
                        <div class="test-list" id="list-${category}">
                            ${tests.map(test => `
                                <a href="javascript:void(0)" 
                                   class="test-item-link" 
                                   onclick="loadTestChart('${test}')"
                                   id="link-${test}">
                                    ${formatTestName(test)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCategory(category) {
            const icon = document.getElementById(`icon-${category}`);
            const list = document.getElementById(`list-${category}`);
            
            icon.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        function formatTestName(testKey) {
            // Convert test key to readable name
            const nameMap = {
                'glucose': 'Glucose',
                'calcium': 'Calcium',
                'sodium': 'Sodium',
                'potassium': 'Potassium',
                'chloride': 'Chloride',
                'carbon_dioxide': 'Carbon Dioxide',
                'bun': 'BUN',
                'creatinine': 'Creatinine',
                'albumin': 'Albumin',
                'protein_total': 'Total Protein',
                'alkaline_phosphatase': 'Alkaline Phosphatase',
                'alt': 'ALT',
                'ast': 'AST',
                'cholesterol_total': 'Total Cholesterol',
                'hdl': 'HDL Cholesterol',
                'ldl': 'LDL Cholesterol',
                'triglycerides': 'Triglycerides',
                'vldl': 'VLDL',
                'tsh': 'TSH',
                't4_free': 'Free T4',
                't3_total': 'Total T3',
                't4_total': 'Total T4',
                'wbc': 'WBC',
                'rbc': 'RBC',
                'hemoglobin': 'Hemoglobin',
                'hematocrit': 'Hematocrit',
                'mcv': 'MCV',
                'mch': 'MCH',
                'mchc': 'MCHC',
                'rdw': 'RDW',
                'platelets': 'Platelets',
                'mpv': 'MPV',
                'nrbcs': 'nRBCs',
                'neutrophils_percent': 'Neutrophils %',
                'lymphocytes_percent': 'Lymphocytes %',
                'monocytes_percent': 'Monocytes %',
                'eosinophils_percent': 'Eosinophils %',
                'basophils_percent': 'Basophils %',
                'egfr': 'eGFR',
                'bun_creatinine_ratio': 'BUN/Creatinine Ratio',
                'bilirubin_total': 'Total Bilirubin',
                'vitamin_d': 'Vitamin D',
                'vitamin_b12': 'Vitamin B12',
                'folate': 'Folate',
                'iron': 'Iron',
                'tibc': 'TIBC',
                'transferrin': 'Transferrin',
                'iron_saturation': 'Iron Saturation',
                'ferritin': 'Ferritin',
                'crp': 'C-Reactive Protein',
                'sed_rate': 'Sed Rate',
                'testosterone_total': 'Total Testosterone'
            };
            
            return nameMap[testKey] || testKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function loadTestChart(testKey) {
            // Remove active class from all test links
            document.querySelectorAll('.test-item-link').forEach(link => link.classList.remove('active'));
            
            // Add active class to clicked test
            const activeLink = document.getElementById(`link-${testKey}`);
            if (activeLink) activeLink.classList.add('active');
            
            // Get test data from allLabResults
            const testData = allLabResults.filter(r => r.rawTestName === testKey);
            
            if (!testData || testData.length === 0) {
                document.getElementById('testChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No data available for this test</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            const sortedData = [...testData].sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            // Extract data for chart
            const dates = sortedData.map(d => formatDate(d.collected));
            const values = sortedData.map(d => parseFloat(d.result)).filter(v => !isNaN(v));
            
            if (values.length === 0) {
                document.getElementById('testChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No numeric data available for charting</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const firstResult = sortedData.find(d => !isNaN(parseFloat(d.result)));
            const units = firstResult.units || '';
            const refLow = firstResult.refLow;
            const refHigh = firstResult.refHigh;
            const refRange = refLow && refHigh ? `${refLow} - ${refHigh} ${units}` : firstResult.referenceRange;
            
            // Create chart HTML
            document.getElementById('testChartContainer').innerHTML = `
                <div class="chart-container-detail">
                    <div class="chart-header-detail">
                        <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                        <p class="chart-subtitle-detail">Normal range: ${refRange}</p>
                    </div>
                    
                    <div class="chart-canvas-wrapper">
                        <canvas id="detailChart"></canvas>
                    </div>
                    
                    <div class="data-table-toggle">
                        <button class="data-table-btn" onclick="toggleDetailDataTable()">
                            Data table <i class="fas fa-chevron-down" id="tableToggleIcon"></i>
                        </button>
                    </div>
                    
                    <table class="detail-data-table" id="detailDataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Normal Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(d => `
                                <tr data-row-id="${d.id}">
                                    <td>${formatDate(d.collected)}</td>
                                    <td><strong>${d.result} ${d.units || ''}</strong></td>
                                    <td>${d.reference_range}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Create Chart.js chart
            const ctx = document.getElementById('detailChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (currentDetailChart) {
                currentDetailChart.destroy();
            }
            
            // Calculate y-axis range
            const dataMin = Math.min(...values);
            const dataMax = Math.max(...values);
            let yMin, yMax, yMid;
            
            if (refLow && refHigh) {
                yMin = Math.min(dataMin, refLow) * 0.9;
                yMax = Math.max(dataMax, refHigh) * 1.1;
                yMid = (refLow + refHigh) / 2;
            } else {
                yMin = dataMin * 0.9;
                yMax = dataMax * 1.1;
                yMid = (yMin + yMax) / 2;
            }
            
            // Build an array of row ids aligned to the data points
            const pointRowIds = sortedData.map(d => d.id);

            currentDetailChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: formatTestName(testKey),
                        data: values,
                        borderColor: '#007AFF',
                        backgroundColor: '#007AFF',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    onClick: function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const chart = this;
                        const idx = elements[0].index;
                        const rowId = pointRowIds[idx];
                        if (rowId) highlightDataRow(rowId);
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} ${units}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                count: 3
                            },
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function toggleDetailDataTable() {
            const table = document.getElementById('detailDataTable');
            const icon = document.getElementById('tableToggleIcon');
            
            table.classList.toggle('visible');
            icon.classList.toggle('rotated');
        }

        function highlightDataRow(rowId) {
            try {
                const table = document.getElementById('detailDataTable');
                if (!table) return;

                // Remove existing highlights
                document.querySelectorAll('.detail-data-table tr.highlight-row').forEach(r => r.classList.remove('highlight-row'));

                const target = table.querySelector(`tr[data-row-id="${rowId}"]`);
                if (!target) return;

                // Ensure table is visible
                if (!table.classList.contains('visible')) {
                    table.classList.add('visible');
                    const icon = document.getElementById('tableToggleIcon');
                    if (icon) icon.classList.add('rotated');
                }

                // Scroll into view smoothly within the table container
                target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Add highlight class and remove after 3s
                target.classList.add('highlight-row');
                setTimeout(() => {
                    target.classList.remove('highlight-row');
                }, 3000);
            } catch (e) {
                console.warn('highlightDataRow error', e);
            }
        }

        // Trends Analysis View Functions
        function populateTrendsAnalysisView() {
            const container = document.getElementById('trendsAnalysisCategoriesList');
            
            if (container.children.length > 0) return; // Already populated
            
            container.innerHTML = Object.keys(testCategories).map(category => {
                const tests = testCategories[category];
                const testCount = tests.length;
                
                return `
                    <div class="test-category">
                        <div class="category-header" onclick="toggleTrendsCategory('${category}')">
                            <i class="fas fa-chevron-right category-icon" id="trends-icon-${category}"></i>
                            <span class="category-name">${category} Panel</span>
                            <span class="test-count">${testCount}</span>
                        </div>
                        <div class="test-list" id="trends-list-${category}">
                            ${tests.map(test => `
                                <a href="javascript:void(0)" 
                                   class="test-item-link" 
                                   onclick="loadTrendsChart('${test}')"
                                   id="trends-link-${test}">
                                    ${formatTestName(test)}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTrendsCategory(category) {
            const icon = document.getElementById(`trends-icon-${category}`);
            const list = document.getElementById(`trends-list-${category}`);
            
            icon.classList.toggle('expanded');
            list.classList.toggle('expanded');
        }

        function loadTrendsChart(testKey) {
            // Remove active class from all test links
            document.querySelectorAll('#trendsAnalysisCategoriesList .test-item-link').forEach(link => link.classList.remove('active'));
            
            // Add active class to clicked test
            const activeLink = document.getElementById(`trends-link-${testKey}`);
            if (activeLink) activeLink.classList.add('active');
            
            // Get test data from healthData
            const testData = healthData.lab_results[testKey];
            
            if (!testData || testData.length === 0) {
                document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No data available for this test</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort by date
            const sortedData = [...testData].sort((a, b) => new Date(a.collected) - new Date(b.collected));
            
            // Extract data for chart
            const dates = sortedData.map(d => formatDate(d.collected));
            const values = sortedData.map(d => parseFloat(d.result)).filter(v => !isNaN(v));
            
            if (values.length === 0) {
                document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                    <div class="chart-container-detail">
                        <div class="chart-header-detail">
                            <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                            <p class="chart-subtitle-detail">No numeric data available for charting</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            const firstResult = sortedData.find(d => !isNaN(parseFloat(d.result)));
            const units = firstResult.units || '';
            const refLow = firstResult.range_low;
            const refHigh = firstResult.range_high;
            const refRange = refLow && refHigh ? `${refLow} - ${refHigh} ${units}` : firstResult.reference_range;
            
            // Create chart HTML
            document.getElementById('trendsAnalysisChartContainer').innerHTML = `
                <div class="chart-container-detail">
                    <div class="chart-header-detail">
                        <h2 class="chart-title-detail">${formatTestName(testKey)}</h2>
                        <p class="chart-subtitle-detail">Normal range: ${refRange}</p>
                    </div>
                    
                    <div class="chart-canvas-wrapper">
                        <canvas id="trendsAnalysisChart"></canvas>
                    </div>
                    
                    <div class="data-table-toggle">
                        <button class="data-table-btn" onclick="toggleTrendsDataTable()">
                            Data table <i class="fas fa-chevron-down" id="trendsTableToggleIcon"></i>
                        </button>
                    </div>
                    
                    <table class="detail-data-table" id="trendsDataTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Value</th>
                                <th>Normal Range</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedData.map(d => `
                                <tr data-row-id="${d.id}">
                                    <td>${formatDate(d.collected)}</td>
                                    <td><strong>${d.result} ${d.units || ''}</strong></td>
                                    <td>${d.reference_range}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Create Chart.js chart
            const ctx = document.getElementById('trendsAnalysisChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (window.trendsAnalysisChartInstance) {
                window.trendsAnalysisChartInstance.destroy();
            }
            
            // Calculate y-axis range
            const dataMin = Math.min(...values);
            const dataMax = Math.max(...values);
            let yMin, yMax, yMid;
            
            if (refLow && refHigh) {
                yMin = Math.min(dataMin, refLow) * 0.9;
                yMax = Math.max(dataMax, refHigh) * 1.1;
                yMid = (refLow + refHigh) / 2;
            } else {
                yMin = dataMin * 0.9;
                yMax = dataMax * 1.1;
                yMid = (yMin + yMax) / 2;
            }
            
            const trendsPointRowIds = sortedData.map(d => d.id);

            window.trendsAnalysisChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: formatTestName(testKey),
                        data: values,
                        borderColor: '#007AFF',
                        backgroundColor: '#007AFF',
                        borderWidth: 3,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHitRadius: 10,
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    onClick: function(evt, elements) {
                        if (!elements || !elements.length) return;
                        const idx = elements[0].index;
                        const rowId = trendsPointRowIds[idx];
                        if (rowId) highlightDataRow(rowId);
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y} ${units}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: yMin,
                            max: yMax,
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                },
                                count: 3
                            },
                            grid: {
                                color: '#e0e0e0',
                                drawBorder: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function toggleTrendsDataTable() {
            const table = document.getElementById('trendsDataTable');
            const icon = document.getElementById('trendsTableToggleIcon');
            
            table.classList.toggle('visible');
            icon.classList.toggle('rotated');
        }

        // Initialize on load
        window.onload = loadData;
    </script>

    <!-- Column Visibility Modal -->
    <div id="columnModal" class="modal-overlay" onclick="closeColumnModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3><i class="fas fa-columns"></i> Column Visibility</h3>
                <button class="modal-close" onclick="closeColumnVisibilityModal()">&times;</button>
            </div>
            <p style="color: #666; margin-bottom: 20px;">Select which columns to display in the table</p>
            <div class="column-checkboxes" id="columnCheckboxes"></div>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="selectAllColumns()">Select All</button>
                <button class="btn btn-outline" onclick="deselectAllColumns()">Deselect All</button>
                <button class="btn btn-primary" onclick="applyColumnVisibility()">Apply</button>
            </div>
        </div>
    </div>

    <!-- Custom View Builder Modal -->
    <div id="customViewModal" class="modal-overlay" onclick="closeCustomViewModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> Create Custom Research View</h3>
                <button class="modal-close" onclick="closeCustomViewModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">View Name</label>
                <input type="text" id="customViewName" placeholder="e.g., My Monthly Checkup" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description (Optional)</label>
                <input type="text" id="customViewDescription" placeholder="What is this view for?" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Icon</label>
                <div id="iconSelector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                    <!-- Icons will be populated here -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label style="font-weight: 600; color: #333;">Select Tests to Include</label>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="selectAllTests()" style="padding: 5px 12px; font-size: 0.85rem;">Select All</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllTests()" style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">Deselect All</button>
                    </div>
                </div>
                <input type="text" id="testSearchInput" placeholder="Search tests..." 
                       onkeyup="filterTestsList()" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; margin-bottom: 12px;">
                <div id="testsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                    <!-- Tests will be populated here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeCustomViewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveCustomView()">
                    <i class="fas fa-save"></i> Save Custom View
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Custom View Modal -->
    <div id="editCustomViewModal" class="modal-overlay" onclick="closeEditCustomViewModalOnClickOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Edit Custom View</h3>
                <button class="modal-close" onclick="closeEditCustomViewModal()">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">View Name</label>
                <input type="text" id="editViewName" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description (Optional)</label>
                <input type="text" id="editViewDescription" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Icon</label>
                <div id="editIconSelector" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px;">
                    <!-- Icons will be populated here -->
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label style="font-weight: 600; color: #333;">Select Tests to Include</label>
                    <div>
                        <button class="btn btn-sm btn-outline" onclick="selectAllTestsEdit()" style="padding: 5px 12px; font-size: 0.85rem;">Select All</button>
                        <button class="btn btn-sm btn-outline" onclick="deselectAllTestsEdit()" style="padding: 5px 12px; font-size: 0.85rem; margin-left: 5px;">Deselect All</button>
                    </div>
                </div>
                <input type="text" id="editTestSearchInput" placeholder="Search tests..." 
                       onkeyup="filterEditTestsList()" 
                       style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; margin-bottom: 12px;">
                <div id="editTestsList" style="max-height: 300px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 6px; padding: 15px;">
                    <!-- Tests will be populated here -->
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeEditCustomViewModal()">Cancel</button>
                <button class="btn btn-primary" onclick="updateCustomView()">
                    <i class="fas fa-save"></i> Update View
                </button>
            </div>
        </div>
    </div>

    <!-- Test Detail Slide-in Panel -->
    <div class="test-detail-overlay" id="testDetailOverlay" onclick="closeTestDetailPanel()"></div>
    <div class="test-detail-panel" id="testDetailPanel">
        <button class="panel-close-btn" onclick="closeTestDetailPanel()">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="test-detail-sidebar">
            <div class="sidebar-title">
                <i class="fas fa-flask"></i> Lab Tests
            </div>
            <div id="testCategoriesList"></div>
        </div>
        
        <div class="test-detail-content">
            <div id="testChartContainer"></div>
        </div>
    </div>
</body>
</html>
